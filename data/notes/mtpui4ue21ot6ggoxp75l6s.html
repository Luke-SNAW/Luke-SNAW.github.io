<h1 id="mysql-explain-analyze">MySQL EXPLAIN ANALYZE<a aria-hidden="true" class="anchor-heading icon-link" href="#mysql-explain-analyze"></a></h1>
<blockquote>
<p><a href="https://dev.mysql.com/blog-archive/mysql-explain-analyze/">https://dev.mysql.com/blog-archive/mysql-explain-analyze/</a></p>
</blockquote>
<p><a href="https://dev.mysql.com/blog-archive/the-mysql-8-0-18-maintenance-release-is-generally-available/">MySQL 8.0.18 was just released</a>, and it contains a brand new feature to analyze and understand how queries are executed: EXPLAIN ANALYZE.</p>
<h2 id="what-is-it">What is it?<a aria-hidden="true" class="anchor-heading icon-link" href="#what-is-it"></a></h2>
<p>EXPLAIN ANALYZE is a profiling tool for your queries that will show you where MySQL spends time on your query and why. It will plan the query, instrument it and execute it while counting rows and measuring time spent at various points in the execution plan. When execution finishes, EXPLAIN ANALYZE will print the plan and the measurements instead of the query result.</p>
<p>This new feature is built on top of the regular EXPLAIN query plan inspection tool, and can be seen as an extension of the EXPLAIN FORMAT=TREE that was added earlier in MySQL 8.0. In addition to the query plan and estimated costs, which a normal EXPLAIN will print, EXPLAIN ANALYZE also prints the actual costs of individual iterators in the execution plan.</p>
<h2 id="how-do-i-use-it">How do I use it?<a aria-hidden="true" class="anchor-heading icon-link" href="#how-do-i-use-it"></a></h2>
<p>An EXPLAIN FORMAT=TREE will show us the query plan and cost estimates:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> FORMAT<span class="token operator">=</span>TREE
<span class="token keyword">SELECT</span> first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">AS</span> total
<span class="token keyword">FROM</span> staff <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> payment
  <span class="token keyword">ON</span> staff<span class="token punctuation">.</span>staff_id <span class="token operator">=</span> payment<span class="token punctuation">.</span>staff_id
     <span class="token operator">AND</span>
     payment_date <span class="token operator">LIKE</span> <span class="token string">'2005-08%'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">;</span>

<span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">Table</span> scan <span class="token keyword">on</span> <span class="token operator">&#x3C;</span><span class="token keyword">temporary</span><span class="token operator">></span>
  <span class="token operator">-</span><span class="token operator">></span> Aggregate <span class="token keyword">using</span> <span class="token keyword">temporary</span> <span class="token keyword">table</span>
    <span class="token operator">-</span><span class="token operator">></span> Nested <span class="token keyword">loop</span> <span class="token keyword">inner</span> <span class="token keyword">join</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">1757.30</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">1787</span><span class="token punctuation">)</span>
      <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">Table</span> scan <span class="token keyword">on</span> staff  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">3.20</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
      <span class="token operator">-</span><span class="token operator">></span> Filter: <span class="token punctuation">(</span>payment<span class="token punctuation">.</span>payment_date <span class="token operator">like</span> <span class="token string">'2005-08%'</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">117.43</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">894</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">Index</span> lookup <span class="token keyword">on</span> payment <span class="token keyword">using</span> idx_fk_staff_id <span class="token punctuation">(</span>staff_id<span class="token operator">=</span>staff<span class="token punctuation">.</span>staff_id<span class="token punctuation">)</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">117.43</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">8043</span><span class="token punctuation">)</span>
</code></pre>
<p>But it doesnâ€™t tell us if those estimates are correct, or on which operations in the query plan the time is actually spent. EXPLAIN ANALYZE will do that:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">EXPLAIN</span> <span class="token keyword">ANALYZE</span>
<span class="token keyword">SELECT</span> first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">AS</span> total
<span class="token keyword">FROM</span> staff <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> payment
  <span class="token keyword">ON</span> staff<span class="token punctuation">.</span>staff_id <span class="token operator">=</span> payment<span class="token punctuation">.</span>staff_id
     <span class="token operator">AND</span>
     payment_date <span class="token operator">LIKE</span> <span class="token string">'2005-08%'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">;</span>

<span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">Table</span> scan <span class="token keyword">on</span> <span class="token operator">&#x3C;</span><span class="token keyword">temporary</span><span class="token operator">></span>  <span class="token punctuation">(</span>actual <span class="token keyword">time</span><span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">.</span><span class="token number">.0</span><span class="token number">.001</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">2</span> loops<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token operator">-</span><span class="token operator">></span> Aggregate <span class="token keyword">using</span> <span class="token keyword">temporary</span> <span class="token keyword">table</span>  <span class="token punctuation">(</span>actual <span class="token keyword">time</span><span class="token operator">=</span><span class="token number">58.104</span><span class="token punctuation">.</span><span class="token number">.58</span><span class="token number">.104</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">2</span> loops<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token operator">-</span><span class="token operator">></span> Nested <span class="token keyword">loop</span> <span class="token keyword">inner</span> <span class="token keyword">join</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">1757.30</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">1787</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>actual <span class="token keyword">time</span><span class="token operator">=</span><span class="token number">0.816</span><span class="token punctuation">.</span><span class="token number">.46</span><span class="token number">.135</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">5687</span> loops<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">Table</span> scan <span class="token keyword">on</span> staff  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">3.20</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>actual <span class="token keyword">time</span><span class="token operator">=</span><span class="token number">0.047</span><span class="token punctuation">.</span><span class="token number">.0</span><span class="token number">.051</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">2</span> loops<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token operator">-</span><span class="token operator">></span> Filter: <span class="token punctuation">(</span>payment<span class="token punctuation">.</span>payment_date <span class="token operator">like</span> <span class="token string">'2005-08%'</span><span class="token punctuation">)</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">117.43</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">894</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>actual <span class="token keyword">time</span><span class="token operator">=</span><span class="token number">0.464</span><span class="token punctuation">.</span><span class="token number">.22</span><span class="token number">.767</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">2844</span> loops<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">Index</span> lookup <span class="token keyword">on</span> payment <span class="token keyword">using</span> idx_fk_staff_id <span class="token punctuation">(</span>staff_id<span class="token operator">=</span>staff<span class="token punctuation">.</span>staff_id<span class="token punctuation">)</span>  <span class="token punctuation">(</span>cost<span class="token operator">=</span><span class="token number">117.43</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">8043</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>actual <span class="token keyword">time</span><span class="token operator">=</span><span class="token number">0.450</span><span class="token punctuation">.</span><span class="token number">.19</span><span class="token number">.988</span> <span class="token keyword">rows</span><span class="token operator">=</span><span class="token number">8024</span> loops<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre>
<p>There are several new measurements here:</p>
<ul>
<li>Actual time to get first row (in milliseconds)</li>
<li>Actual time to get all rows (in milliseconds)</li>
<li>Actual number of rows read</li>
<li>Actual number of loops</li>
</ul>
<p>Another tool in the MySQL query analysis toolbox:</p>
<ul>
<li>To examine the query plan: EXPLAIN FORMAT=TREE</li>
<li>To profile the query execution: EXPLAIN ANALYZE</li>
<li>To understand plan choices: <a href="https://dev.mysql.com/doc/internals/en/optimizer-tracing.html">Optimizer trace</a></li>
</ul>