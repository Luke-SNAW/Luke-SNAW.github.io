<h1 id="solve-the-first-click">Solve The First Click<a aria-hidden="true" class="anchor-heading icon-link" href="#solve-the-first-click"></a></h1>
<p><a href="https://glebbahmutov.com/blog/solve-the-first-click/">https://glebbahmutov.com/blog/solve-the-first-click/</a></p>
<h1 id="recording"><a href="https://glebbahmutov.com/blog/solve-the-first-click/#recording">Recording</a><a aria-hidden="true" class="anchor-heading icon-link" href="#recording"></a></h1>
<p>To record the test results and error screenshots on the Cypress Dashboard, I could have set the shown Cypress record key as an environment variable <code>CYPRESS_RECORD_KEY</code>. Since I am using GitHub Actions, I need to set the key as a secret.</p>
<pre class="language-yml"><code class="language-yml"><span class="token key atrule">name</span><span class="token punctuation">:</span> ci
<span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>push<span class="token punctuation">]</span>
<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">test</span><span class="token punctuation">:</span>
    <span class="token comment"># use the reusable workflow to check out the code, install dependencies</span>
    <span class="token comment"># and run the Cypress tests</span>
    <span class="token comment"># https://github.com/bahmutov/cypress-workflows</span>
    <span class="token key atrule">uses</span><span class="token punctuation">:</span> bahmutov/cypress<span class="token punctuation">-</span>workflows/.github/workflows/standard.yml@v1
    <span class="token key atrule">with</span><span class="token punctuation">:</span>
      <span class="token key atrule">start</span><span class="token punctuation">:</span> <span class="token string">"npm run dev"</span>
      <span class="token key atrule">wait-on</span><span class="token punctuation">:</span> <span class="token string">"http://localhost:3000"</span>
      <span class="token key atrule">wait-on-timeout</span><span class="token punctuation">:</span> <span class="token number">60</span>
      <span class="token key atrule">record</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># to record</span>
    <span class="token key atrule">secrets</span><span class="token punctuation">:</span> <span class="token comment"># to record</span>
      <span class="token key atrule">recordKey</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.CYPRESS_RECORD_KEY <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre>
<h1 id="the-solution"><a href="https://glebbahmutov.com/blog/solve-the-first-click/#the-solution">The solution</a><a aria-hidden="true" class="anchor-heading icon-link" href="#the-solution"></a></h1>
<p>There are no observable attributes on the page I could find that would let me know when the application has finished attaching its event listeners. Thus I need to ask the button itself "do you have click event listener?" as described in <a href="https://glebbahmutov.com/blog/when-can-the-test-click/" title="When Can The Test Click">When Can The Test Click</a> blog post. I installed the <a href="https://github.com/bahmutov/cypress-cdp">cypress-cdp</a> plugin and added a command to the test file <a href="https://github.com/bahmutov/my-svelte-app/blob/main/cypress/integration/spec.js">cypress/integration/spec.js</a>.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token string">"cypress-cdp"</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"counts"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  cy<span class="token punctuation">.</span><span class="token method function property-access">visit</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cy<span class="token punctuation">.</span><span class="token method function property-access">contains</span><span class="token punctuation">(</span><span class="token string">"[data-cy=count]"</span><span class="token punctuation">,</span> <span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> incrementSelector <span class="token operator">=</span> <span class="token string">'[aria-label="Increase the counter by one"]'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> decrementSelector <span class="token operator">=</span> <span class="token string">'[aria-label="Decrease the counter by one"]'</span><span class="token punctuation">;</span>
  cy<span class="token punctuation">.</span><span class="token method function property-access">hasEventListeners</span><span class="token punctuation">(</span>incrementSelector<span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">"click"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cy<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span>incrementSelector<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cy<span class="token punctuation">.</span><span class="token method function property-access">contains</span><span class="token punctuation">(</span><span class="token string">"[data-cy=count]"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cy<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span>incrementSelector<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cy<span class="token punctuation">.</span><span class="token method function property-access">contains</span><span class="token punctuation">(</span><span class="token string">"[data-cy=count]"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cy<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span>decrementSelector<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cy<span class="token punctuation">.</span><span class="token method function property-access">contains</span><span class="token punctuation">(</span><span class="token string">"[data-cy=count]"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>