<h1 id="transducers-efficient-data-processing-pipelines-in-javascript">Transducers: Efficient Data Processing Pipelines in JavaScript<a aria-hidden="true" class="anchor-heading icon-link" href="#transducers-efficient-data-processing-pipelines-in-javascript"></a></h1>
<blockquote>
<p><a href="https://medium.com/javascript-scene/transducers-efficient-data-processing-pipelines-in-javascript-7985330fe73d">https://medium.com/javascript-scene/transducers-efficient-data-processing-pipelines-in-javascript-7985330fe73d</a></p>
</blockquote>
<p>Prior to taking on transducers, you should first have a strong understanding of both <a href="https://medium.com/javascript-scene/composing-software-an-introduction-27b72500d6ea"><strong>function composition</strong></a> and <a href="https://medium.com/javascript-scene/reduce-composing-software-fe22f0c39a1d"><strong>reducers</strong></a><strong>.</strong></p>
<blockquote>
<p>Transduce: Derived from the 17th century scientific latin, “transductionem” means “to change over, convert”. It is further derived from “transducere/traducere”, which means “to lead along or across, transfer”.</p>
</blockquote>
<p><strong>A transducer is a composable higher-order reducer. It takes a reducer as input, and returns another reducer.</strong></p>
<p>Transducers are:</p>
<ul>
<li>Composable using simple function composition</li>
<li>Efficient for large collections with multiple operations: Only enumerates over the collection once, regardless of the number of operations in the pipeline</li>
<li>Able to transduce over any enumerable source (e.g., arrays, trees, streams, graphs, etc…)</li>
<li>Usable for either lazy or eager evaluation with no changes to the transducer pipeline</li>
</ul>
<p>Reducers <em>fold</em> multiple inputs into single outputs, where “fold” can be replaced with virtually any binary operation that produces a single output, such as:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Sums: (1, 2) = 3</span>
<span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> a <span class="token operator">+</span> c <span class="token comment">// Products: (2, 4) = 8</span>
<span class="token keyword">const</span> <span class="token function-variable function">multiply</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> a <span class="token operator">*</span> c <span class="token comment">// String concatenation: ('abc', '123') = 'abc123'</span>
<span class="token keyword">const</span> <span class="token function-variable function">concatString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> a <span class="token operator">+</span> c <span class="token comment">// Array concatenation: ([1,2], [3,4]) = [1, 2, 3, 4]</span>
<span class="token keyword">const</span> <span class="token function-variable function">concatArray</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">[</span><span class="token spread operator">...</span>a<span class="token punctuation">,</span> <span class="token spread operator">...</span>c<span class="token punctuation">]</span>
</code></pre>
<p>Transducers do much the same thing, but unlike ordinary reducers, transducers are composable using normal function composition. In other words, you can combine any number of transducers to form a new transducer which links each component transducer together in series.</p>
<p>Normal reducers can’t compose, because they expect two arguments, and only return a single output value, so you can’t simply connect the output to the input of the next reducer in the series. The types don’t line up:</p>
<pre><code>f: (a, c) => a
g:          (a, c) => a
h: ???
</code></pre>
<p>Transducers have a different signature:</p>
<pre><code>f: reducer => reducer
g:            reducer => reducer
h: reducer    =>         reducer
</code></pre>
<h1 id="why-transducers">Why Transducers?<a aria-hidden="true" class="anchor-heading icon-link" href="#why-transducers"></a></h1>
<p>Often, when we process data, it’s useful to break up the processing into multiple independent, composable stages. For example, it’s very common to select some data from a larger set, and then process that data. You may be tempted to do something like this:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> friends <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Sting"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Radiohead"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"NIN"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Echo"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Zeppelin"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token keyword">const</span> <span class="token function-variable function">isNearMe</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> nearMe <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> nearMe
<span class="token keyword">const</span> <span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> name
<span class="token keyword">const</span> results <span class="token operator">=</span> friends<span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span>isNearMe<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span>getName<span class="token punctuation">)</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>
<span class="token comment">// => ["Sting", "Radiohead", "Echo"]</span>
</code></pre>
<p>This is fine for small lists like this, but there are some potential problems:</p>
<ol>
<li>This only works for arrays. What about potentially infinite streams of data coming in from a network subscription, or a social graph with friends-of-friends?</li>
<li>Each time you use the dot chaining syntax on an array, JavaScript builds up a whole new intermediate array before moving onto the next operation in the chain. If you have a list of 2,000,000 “friends” to wade through, that could slow things down by an order of magnitude or two. With transducers, you can stream each friend through the complete pipeline without building up intermediate collections between them, saving lots of time and memory churn.</li>
<li>With dot chaining, you have to build different implementations of standard operations, like <code>.filter()</code>, <code>.map()</code>, <code>.reduce()</code>, <code>.concat()</code>, and so on. The array methods are built into JavaScript, but what if you want to build a custom data type and support a bunch of standard operations without writing them all from scratch? Transducers can potentially work with any transport data type: Write an operator once, use it anywhere that supports transducers.</li>
</ol>
<p>Let’s see what this would look like with transducers. This code won’t work yet, but follow along, and you’ll be able to build every piece of this transducer pipeline yourself:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> friends <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Sting"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Radiohead"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"NIN"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Echo"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Zeppelin"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token keyword">const</span> <span class="token function-variable function">isNearMe</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> nearMe <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> nearMe
<span class="token keyword">const</span> <span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> name
<span class="token keyword">const</span> getFriendsNearMe <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span>isNearMe<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>getName<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> results2 <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>getFriendsNearMe<span class="token punctuation">,</span> friends<span class="token punctuation">)</span>
</code></pre>
<p>Transducers don’t do anything until you tell them to start and feed them some data to process, which is why we need <code>toArray()</code>. It supplies the transducible process and tells the transducer to transduce the results into a new array. You could tell it to transduce to a stream, or an observable, or anything you like, instead of calling <code>toArray()</code>.</p>
<p>A transducer could map numbers to strings, or objects to arrays, or arrays to smaller arrays, or not change anything at all, mapping <code>{ x, y, z } -> { x, y, z }</code>. Transducers may also filter parts of the signal out of the stream <code>{ x, y, z } -> { x, y }</code>, or even generate new values to insert into the output stream, <code>{ x, y, z } -> { x, xx, y, yy, z, zz }</code>.</p>
<p>I will use the words “signal” and “stream” somewhat interchangeably in this section. Keep in mind when I say “stream”, I’m not referring to any specific data type: simply a sequence of zero or more values, or <em>a list of values expressed over time.</em></p>
<h1 id="background-and-etymology">Background and Etymology<a aria-hidden="true" class="anchor-heading icon-link" href="#background-and-etymology"></a></h1>
<p>In hardware signal processing systems, a transducer is a device which converts one form of energy to another, e.g., audio waves to electrical, as in a microphone transducer. In other words, it transforms one kind of signal into another kind of signal. Likewise, a transducer in code converts from one signal to another signal.</p>
<p>Use of the word “transducers” and the general concept of composable pipelines of data transformations in software date back at least to the 1960s, but our ideas about how they should work have changed from one language and context to the next. Many software engineers in the early days of computer science were also electrical engineers. The general study of computer science in those days often dealt both with hardware and software design. Hence, thinking of computational processes as “transducers” was not particularly novel. It’s possible to encounter the term in early computer science literature — particularly in the context of Digital Signal Processing (DSP) and <strong>data flow programming.</strong></p>
<p>In the 1960s, groundbreaking work was happening in graphical computing in MIT’s Lincoln Laboratory using the TX-2 computer system, a precursor to the US Air Force SAGE defense system. Ivan Sutherland’s famous <a href="https://dspace.mit.edu/handle/1721.1/14979">Sketchpad</a>, developed in 1961–1962, was an early example of object prototype delegation and graphical programming using a light pen.</p>
<p>Ivan’s brother, William Robert “Bert” Sutherland was one of several pioneers in data flow programming. He built a data flow programming environment on top of Sketchpad, which described software “procedures” as directed graphs of operator nodes with outputs linked to the inputs of other nodes. He wrote about the experience in his 1966 paper, <a href="https://dspace.mit.edu/handle/1721.1/13474">“The On-Line Graphical Specification of Computer Procedures”</a>. Instead of arrays and array processing, everything is represented as a stream of values in a continuously running, interactive program loop. Each value is processed by each node as it arrives at the parameter input. You can find similar systems today in <a href="https://docs.unrealengine.com/en-us/Engine/Blueprints">Unreal Engine’s Blueprints Visual Scripting Environment</a> or <a href="https://www.native-instruments.com/en/products/komplete/synths/reaktor-6/">Native Instruments’ Reaktor</a>, a visual programming environment used by musicians to build custom audio synthesizers.</p>
<p><img src="https://miro.medium.com/max/700/1*nAe0WLXecnMGNalPclnFfw.png"></p>
<p>Composed graph of operators from Bert Sutherland’s paper</p>
<p>As far as I’m aware, the first book to popularize the term “transducer” in the context of general purpose software-based stream processing was the 1985 MIT text book for a computer science course called <a href="https://www.amazon.com/Structure-Interpretation-Computer-Programs-Engineering/dp/0262510871/ref=as_li_ss_tl?ie=UTF8&#x26;qid=1507159222&#x26;sr=8-1&#x26;keywords=sicp&#x26;linkCode=ll1&#x26;tag=eejs-20&#x26;linkId=44b40411506b45f32abf1b70b44574d2">“Structure and Interpretation of Computer Programs”</a> (SICP) by Harold Abelson and Gerald Jay Sussman, with Julie Sussman. However, the use of the term “transducer” in the context of digital signal processing predates SICP.</p>
<blockquote>
<p><strong>Note:</strong> SICP is still an excellent introduction to computer science coming from a functional programming perspective. It remains my favorite book on the topic.</p>
</blockquote>
<p>More recently, transducers have been independently rediscovered and a <em>different protocol</em> developed for Clojure by <strong>Rich Hickey</strong> (circa 2014), who is famous for carefully selecting words for concepts based on etymology. In this case, I’d say he nailed it, because Clojure transducers fill almost exactly the same niche as transducers in SICP, and they share many common characteristics. However, they are <em>not strictly the same thing.</em></p>
<p>Transducers as a general concept (not specifically Hickey’s protocol specification) have had considerable impact on important branches of computer science including data flow programming, signal processing for scientific and media applications, networking, artificial intelligence, etc. As we develop better tools and techniques to express transducers in our application code, they are beginning to help us make better sense of every kind of software composition, including user interface behaviors in web and mobile apps, and in the future, could also serve us well to help manage the complexity of augmented reality, autonomous devices and vehicles, etc.</p>
<p>For the purpose of this discussion, when I say “transducer”, I’m not referring to SICP transducers, though it may sound like I’m describing them if you’re already familiar with transducers from SICP. I’m also not referring <em>specifically</em> to Clojure’s transducers, or the transducer protocol that has become a de facto standard in JavaScript (supported by Ramda, Transducers-JS, RxJS, etc…). I’m referring to the <em>general concept of a higher-order reducer —</em> a transformation of a transformation.</p>
<p>In my view, the particular details of the transducer protocols matter a whole lot less than the general principles and underlying mathematical properties of transducers, however, if you want to use transducers in production, my current recommendation is to use an existing library which implements the transducers protocol for interoperability reasons.</p>
<p>The transducers that I will describe here should be considered pseudo-code to express the concepts. They are <em>not compatible with the transducer protocol</em>, and <em>should not be used in production.</em> If you want to learn how to use a particular library’s transducers, refer to the library documentation. I’m writing them this way to lift up the hood and let you see how they work without forcing you to learn the protocol at the same time.</p>
<p>When we’re done, you should have a better understanding of transducers in general, and how you might apply them in any context, with any library, in any language that supports closures and higher-order functions.</p>
<h1 id="a-musical-analogy-for-transducers">A Musical Analogy for Transducers<a aria-hidden="true" class="anchor-heading icon-link" href="#a-musical-analogy-for-transducers"></a></h1>
<p>If you’re among the large number of software developers who are also musicians, a music analogy may be useful: You can think of transducers like signal processing gear (e.g., guitar distortion pedals, EQ, volume knobs, echo, reverb, and audio mixers).</p>
<p>To record a song using musical instruments, we need some sort of physical transducer (i.e., a microphone) to convert the sound waves in the air into electricity on the wire. Then we need to route that wire to whatever signal processing units we’d like to use. For example, adding distortion to an electric guitar, or reverb to a voice track. Eventually this collection of different sounds must be aggregated together and mixed to form a single signal (or collection of channels) representing the final recording.</p>
<p>In other words, the signal flow might look something like this. Imagine the arrows are wires between transducers:</p>
<pre><code>[ Source ] -> [ Mic ] -> [ Filter ] -> [ Mixer ] -> [ Recording ]
</code></pre>
<p>In more general terms, you could express it like this:</p>
<pre><code>[ Enumerator ]->[ Transducer ]->[ Transducer ]->[ Accumulator ]
</code></pre>
<p>If you’ve ever used music production software, this might remind you of a chain of audio effects. That’s a good intuition to have when you’re thinking about transducers, but they can be applied much more generally to numbers, objects, animation frames, 3d models, or anything else you can represent in software.</p>
<p><img src="https://miro.medium.com/max/700/1*UBYaMsshNvLIn4mIHIlw-g.png"></p>
<p>Screenshot: Renoise audio effects channel</p>
<p>You may be experienced with something that behaves a little bit like a transducer if you’ve ever used the map method on arrays. For example, to double a series of numbers:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">double</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> x <span class="token operator">*</span> <span class="token number">2</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span>double<span class="token punctuation">)</span>
</code></pre>
<p>In this example, the array is an enumerable object. The map method enumerates over the original array, and passes its elements through the processing stage, <code>double</code>, which multiplies each element by 2, then accumulates the results into a new array.</p>
<p>You can even compose effects like this:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">double</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> x <span class="token operator">*</span> <span class="token number">2</span>
<span class="token keyword">const</span> <span class="token function-variable function">isEven</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span>isEven<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span>double<span class="token punctuation">)</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token comment">// [4, 8, 12]</span>
</code></pre>
<p>But what if you want to filter and double a potentially infinite stream of numbers, such as a drone’s telemetry data?</p>
<p>Arrays can’t be infinite, and each stage in the array processing requires you to process the entire array before a single value can flow through the next stage in the pipeline. That same limitation means that composition using array methods will have degraded performance because a new array will need to be created and a new collection iterated over for each stage in the composition.</p>
<p>Imagine you have two sections of tubing, each of which represents a transformation to be applied to the data stream, and a string representing the stream. The first transformation represents the <code>isEven</code> filter, and the next represents the <code>double</code> map. In order to produce a single fully transformed value from an array, you'd have to run the entire string through the first tube first, resulting in a completely new, filtered array <em>before</em> you can process even a single value through the <code>double</code> tube. When you finally do get to <code>double</code> your first value, you have to wait for the entire array to be doubled before you can read a single result.</p>
<p>So, the code above is equivalent to this:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">double</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> x <span class="token operator">*</span> <span class="token number">2</span>
<span class="token keyword">const</span> <span class="token function-variable function">isEven</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> tempResult <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span>isEven<span class="token punctuation">)</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> tempResult<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span>double<span class="token punctuation">)</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token comment">// [4, 8, 12]</span>
</code></pre>
<p>The alternative is to flow a value directly from the filtered output to the mapping transformation without creating and iterating over a new, temporary array in between. Flowing the values through one at a time removes the need to iterate over the same collection for each stage in the transducing process, and transducers can signal a stop at any time, meaning you don’t need to enumerate each stage deeper over the collection than required to produce the desired values.</p>
<p>There are two ways to do that:</p>
<ul>
<li>Pull: lazy evaluation, or</li>
<li>Push: eager evaluation</li>
</ul>
<p>A pull API waits until a consumer asks for the next value. A good example in JavaScript is an <code>Iterable</code>, such as the object produced by a generator function. Nothing happens in the generator function until you ask for the next value by calling <code>.next()</code>on the iterator object it returns.</p>
<p>A push API enumerates over the source values and pushes them through the tubes as fast as it can. A call to <code>array.reduce()</code> is a good example of a push API. <code>array.reduce()</code> takes one value at a time from the array and pushes it through the reducer, resulting in a new value at the other end. For eager processes like array reduce, the process is immediately repeated for each element in the array until the entire array has been processed, blocking further program execution in the meantime.</p>
<p>Transducers don’t care whether you pull or push. Transducers have no awareness of the data structure they’re acting on. They simply call the reducer you pass into them to accumulate new values.</p>
<p>Transducers are higher order reducers: Reducer functions that take a reducer and return a new reducer. Rich Hickey describes transducers as process transformations, meaning that as opposed to simply changing the values flowing through transducers, transducers change the processes that act on those values.</p>
<p>The signatures look like this:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">accumulator<span class="token punctuation">,</span> current</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> accumulator
<span class="token function-variable function">transducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> reducer
</code></pre>
<p>Or, to spell it out:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function-variable function">transducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">(</span><span class="token parameter">accumulator<span class="token punctuation">,</span> current</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> accumulator</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">accumulator<span class="token punctuation">,</span> current</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> accumulator<span class="token punctuation">)</span>
</code></pre>
<p>Generally speaking though, most transducers will need to be partially applied to some arguments to specialize them. For example, a map transducer might look like this:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function-variable function">map</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">transform</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> reducer
</code></pre>
<p>Or more specifically:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function-variable function">map</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token arrow operator">=></span> b<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token parameter">step</span> <span class="token arrow operator">=></span> reducer
</code></pre>
<p>In other words, a map transducer takes a mapping function (called a transform) and a reducer (called the <code>step</code> function), and returns a new reducer. The <code>step</code> function is a reducer to call when we've produced a new value to add to the accumulator in the next step.</p>
<p>Let’s look at some naive examples:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">compose</span> <span class="token operator">=</span>
  <span class="token punctuation">(</span><span class="token parameter"><span class="token spread operator">...</span>fns</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
  <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
    fns<span class="token punctuation">.</span><span class="token method function property-access">reduceRight</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">y<span class="token punctuation">,</span> f</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">f</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">map</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token parameter">step</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">step</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">f</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">filter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">predicate</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token parameter">step</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">predicate</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">step</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token operator">:</span> a
<span class="token keyword">const</span> <span class="token function-variable function">isEven</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> n <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span>
<span class="token keyword">const</span> <span class="token function-variable function">double</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> n <span class="token operator">*</span> <span class="token number">2</span>
<span class="token keyword">const</span> doubleEvens <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span>isEven<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>double<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">arrayConcat</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> a<span class="token punctuation">.</span><span class="token method function property-access">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> xform <span class="token operator">=</span> <span class="token function">doubleEvens</span><span class="token punctuation">(</span>arrayConcat<span class="token punctuation">)</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span>xform<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// [4, 8, 12]</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</code></pre>
<p>That’s a lot to absorb. Let’s break it down. <code>map</code> applies a function to the values inside some context. In this case, the context is the transducer pipeline. It looks roughly like this:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">map</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token parameter">step</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">step</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">f</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>You can use it like this:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">double</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> x <span class="token operator">*</span> <span class="token number">2</span>
<span class="token keyword">const</span> doubleMap <span class="token operator">=</span> <span class="token function">map</span><span class="token punctuation">(</span>double<span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">step</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token function">doubleMap</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">// 8</span>
<span class="token function">doubleMap</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span> <span class="token comment">// 42</span>
</code></pre>
<p>The zeros in the function calls at the end represent the initial values for the reducers. Note that the step function is supposed to be a reducer, but for demonstration purposes, we can hijack it and log to the console. You can use the same trick in your unit tests if you need to make assertions about how the step function gets used.</p>
<p>Transducers get interesting when we compose them together. Let’s implement a simplified filter transducer:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">filter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">predicate</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token parameter">step</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">predicate</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">step</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token operator">:</span> a
</code></pre>
<p>Filter takes a predicate function and only passes through the values that match the predicate. Otherwise, the returned reducer returns the accumulator, unchanged.</p>
<p>Since both of these functions take a reducer and return a reducer, we can compose them with simple function composition:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">compose</span> <span class="token operator">=</span>
  <span class="token punctuation">(</span><span class="token parameter"><span class="token spread operator">...</span>fns</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
  <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
    fns<span class="token punctuation">.</span><span class="token method function property-access">reduceRight</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">y<span class="token punctuation">,</span> f</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">f</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">isEven</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> n <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span>
<span class="token keyword">const</span> <span class="token function-variable function">double</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> n <span class="token operator">*</span> <span class="token number">2</span>
<span class="token keyword">const</span> doubleEvens <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span>isEven<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>double<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>This will also return a transducer, which means we must supply a final step function in order to tell the transducer how to accumulate the result:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">arrayConcat</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> a<span class="token punctuation">.</span><span class="token method function property-access">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> xform <span class="token operator">=</span> <span class="token function">doubleEvens</span><span class="token punctuation">(</span>arrayConcat<span class="token punctuation">)</span>
</code></pre>
<p>The result of this call is a standard reducer that we can pass directly to any compatible reduce API. The second argument represents the initial value of the reduction. In this case, an empty array:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span>xform<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// [4, 8, 12]</span>
</code></pre>
<p>If this seems like a lot of work, keep in mind there are already functional programming libraries that supply common transducers along with utilities such as <code>compose</code>, which handles function composition, and <code>into</code>, which transduces a value into the given empty value, e.g.:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> xform <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>inc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">filter</span><span class="token punctuation">(</span>isEven<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> xform<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// [2, 4]</span>
</code></pre>
<p>With most of the required tools already in the tool belt, programming with transducers is really intuitive.</p>
<p>Some popular libraries which support transducers include Ramda, RxJS, and Mori.</p>
<h1 id="transducers-compose-top-to-bottom">Transducers Compose Top-to-Bottom<a aria-hidden="true" class="anchor-heading icon-link" href="#transducers-compose-top-to-bottom"></a></h1>
<p>Transducers under standard function composition (<code>f(g(x))</code>) apply top to bottom/left-to-right rather than bottom-to-top/right-to-left. In other words, using normal function composition, <code>compose(f, g)</code> means "compose <code>f</code> <em>after</em> <code>g</code>". Transducers wrap around other transducers under composition. In other words, a transducer says "I'm going to do my thing, and <em>then</em> call the next transducer in the pipeline", which has the effect of turning the execution stack inside out.</p>
<p>Imagine you have a stack of papers, the top labeled, <code>f</code>, the next, <code>g</code>, and the next <code>h</code>. For each sheet, take the sheet off the top of the stack and place it onto the top of a new adjacent stack. When you're done, you'll have a stack whose sheets are labeled <code>h</code>, then <code>g</code>, then <code>f</code>.</p>
<h1 id="transducer-rules">Transducer Rules<a aria-hidden="true" class="anchor-heading icon-link" href="#transducer-rules"></a></h1>
<p>The examples above are naive because they ignore the rules that transducers must follow for interoperability.</p>
<p>As with most things in software, transducers and transducing processes need to obey some rules:</p>
<ol>
<li>Initialization: Given no initial accumulator value, a transducer must call the step function to produce a valid initial value to act on. The value should represent the empty state. For example, an accumulator that accumulates an array should supply an empty array when its step function is called with no arguments.</li>
<li>Early termination: A process that uses transducers must check for and stop when it receives a reduced accumulator value. Additionally, a transducer step function that uses a nested reduce must check for and convey reduced values when they are encountered.</li>
<li>Completion (optional): Some transducing processes never complete, but those that do should call the completion function to produce a final value and/or flush state, and stateful transducers should supply a completion operation that cleans up any accumulated resources and potentially produces one final value.</li>
</ol>
<h1 id="initialization">Initialization<a aria-hidden="true" class="anchor-heading icon-link" href="#initialization"></a></h1>
<p>Let’s go back to the <code>map</code> operation and make sure that it obeys the initialization (empty) law. Of course, we don't need to do anything special, just pass the request down the pipeline using the step function to create a default value:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">map</span> <span class="token operator">=</span>
  <span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
  <span class="token punctuation">(</span><span class="token parameter">step</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
  <span class="token punctuation">(</span><span class="token parameter">a <span class="token operator">=</span> <span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
    <span class="token function">step</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">f</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>The part we care about is <code>a = step()</code> in the function signature. If there is no value for <code>a</code> (the accumulator), we'll create one by asking the next reducer in the chain to produce it. Eventually, it will reach the end of the pipeline and (hopefully) create a valid initial value for us.</p>
<p>Remember this rule: When called with no arguments, a reducer should always return a valid initial (empty) value for the reduction. It’s generally a good idea to obey this rule for any reducer function, including reducers for React or Redux.</p>
<h1 id="early-termination">Early Termination<a aria-hidden="true" class="anchor-heading icon-link" href="#early-termination"></a></h1>
<p>It’s possible to signal to other transducers in the pipeline that we’re done reducing, and they should not expect to process any more values. Upon seeing a <code>reduced</code> value, other transducers may decide to stop adding to the collection, and the transducing process (as controlled by the final <code>step()</code> function) may decide to stop enumerating over values. The transducing process may make one more call as a result of receiving a <code>reduced</code> value: The completion call mentioned above. We can signal that intention with a special reduced accumulator value.</p>
<p>What is a reduced value? It could be as simple as wrapping the accumulator value in a special type called <code>reduced</code>. Think of it like wrapping a package in a box and labelling the box with messages like "Express" or "Fragile". Metadata wrappers like this are common in computing. For example: http messages are wrapped in containers called "request" or "response", and those container types have headers that supply information like status codes, expected message length, authorization parameters, etc...</p>
<p>Basically, it’s a way of sending multiple messages where only a single value is expected. A minimal (non-standard) example of a <code>reduced()</code> type lift might look like this:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">reduced</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token keyword">get</span> <span class="token function">isReduced</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">valueOf</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> v<span class="token punctuation">,</span>
  <span class="token function-variable function">toString</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Reduced(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>The only parts that are strictly required are:</p>
<ul>
<li>The type lift: A way to get the value inside the type (e.g., the <code>reduced</code> function, in this case)</li>
<li>Type identification: A way to test the value to see if it is a value of <code>reduced</code> (e.g., the <code>isReduced</code> getter)</li>
<li>Value extraction: A way to get the value back out of the type (e.g., <code>valueOf()</code>)</li>
</ul>
<p><code>toString()</code> is included here strictly for debugging convenience. It lets you introspect both the type and the value at the same time in the console.</p>
<h1 id="completion">Completion<a aria-hidden="true" class="anchor-heading icon-link" href="#completion"></a></h1>
<blockquote>
<p>“In the completion step, a transducer with reduction state should flush state prior to calling the nested transformer’s completion function, unless it has previously seen a reduced value from the nested step in which case pending state should be discarded.” ~ Clojure transducers documentation</p>
</blockquote>
<p>In other words, if you have more state to flush after the previous function has signaled that it’s finished reducing, the completion step is the time to handle it. At this stage, you can optionally:</p>
<ul>
<li>Send one more value (flush your pending state)</li>
<li>Discard your pending state</li>
<li>Perform any required state cleanup</li>
</ul>
<h1 id="transducing">Transducing<a aria-hidden="true" class="anchor-heading icon-link" href="#transducing"></a></h1>
<p>It’s possible to transduce over lots of different types of data, but the process can be generalized:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// import a standard curry, or use this magic spell:</span>
<span class="token keyword">const</span> <span class="token function-variable function">curry</span> <span class="token operator">=</span>
  <span class="token punctuation">(</span><span class="token parameter">f<span class="token punctuation">,</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
  <span class="token punctuation">(</span><span class="token parameter"><span class="token spread operator">...</span>args</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">===</span> f<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">?</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token spread operator">...</span>a<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">curry</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token spread operator">...</span>arr<span class="token punctuation">,</span> <span class="token spread operator">...</span>args<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> transduce <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">step<span class="token punctuation">,</span> initial<span class="token punctuation">,</span> xform<span class="token punctuation">,</span> foldable</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
  foldable<span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span><span class="token function">xform</span><span class="token punctuation">(</span>step<span class="token punctuation">)</span><span class="token punctuation">,</span> initial<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre>
<p>The <code>transduce()</code> function takes a step function (the final step in the transducer pipeline), an initial value for the accumulator, a transducer, and a foldable. A foldable is any object that supplies a <code>.reduce()</code> method.</p>
<p>With <code>transduce()</code> defined, we can easily create a function that transduces to an array. First, we need a reducer that reduces to an array:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">concatArray</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> a<span class="token punctuation">.</span><span class="token method function property-access">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<p>Now we can use the curried <code>transduce()</code> to create a partial application that transduces to arrays:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> toArray <span class="token operator">=</span> <span class="token function">transduce</span><span class="token punctuation">(</span>concatArray<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<p>With <code>toArray()</code> we can replace two lines of code with one, and reuse it in a lot of other situations, besides:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Manual transduce:</span>
<span class="token keyword">const</span> xform <span class="token operator">=</span> <span class="token function">doubleEvens</span><span class="token punctuation">(</span>arrayConcat<span class="token punctuation">)</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span>xform<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// => [4, 8, 12]// Automatic transduce:</span>
<span class="token keyword">const</span> result2 <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>doubleEvens<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>result2<span class="token punctuation">)</span> <span class="token comment">// [4, 8, 12]</span>
</code></pre>
<h1 id="the-transducer-protocol">The Transducer Protocol<a aria-hidden="true" class="anchor-heading icon-link" href="#the-transducer-protocol"></a></h1>
<p>Up to this point, I’ve been hiding some details behind a curtain, but it’s time to take a look at them now. Transducers are not really a single function. They’re made from 3 different functions. Clojure switches between them using pattern matching on the function’s arity.</p>
<p>In computer science, the arity of a function is the number of arguments a function takes. In the case of transducers, there are two arguments to the reducer function, the accumulator and the current value. In Clojure, Both are <em>optional</em>, and the behavior changes based on whether or not the arguments get passed. If a parameter is not passed, the type of that parameter inside the function is <code>undefined</code>.</p>
<p>The JavaScript transducer protocol handles things a little differently. Instead of using function arity, JavaScript transducers are a function that take a transducer and return a transducer. The transducer is an object with three methods:</p>
<ul>
<li><code>init</code> Return a valid initial value for the accumulator (usually, just call the next <code>step()</code>).</li>
<li><code>step</code> Apply the transform, e.g., for <code>map(f)</code>: <code>step(accumulator, f(current))</code>.</li>
<li><code>result</code> If a transducer is called without a new value, it should handle its completion step (usually <code>step(a)</code>, unless the transducer is stateful).</li>
</ul>
<blockquote>
<p><strong>Note:</strong> The transducer protocol in JavaScript uses <code>@@transducer/init</code>, <code>_@@transducer/step_</code><em>, and</em> <code>_@@transducer/result_</code><em>, respectively.</em></p>
</blockquote>
<p>Some libraries provide a <code>transducer()</code> utility that will automatically wrap your transducer for you.</p>
<p>Here is a less naive implementation of the map transducer:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">map</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
  <span class="token function">transducer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> next<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">result</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> next<span class="token punctuation">.</span><span class="token method function property-access">result</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">step</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> c</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> next<span class="token punctuation">.</span><span class="token method function property-access">step</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token function">f</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>By default, most transducers should pass the <code>init()</code> call to the next transducer in the pipeline, because we don't know the transport data type, so we can't produce a valid initial value for it.</p>
<p>Additionally, the special <code>reduced</code> object uses these properties (also namespaced <code>@@transducer/&#x3C;name></code> in the transducer protocol:</p>
<ul>
<li><code>reduced</code> A boolean value that is always <code>true</code> for reduced values.</li>
<li><code>value</code> The reduced value.</li>
</ul>
<h1 id="conclusion">Conclusion<a aria-hidden="true" class="anchor-heading icon-link" href="#conclusion"></a></h1>
<p><strong>Transducers</strong> are composable higher order reducers which can reduce over any underlying data type.</p>
<p>Transducers produce code that can be orders of magnitude more efficient than dot chaining with arrays, and handle potentially infinite data sets without creating intermediate aggregations.</p>
<blockquote>
<p><strong>Note:</strong> Transducers aren’t always faster than built-in array methods. The performance benefits tend to kick in when the data set is very large (hundreds of thousands of items), or pipelines are quite large (adding significantly to the number of iterations required using method chains). If you’re after the performance benefits, remember to profile.</p>
</blockquote>
<p>Take another look at the example from the introduction. You should be able to build <code>filter()</code>, <code>map()</code>, and <code>toArray()</code> using the example code as a reference and make this code work:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> friends <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Sting"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Radiohead"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"NIN"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Echo"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"Zeppelin"</span><span class="token punctuation">,</span> nearMe<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token keyword">const</span> <span class="token function-variable function">isNearMe</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> nearMe <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> nearMe
<span class="token keyword">const</span> <span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> name
<span class="token keyword">const</span> getFriendsNearMe <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span>isNearMe<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>getName<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> results2 <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>getFriendsNearMe<span class="token punctuation">,</span> friends<span class="token punctuation">)</span>
</code></pre>
<p>In production, you can use transducers from <a href="https://github.com/ReactiveX/rxjs">RxJS</a> or <a href="http://ramdajs.com/">Ramda</a>. In real code, I usually reach for transducers when I need to subscribe to streams of data and I want to process the data in the stream before using it in my application code. In those cases, I reach for the pipeable operators in RxJS. RxJS pipeable operators behave just like regular transducers, but instead of mapping from reducer to reducer, they map from observable to observable.</p>
<p>Here’s an example from Ramda:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> compose<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> map<span class="token punctuation">,</span> into <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"ramda"</span>
<span class="token keyword">const</span> <span class="token function-variable function">isEven</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> n <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span>
<span class="token keyword">const</span> <span class="token function-variable function">double</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> n <span class="token operator">*</span> <span class="token number">2</span>
<span class="token keyword">const</span> doubleEvens <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span>isEven<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">map</span><span class="token punctuation">(</span>double<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span> <span class="token comment">// into = (structure, transducer, data) => result</span>
<span class="token comment">// into transduces the data using the supplied</span>
<span class="token comment">// transducer into the structure passed as the</span>
<span class="token comment">// first argument.</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> doubleEvens<span class="token punctuation">,</span> arr<span class="token punctuation">)</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">// [4, 8, 12]</span>
</code></pre>
<p>Whenever I need to combine a number of operations, such as <code>map</code>, <code>filter</code>, <code>chunk</code>, <code>take</code>, and so on, I reach for transducers to optimize the process and keep the code readable and clean. Give them a try.</p>
<hr>
<strong>Backlinks</strong>
<ul>
<li><a href="/notes/1x5p06d62ckb8nrirqr94ag">Composing Software</a></li>
</ul>