<h1 id="detecting-rendered-line-breaks-in-a-text-node-in-javascript">Detecting Rendered Line Breaks in a Text Node in JavaScript<a aria-hidden="true" class="anchor-heading icon-link" href="#detecting-rendered-line-breaks-in-a-text-node-in-javascript"></a></h1>
<blockquote>
<p><a href="https://www.bennadel.com/blog/4310-detecting-rendered-line-breaks-in-a-text-node-in-javascript.htm">https://www.bennadel.com/blog/4310-detecting-rendered-line-breaks-in-a-text-node-in-javascript.htm</a></p>
</blockquote>
<pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>title</span><span class="token punctuation">></span></span>Detecting Rendered Line Breaks In A Text Node In JavaScript<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>./main.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h1</span><span class="token punctuation">></span></span>Detecting Rendered Line Breaks In A Text Node In JavaScript<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h1</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sample<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">400</span><span class="token unit">px</span> <span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>
      You fell victim to one of the classic blunders-the most famous of which
      is, "Never get involved in a land war in Asia" - but only slightly less
      well-known is this: "Never go against a Sicilian when death is on the
      line"! Ha ha ha ha ha ha ha! Ha ha ha ha ha ha ha!
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Detect Line Breaks<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>button</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">var</span> source <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">".sample"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">firstChild</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> button <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">".button"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// When the user clicks the button, process the text node.</span>
      button<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">logLines</span><span class="token punctuation">(</span><span class="token function">extractLinesFromTextNode</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// --------------------------------------------------------------------------- //</span>
      <span class="token comment">// --------------------------------------------------------------------------- //</span>

      <span class="token doc-comment comment">/**
       * I extract the visually rendered lines of text from the given textNode as it
       * exists in the document at this very moment. Meaning, it returns the lines of
       * text as seen by the user.
       */</span>
      <span class="token keyword">function</span> <span class="token function">extractLinesFromTextNode</span><span class="token punctuation">(</span><span class="token parameter">textNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>textNode<span class="token punctuation">.</span><span class="token property-access">nodeType</span> <span class="token operator">!==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Lines can only be extracted from text nodes."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// BECAUSE SAFARI: None of the "modern" browsers seem to care about the actual</span>
        <span class="token comment">// layout of the underlying markup. However, Safari seems to create range</span>
        <span class="token comment">// rectangles based on the physical structure of the markup (even when it</span>
        <span class="token comment">// makes no difference in the rendering of the text). As such, let's rewrite</span>
        <span class="token comment">// the text content of the node to REMOVE SUPERFLUOS WHITE-SPACE. This will</span>
        <span class="token comment">// allow Safari's .getClientRects() to work like the other modern browsers.</span>
        textNode<span class="token punctuation">.</span><span class="token property-access">textContent</span> <span class="token operator">=</span> <span class="token function">collapseWhiteSpace</span><span class="token punctuation">(</span>textNode<span class="token punctuation">.</span><span class="token property-access">textContent</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// A Range represents a fragment of the document which contains nodes and</span>
        <span class="token comment">// parts of text nodes. One thing that's really cool about a Range is that we</span>
        <span class="token comment">// can access the bounding boxes that contain the contents of the Range. By</span>
        <span class="token comment">// incrementally adding characters - from our text node - into the range, and</span>
        <span class="token comment">// then looking at the Range's client rectangles, we can determine which</span>
        <span class="token comment">// characters belong in which rendered line.</span>
        <span class="token keyword">var</span> textContent <span class="token operator">=</span> textNode<span class="token punctuation">.</span><span class="token property-access">textContent</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> range <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> lines <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> lineCharacters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// Iterate over every character in the text node.</span>
        <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&#x3C;</span> textContent<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Set the range to span from the beginning of the text node up to and</span>
          <span class="token comment">// including the current character (offset).</span>
          range<span class="token punctuation">.</span><span class="token method function property-access">setStart</span><span class="token punctuation">(</span>textNode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          range<span class="token punctuation">.</span><span class="token method function property-access">setEnd</span><span class="token punctuation">(</span>textNode<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// At this point, the Range's client rectangles will include a rectangle</span>
          <span class="token comment">// for each visually-rendered line of text. Which means, the last</span>
          <span class="token comment">// character in our Range (the current character in our for-loop) will be</span>
          <span class="token comment">// the last character in the last line of text (in our Range). As such, we</span>
          <span class="token comment">// can use the current rectangle count to determine the line of text.</span>
          <span class="token keyword">var</span> lineIndex <span class="token operator">=</span> range<span class="token punctuation">.</span><span class="token method function property-access">getClientRects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

          <span class="token comment">// If this is the first character in this line, create a new buffer for</span>
          <span class="token comment">// this line.</span>
          <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lines<span class="token punctuation">[</span>lineIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lines<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>lineCharacters <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// Add this character to the currently pending line of text.</span>
          lineCharacters<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>textContent<span class="token punctuation">.</span><span class="token method function property-access">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// At this point, we have an array (lines) of arrays (characters). Let's</span>
        <span class="token comment">// collapse the character buffers down into a single text value.</span>
        lines <span class="token operator">=</span> lines<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">operator</span><span class="token punctuation">(</span><span class="token parameter">characters</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword control-flow">return</span> <span class="token function">collapseWhiteSpace</span><span class="token punctuation">(</span>characters<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// DEBUGGING: Draw boxes around our client rectangles.</span>
        <span class="token function">drawRectBoxes</span><span class="token punctuation">(</span>range<span class="token punctuation">.</span><span class="token method function property-access">getClientRects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword control-flow">return</span> lines<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token doc-comment comment">/**
       * I normalize the white-space in the given value such that the amount of white-
       * space matches the rendered white-space (browsers collapse strings of white-space
       * down to single space character, visually, and this is just updating the text to
       * match that behavior).
       */</span>
      <span class="token keyword">function</span> <span class="token function">collapseWhiteSpace</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> value<span class="token punctuation">.</span><span class="token method function property-access">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token doc-comment comment">/**
       * I draw red boxes on the screen for the given client rects.
       */</span>
      <span class="token keyword">function</span> <span class="token function">drawRectBoxes</span><span class="token punctuation">(</span><span class="token parameter">clientRects</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">arrayFrom</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">".box"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">iterator</span><span class="token punctuation">(</span>
          <span class="token parameter">node</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          node<span class="token punctuation">.</span><span class="token method function property-access">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">arrayFrom</span><span class="token punctuation">(</span>clientRects<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token parameter">rect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> box <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          box<span class="token punctuation">.</span><span class="token property-access">classList</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token string">"box"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          box<span class="token punctuation">.</span><span class="token property-access">style</span><span class="token punctuation">.</span><span class="token property-access">top</span> <span class="token operator">=</span> rect<span class="token punctuation">.</span><span class="token property-access">y</span> <span class="token operator">+</span> <span class="token string">"px"</span><span class="token punctuation">;</span>
          box<span class="token punctuation">.</span><span class="token property-access">style</span><span class="token punctuation">.</span><span class="token property-access">left</span> <span class="token operator">=</span> rect<span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">+</span> <span class="token string">"px"</span><span class="token punctuation">;</span>
          box<span class="token punctuation">.</span><span class="token property-access">style</span><span class="token punctuation">.</span><span class="token property-access">width</span> <span class="token operator">=</span> rect<span class="token punctuation">.</span><span class="token property-access">width</span> <span class="token operator">+</span> <span class="token string">"px"</span><span class="token punctuation">;</span>
          box<span class="token punctuation">.</span><span class="token property-access">style</span><span class="token punctuation">.</span><span class="token property-access">height</span> <span class="token operator">=</span> rect<span class="token punctuation">.</span><span class="token property-access">height</span> <span class="token operator">+</span> <span class="token string">"px"</span><span class="token punctuation">;</span>
          <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span>box<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token doc-comment comment">/**
       * I log the given lines of text using a grouped output.
       */</span>
      <span class="token keyword">function</span> <span class="token function">logLines</span><span class="token punctuation">(</span><span class="token parameter">lines</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">group</span><span class="token punctuation">(</span><span class="token string">"Rendered Lines of Text"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        lines<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token parameter">line<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">groupEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token doc-comment comment">/**
       * I create a true array from the given array-like data. Array.from() if you are on
       * modern browsers.
       */</span>
      <span class="token keyword">function</span> <span class="token function">arrayFrom</span><span class="token punctuation">(</span><span class="token parameter">arrayLike</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span>arrayLike<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
</code></pre>
<p><img src="/assets/images/extracting-rendered-lines-of-text-from-text-node-javascript@2x.png"></p>