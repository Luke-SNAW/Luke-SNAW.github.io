<h1 id="say-goodbye-to-resource-caching-across-sites-and-domains">Say goodbye to resource-caching across sites and domains<a aria-hidden="true" class="anchor-heading icon-link" href="#say-goodbye-to-resource-caching-across-sites-and-domains"></a></h1>
<blockquote>
<p><a href="https://www.stefanjudis.com/notes/say-goodbye-to-resource-caching-across-sites-and-domains/">https://www.stefanjudis.com/notes/say-goodbye-to-resource-caching-across-sites-and-domains/</a></p>
</blockquote>
<p>When I started doing web development, we all loaded jQuery from the official global jQuery CDN.</p>
<p>The idea was straightforward: if everybody loads the same jQuery script file (<code>cdn.jquery.com/jquery.latest.js</code> ‚Äì or whatever URL it was back then), then the script file would be cached by the browsers, and other sites requesting the same script would benefit from the speedup of already cached resources. Users would have popular libraries like jQuery already sitting in their browser cache because earlier visited sites requested them.</p>
<p>This caching behavior was possible because, at the time, the browser's HTTP caches used the asset URL (<code>cdn.jquery.com/jquery.latest.js</code>) as a single cache key. Browsers use cache keys to figure out if and how to cache a resource. If these keys only consist of the resource URL, it allows the reuse of resources across sites and domains.</p>
<p>All this worked great, but as it is with many great inventions in web technology, <strong>cross-site resource caching enabled new ways to track users across different sites</strong>.</p>
<p>As an example, let's assume Facebook loads a unique file in their logged-in area (<code>fb-logo-ajgdmaks839‚Äìas.svg</code> ‚Äì I made that file path up); if I would know the file path to such a file, request it on <code>stefanjudis.com</code> and see a rapid response coming from the browser cache, I can almost be sure that the user has logged into Facebook lately.</p>
<h2 id="new-http-cache-keys-in-google-chrome"><a href="https://www.stefanjudis.com/notes/say-goodbye-to-resource-caching-across-sites-and-domains/#new-http-cache-keys-in-google-chrome">New HTTP cache keys in Google Chrome</a><a aria-hidden="true" class="anchor-heading icon-link" href="#new-http-cache-keys-in-google-chrome"></a></h2>
<p><a href="https://bugs.webkit.org/show_bug.cgi?id=110269">Webkit (Safari) changed its caching strategy already in 2013</a> to prevent user tracking via the browser cache. Its cache keys are a combination of the requested resource URL and the top-level domain requesting the resource.</p>
<p><em>‚òùÔ∏è Big thanks to <a href="https://twitter.com/tomayac/status/1317861511784792067?s=20">Thomas Steiner, who gave input on that matter</a>.</em></p>
<p>On the bright side, this cache key structure prevents the mentioned tracking possibilities; unfortunately, it leads to duplicated resources in the browser cache.</p>
<p>And... it hinders third-party resource sharing across the internet.</p>
<pre><code>Browsers duplicate resources with different keys:

cdn.jquery.com/jquery.latest.js-amazon.co.uk
cdn.jquery.com/jquery.latest.js-www.stefanjudis.com
</code></pre>
<p>Starting with v86, Chrome will be using combined cache keys, too. This change means that it's time to say goodbye to third-party resource-sharing across the web. <a href="https://www.statista.com/statistics/544400/market-share-of-internet-browsers-desktop/">With Chrome's market share of roughly 70%</a>, most browsers hitting our sites will use partitioned browser caches from now on. Chrome went for combining the top-level site URL, the current frame site URL, and the resource URL. This approach is more granular than what Safari does, but the result is the same.</p>
<p>If your sites request the global jQuery, modules from <a href="https://unpkg.com/">unpkg.com</a>, font files from <a href="https://fonts.google.com/">Google fonts</a> or GA's (Google Analytics) <code>analytics.js</code>, <strong>users will redownload the resources no matter if they downloaded and cached them for other sites already.</strong></p>
<p>What does this change mean for you? If your sites live on modern hosting that provides a CDN and supports HTTP/2, you should drop the third-parties and ship all resources yourself. Relying on a third party resources offers little value in 2020.</p>
<p>I have mixed feelings about these changes. It's excellent that browsers consider privacy, but it looks like anything can be misused for tracking purposes these days. I wonder where we're going with this... üò¢</p>
<hr>
<p>If you're interested in learning more on this topic, give <a href="https://shkspr.mobi/blog/2020/10/please-stop-using-cdns-for-external-javascript-libraries/">Terence Eden's post "Please stop using CDNs for external Javascript libraries"</a> or <a href="https://andydavies.me/blog/2018/09/06/safari-caching-and-3rd-party-resources/">Andy Davies' post "Safari, Caching and Third-Party Resources"</a> a read, too.</p>
<p>And hey, this post was trending on Hacker News. üéâ If you're interested, <a href="https://news.ycombinator.com/item?id=24894135">here are the Hacker News comments</a>.</p>
<p>Update: <a href="https://developer.mozilla.org/en-US/docs/Web/Privacy/State_Partitioning#network_partitioning">Firefox shipped partitioned HTTP caching in January 2021, too</a>.</p>