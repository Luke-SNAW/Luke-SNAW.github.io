<h1 id="conditionally-adaptive-css-browser-behavior-that-might-improve-your-performance">CONDITIONALLY ADAPTIVE CSS. BROWSER BEHAVIOR THAT MIGHT IMPROVE YOUR PERFORMANCE<a aria-hidden="true" class="anchor-heading icon-link" href="#conditionally-adaptive-css-browser-behavior-that-might-improve-your-performance"></a></h1>
<blockquote>
<p><a href="https://pepelsbey.dev/articles/conditionally-adaptive/">https://pepelsbey.dev/articles/conditionally-adaptive/</a></p>
</blockquote>
<p>There’s a component structure behind every website or app these days, hundreds of small files. Though when it comes to delivering resources, we often serve just a single file for every resource type: styles, scripts, and even sprites for images. Everything gets squashed during the build process, including resources specific to certain resolutions or media conditions.</p>
<p>And resources aren’t equal! For example, CSS is a blocking resource, and there’s nothing for a browser to render until every last byte of every CSS file is loaded. Why? The last line of a CSS file could overwrite something that came just before that. That’s your “C” in the CSS, which stands for “cascade.”</p>
<h2 id="whatif">What if?<a aria-hidden="true" class="anchor-heading icon-link" href="#whatif"></a></h2>
<p>What if we’d take the CSS bundle we’ve just built out of dozens of files and split it back into multiple parts? But this time, based on conditions where these parts are applicable. For example, we could split it into four files:</p>
<ul>
<li><strong>Base:</strong> universal styles with fonts and colors</li>
<li><strong>Mobile:</strong> styles only for narrow viewports</li>
<li><strong>Tablet:</strong> styles only for medium viewports</li>
<li><strong>Desktop:</strong> styles only for large viewports</li>
</ul>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>base.css<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mobile.css<span class="token punctuation">"</span></span> <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(max-width: 767px)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span>
  <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span>
  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tablet.css<span class="token punctuation">"</span></span>
  <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(min-width: 768px) and (max-width: 1023px)<span class="token punctuation">"</span></span>
<span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>desktop.css<span class="token punctuation">"</span></span> <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(min-width: 1024px)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre>
<h2 id="priorities">Priorities<a aria-hidden="true" class="anchor-heading icon-link" href="#priorities"></a></h2>
<p>Another little detail in the Network panel made me realize what was going on: the Priority column. You might have to enable it by right-clicking the table heading and choosing it from the list of available columns.</p>
<hr>
<p>It will also require you to write your CSS in a way that isolates styles for different viewports. That’s another idea for an article, by the way. The same goes for tooling: it’s not quite there yet. The closes thing I could find are <a href="https://github.com/SassNinja/media-query-plugin">Media Query plugin for Webpack</a> and <a href="https://github.com/SassNinja/postcss-combine-media-query">Extract Media Query plugin for PostCSS</a>.</p>
<h2 id="preferences">Preferences<a aria-hidden="true" class="anchor-heading icon-link" href="#preferences"></a></h2>
<p>The list of <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@media#media_features">media features</a> you can use in Media Queries extends beyond just viewport width and height. You can adapt your website to the user’s needs and preferences: color scheme, pixel density, reduced motion, etc. But not only that! With this new behavior in mind, we can make sure that only relevant styles are render-blocking.</p>
<h3 id="color-scheme">Color scheme<a aria-hidden="true" class="anchor-heading icon-link" href="#color-scheme"></a></h3>
<p>One of the most popular media features these days is <code>prefers-color-scheme</code>, which allows you to supply light and dark color schemes to match the user’s system preferences. In most cases, it’s used right in CSS as <code>@media</code>, but it can also be used to link relevant CSS files conditionally.</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>light.css<span class="token punctuation">"</span></span> <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(prefers-color-scheme: light)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dark.css<span class="token punctuation">"</span></span> <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(prefers-color-scheme: dark)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre>
<p>And just like we’ve learned before, browsers will load <em>dark.css</em> with the lowest priority in the case when the user prefers a light color scheme and vice versa. There’s a <a href="https://web.dev/prefers-color-scheme/">good article by Thomas Steiner</a> diving deep into the dark mode, including a theme toggler that works with CSS files linked this way.</p>
<h3 id="pixel-density">Pixel density<a aria-hidden="true" class="anchor-heading icon-link" href="#pixel-density"></a></h3>
<p>Sometimes we have to deal not with <a href="https://pepelsbey.dev/articles/svg-sprites/">beautiful vector graphics</a>, but with raster images too. In this case, we often have different files for different pixel densities, for example, <em>icon.png</em> and <a href="/mailto:_icon@2x.png_">_icon@2x.png_</a>.</p>
<pre class="language-css"><code class="language-css"><span class="token selector">a</span> <span class="token punctuation">{</span>
  <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span>
  <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token unit">px</span><span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token unit">px</span><span class="token punctuation">;</span>
  <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">"icon.png"</span><span class="token punctuation">)</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token atrule"><span class="token rule">@media</span> <span class="token punctuation">(</span><span class="token property">min-resolution</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token unit">dppx</span><span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector">a</span> <span class="token punctuation">{</span>
    <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">"icon@2x.png"</span><span class="token punctuation">)</span></span><span class="token punctuation">;</span>
    <span class="token property">background-size</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token unit">px</span> <span class="token number">24</span><span class="token unit">px</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>These six lines of CSS specifically targeting high-density screens are usually bundled into the same file loaded for users with low-density screens. Fortunately, browsers are smart enough not to load high-density graphics. You guessed it, we can do it even better: split them into a separate file and load it with the lowest priority.</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>retina.css<span class="token punctuation">"</span></span> <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(min-resolution: 2dppx)<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre>
<p>This file will be loaded and applied immediately if the user decides to drag the browser window to a high-density screen. But it won’t block the initial rendering on a low-density screen.</p>
<h3 id="reduced-motion">Reduced motion<a aria-hidden="true" class="anchor-heading icon-link" href="#reduced-motion"></a></h3>
<p>Animations and smooth transitions could improve user experience, but for some people they can be a source of distraction or discomfort. The media feature <code>prefers-reduced-motion</code> allows you to wrap your heavy motion in <code>@media</code> to give users a choice. By the way, “reduce” doesn’t mean “disable”, it’s up to you to create a comfortable environment and not sacrifice clarity at the same time.</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>link</span>
  <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span>
  <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>animation.css<span class="token punctuation">"</span></span>
  <span class="token attr-name">media</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(prefers-reduced-motion: no-preference)<span class="token punctuation">"</span></span>
<span class="token punctuation">/></span></span>
</code></pre>
<p>Instead, you can put your motion-heavy styles into a separate file that will be loaded with the lowest priority when the user prefers reduced motion. The best way to achieve this would be to extract all the matching <code>@media</code> during the build process.</p>