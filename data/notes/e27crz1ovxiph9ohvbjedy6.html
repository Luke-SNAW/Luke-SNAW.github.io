<h1 id="setting-front-cdn">Setting Front CDN<a aria-hidden="true" class="anchor-heading icon-link" href="#setting-front-cdn"></a></h1>
<h2 id="s3-ë²„í‚·-ìƒì„±">S3 ë²„í‚· ìƒì„±<a aria-hidden="true" class="anchor-heading icon-link" href="#s3-ë²„í‚·-ìƒì„±"></a></h2>
<ul>
<li><a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-restricting-access-to-s3.html">Restrict access to an Amazon S3 origin</a></li>
<li>Amazon S3 Object Ownership to Bucket owner enforced</li>
<li>pubilc access í¼ë¸”ë¦­ ì•¡ì„¸ìŠ¤ ì°¨ë‹¨</li>
<li>not a bucket configured as a website endpoint. ì •ì  ì›¹ ì‚¬ì´íŠ¸ í˜¸ìŠ¤íŒ… ì“°ì§€ ì•Šê¸°</li>
</ul>
<h3 id="ê¶Œí•œ-íƒ­">ê¶Œí•œ íƒ­<a aria-hidden="true" class="anchor-heading icon-link" href="#ê¶Œí•œ-íƒ­"></a></h3>
<details>
  <summary>ë²„í‚· ì •ì±…</summary>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
  <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"s3:ListBucket"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"arn:aws:s3:::YOUR_BUCKET"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"AWS"</span><span class="token operator">:</span> <span class="token string">"arn:aws:iam::YOUR_ACCOUNT_NUMBER:user/YOUR_USERNAME"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"s3:PutObject"</span><span class="token punctuation">,</span>
        <span class="token string">"s3:PutObjectAcl"</span><span class="token punctuation">,</span>
        <span class="token string">"s3:DeleteObject"</span><span class="token punctuation">,</span> <span class="token comment">// sync --deleteì— í•„ìš”. https://stackoverflow.com/a/30638955/5163033</span>
        <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span>
        <span class="token string">"s3:GetObjectAcl"</span><span class="token punctuation">,</span>
        <span class="token string">"s3:AbortMultipartUpload"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"arn:aws:s3:::YOUR_BUCKET/*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"AWS"</span><span class="token operator">:</span> <span class="token string">"arn:aws:iam::YOUR_ACCOUNT_NUMBER:user/YOUR_USERNAME"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// Cloudfront OAC, https://aws.amazon.com/blogs/networking-and-content-delivery/amazon-cloudfront-introduces-origin-access-control-oac/</span>
      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
      <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"Service"</span><span class="token operator">:</span> <span class="token string">"cloudfront.amazonaws.com"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span>
      <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:s3:::your-bucket/*"</span><span class="token punctuation">,</span>
      <span class="token property">"Condition"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"StringEquals"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"AWS:SourceArn"</span><span class="token operator">:</span> <span class="token string">"arn:aws:cloudfront::YOUR-ACCOUNT-ID:distribution/YOUR-DISTRIBUTION-ID"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token comment">//Public readê°€ í•„ìš”í•˜ë‹¤ë©´</span>
      <span class="token property">"Sid"</span><span class="token operator">:</span> <span class="token string">"public-read"</span><span class="token punctuation">,</span>
      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
      <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token string">"*"</span><span class="token punctuation">,</span>
      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"s3:GetObject"</span><span class="token punctuation">,</span>
      <span class="token property">"Resource"</span><span class="token operator">:</span> <span class="token string">"arn:aws:s3:::YOUR_BUCKET/*"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
</details>
<h2 id="cloudfront-ë°°í¬-ìƒì„±">CloudFront ë°°í¬ ìƒì„±<a aria-hidden="true" class="anchor-heading icon-link" href="#cloudfront-ë°°í¬-ìƒì„±"></a></h2>
<ul>
<li>origin domain: S3
<ul>
<li>ì›ë³¸ í¸ì§‘ - ì›ë³¸ ì•¡ì„¸ìŠ¤ - ì›ë³¸ ì•¡ì„¸ìŠ¤ ì œì–´ ì„¤ì • - Origin access control</li>
</ul>
</li>
<li>SSL Certicicate â†’ Custom SSL â†’ ACMì— ë§Œë“¤ì–´ì ¸ ìˆëŠ” SSL</li>
<li>CNAME: domain name</li>
<li>default root object: index.html</li>
</ul>
<h2 id="route53">Route53<a aria-hidden="true" class="anchor-heading icon-link" href="#route53"></a></h2>
<h3 id="cname-ìƒì„±">CNAME ìƒì„±<a aria-hidden="true" class="anchor-heading icon-link" href="#cname-ìƒì„±"></a></h3>
<ul>
<li>ë ˆì½”ë“œ ì´ë¦„: site name</li>
<li>ê°’: CloudFrontì˜ URL</li>
</ul>
<h2 id="front-spa-framework-ë°°í¬-ì‹œ-cacheì™€-ìƒê´€ì—†ì´-ìƒˆ-ë²„ì „-ì ìš©ì„-ìœ„í•´">Front SPA framework ë°°í¬ ì‹œ cacheì™€ ìƒê´€ì—†ì´ ìƒˆ ë²„ì „ ì ìš©ì„ ìœ„í•´<a aria-hidden="true" class="anchor-heading icon-link" href="#front-spa-framework-ë°°í¬-ì‹œ-cacheì™€-ìƒê´€ì—†ì´-ìƒˆ-ë²„ì „-ì ìš©ì„-ìœ„í•´"></a></h2>
<p>no-cache í—¤ë” + RefreshHit</p>
<h3 id="refreshhit-from-cloudfront">RefreshHit from cloudfront<a aria-hidden="true" class="anchor-heading icon-link" href="#refreshhit-from-cloudfront"></a></h3>
<p><code>x-cache: RefreshHit from cloudfront</code></p>
<p>RefreshHit ê³¼ì •:</p>
<ol>
<li>ìºì‹œ ë§Œë£Œ â†’ CloudFrontê°€ ì˜¤ë¦¬ì§„ì— <strong>ì¡°ê±´ë¶€ GET</strong> (If-None-Match/If-Modified-Since)</li>
<li>ì˜¤ë¦¬ì§„ ì‘ë‹µ:
â”œâ”€ <strong>304 Not Modified</strong> â†’ ê¸°ì¡´ ìºì‹œ ì¬ì‚¬ìš© (RefreshHit)
â””â”€ <strong>200 OK + ìƒˆ ì½˜í…ì¸ </strong> â†’ <strong>ìƒˆ ë²„ì „ìœ¼ë¡œ ìºì‹œ êµì²´</strong></li>
</ol>
<h3 id="no-cache-header-by-s3">no-cache header by S3<a aria-hidden="true" class="anchor-heading icon-link" href="#no-cache-header-by-s3"></a></h3>
<pre class="language-yaml"><code class="language-yaml">aws s3 sync .output/public s3<span class="token punctuation">:</span>//$PROJECT_NAME \
<span class="token punctuation">-</span><span class="token punctuation">-</span>exclude "<span class="token important">*"</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>include "<span class="token important">*.html"</span> \
<span class="token punctuation">-</span><span class="token punctuation">-</span>cache<span class="token punctuation">-</span>control 'no<span class="token punctuation">-</span>store<span class="token punctuation">,</span> no<span class="token punctuation">-</span>cache<span class="token punctuation">,</span> must<span class="token punctuation">-</span>revalidate' \
<span class="token punctuation">-</span><span class="token punctuation">-</span>delete
aws s3 sync .output/public s3<span class="token punctuation">:</span>//$PROJECT_NAME \
<span class="token punctuation">-</span><span class="token punctuation">-</span>exclude "<span class="token important">*"</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>include "<span class="token important">*.js"</span> \
<span class="token punctuation">-</span><span class="token punctuation">-</span>cache<span class="token punctuation">-</span>control 'no<span class="token punctuation">-</span>store<span class="token punctuation">,</span> no<span class="token punctuation">-</span>cache<span class="token punctuation">,</span> must<span class="token punctuation">-</span>revalidate' \
<span class="token punctuation">-</span><span class="token punctuation">-</span>delete
aws s3 sync .output/public s3<span class="token punctuation">:</span>//$PROJECT_NAME \
<span class="token punctuation">-</span><span class="token punctuation">-</span>exclude "<span class="token important">*.html"</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>exclude "<span class="token important">*.js"</span> \
<span class="token punctuation">-</span><span class="token punctuation">-</span>cache<span class="token punctuation">-</span>control 'max<span class="token punctuation">-</span>age=31536000<span class="token punctuation">,</span> immutable' \
<span class="token punctuation">-</span><span class="token punctuation">-</span>delete
</code></pre>
<h2 id="cloudfront-functions-ip-ê¸°ë°˜-ë¦¬ë‹¤ì´ë ‰ì…˜">CloudFront Functions IP ê¸°ë°˜ ë¦¬ë‹¤ì´ë ‰ì…˜<a aria-hidden="true" class="anchor-heading icon-link" href="#cloudfront-functions-ip-ê¸°ë°˜-ë¦¬ë‹¤ì´ë ‰ì…˜"></a></h2>
<pre class="language-js"><code class="language-js"><span class="token comment">// cloudfront-js-2.0</span>
<span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> request <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token property-access">request</span>
  <span class="token keyword">const</span> clientIp <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token property-access">viewer</span><span class="token punctuation">.</span><span class="token property-access">ip</span> <span class="token comment">// í´ë¼ì´ì–¸íŠ¸ IP ì£¼ì†Œ (IPv4 ë˜ëŠ” IPv6)</span>

  <span class="token keyword">const</span> allowedIPs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"xxx.xxx.xxx.xxx."</span><span class="token punctuation">]</span>

  <span class="token comment">// IPê°€ í—ˆìš© ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowedIPs<span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span>clientIp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      statusCode<span class="token operator">:</span> <span class="token number">302</span><span class="token punctuation">,</span>
      statusDescription<span class="token operator">:</span> <span class="token string">"Found"</span><span class="token punctuation">,</span>
      headers<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token dom variable">location</span><span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">"https://xxx.com/xxx"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"cache-control"</span><span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">"max-age=3600"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 1ì‹œê°„ ìºì‹± (ì„ íƒì )</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// í—ˆìš©: ì›ë˜ ìš”ì²­ ê·¸ëŒ€ë¡œ ì „ë‹¬ (ìºì‹±/ì˜¤ë¦¬ì§„ ì²˜ë¦¬ ì§„í–‰)</span>
  <span class="token keyword control-flow">return</span> request
<span class="token punctuation">}</span>
</code></pre>
<h2 id="spa-framework---s3---cloudfront-ë°°í¬-ì‹œ-404-error-ì²˜ë¦¬">SPA framework - S3 - CloudFront ë°°í¬ ì‹œ 404 error ì²˜ë¦¬<a aria-hidden="true" class="anchor-heading icon-link" href="#spa-framework---s3---cloudfront-ë°°í¬-ì‹œ-404-error-ì²˜ë¦¬"></a></h2>
<p>ì—†ëŠ” URIë¡œ ì ‘ê·¼ ì‹œ 403 errorê°€ ëœ¬ë‹¤. <a href="https://dexlee.tistory.com/189#:~:text=%ED%95%B4%EB%8B%B9%20url%20path%EB%A5%BC%20cloudFront%EC%97%90%EC%84%9C%20%EC%9D%B8%EC%8B%9D%ED%95%98%EC%A7%80%20%EB%AA%BB%ED%95%B4%EC%84%9C%20S3%EB%A1%9C%20%EC%9A%94%EC%B2%AD%EC%9D%B4%20%EA%B0%84%EB%8B%A4.%20public%EC%9D%B4%20%EC%95%84%EB%8B%88%EB%8B%88%20%EB%8B%B9%EC%97%B0%ED%9E%88%20permission%20denied%20%EC%97%90%EB%9F%AC%20%EB%B0%9C%EC%83%9D.">ì•„ë§ˆë„ í•´ë‹¹ url pathë¥¼ cloudFrontì—ì„œ ì¸ì‹í•˜ì§€ ëª»í•´ì„œ S3ë¡œ ìš”ì²­ì´ ê°€ê³  publicì´ ì•„ë‹ˆë‹ˆ permission denied ì—ëŸ¬</a>
<img src="/assets/images/what-i-struggled-brag-in/s3-cloudfront-404-error.webp"></p>
<p>cloudfrontì—ì„œ 403 errorë¥¼ SPA framework index.htmlë¡œ ì²˜ë¦¬í•˜ë„ë¡ í•´ì£¼ë©´ frameworkì—ì„œ 404 ì²˜ë¦¬í•´ ì¤Œ
<img src="/assets/images/what-i-struggled-brag-in/s3-cloudfront-404-custom-setting.webp" alt="CloudFront> ë°°í¬> id> ì˜¤ë¥˜ í˜ì´ì§€ ì‘ë‹µ í¸ì§‘> ì‚¬ìš©ì ì •ì˜ ...> 403, ì˜ˆ, ì‘ë‹µ í˜ì´ì§€ ê²½ë¡œ/index.html"></p>
<h2 id="github-actions-with-iam-roles">Github Actions with IAM Roles<a aria-hidden="true" class="anchor-heading icon-link" href="#github-actions-with-iam-roles"></a></h2>
<p><a href="https://docs.github.com/en/actions/security-for-github-actions/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services">Configuring OpenID Connect in Amazon Web Services</a></p>
<pre class="language-yml"><code class="language-yml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Configure AWS credentials
  <span class="token key atrule">uses</span><span class="token punctuation">:</span> aws<span class="token punctuation">-</span>actions/configure<span class="token punctuation">-</span>aws<span class="token punctuation">-</span>credentials@v4
  <span class="token key atrule">with</span><span class="token punctuation">:</span>
    <span class="token key atrule">role-to-assume</span><span class="token punctuation">:</span> arn<span class="token punctuation">:</span>aws<span class="token punctuation">:</span>iam<span class="token punctuation">:</span><span class="token punctuation">:</span>&#x3C;arn<span class="token punctuation">-</span>number<span class="token punctuation">></span><span class="token punctuation">:</span>role/&#x3C;role<span class="token punctuation">-</span>name<span class="token punctuation">></span>
    <span class="token key atrule">role-duration-seconds</span><span class="token punctuation">:</span> <span class="token number">900</span>
    <span class="token key atrule">aws-region</span><span class="token punctuation">:</span> &#x3C;region<span class="token punctuation">></span>
</code></pre>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"Version"</span><span class="token operator">:</span> <span class="token string">"2012-10-17"</span><span class="token punctuation">,</span>
  <span class="token property">"Statement"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
      <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"Service"</span><span class="token operator">:</span> <span class="token string">"s3.amazonaws.com"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"sts:AssumeRole"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"Effect"</span><span class="token operator">:</span> <span class="token string">"Allow"</span><span class="token punctuation">,</span>
      <span class="token property">"Principal"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"Federated"</span><span class="token operator">:</span> <span class="token string">"arn:aws:iam::&#x3C;arn-number>:oidc-provider/token.actions.githubusercontent.com"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"Action"</span><span class="token operator">:</span> <span class="token string">"sts:AssumeRoleWithWebIdentity"</span><span class="token punctuation">,</span>
      <span class="token property">"Condition"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"StringEquals"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"token.actions.githubusercontent.com:aud"</span><span class="token operator">:</span> <span class="token string">"sts.amazonaws.com"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"StringLike"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"token.actions.githubusercontent.com:sub"</span><span class="token operator">:</span> <span class="token string">"repo:&#x3C;org-name>/&#x3C;repo-name>:*"</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<hr>
<strong>Backlinks</strong>
<ul>
<li><a href="/notes/6645fjtiqxtko03nuccgjj2">What I struggled ğŸ§—/ğŸ“£ brag In</a></li>
</ul>