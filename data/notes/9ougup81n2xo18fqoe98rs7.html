<h1 id="send-data-from-the-application-to-the-cypress-test">Send Data From The Application To The Cypress Test<a aria-hidden="true" class="anchor-heading icon-link" href="#send-data-from-the-application-to-the-cypress-test"></a></h1>
<p><a href="https://glebbahmutov.com/blog/send-data-to-the-test/">https://glebbahmutov.com/blog/send-data-to-the-test/</a></p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// public/app.js</span>

<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token property-access">phone</span><span class="token punctuation">)</span> data<span class="token punctuation">.</span><span class="token property-access">phone</span> <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token property-access">phone</span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[^\d]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// clean up the phone number by removing all non-digit characters</span>

<span class="token dom variable">window</span><span class="token operator">?.</span><span class="token maybe-class-name">Cypress</span><span class="token operator">?.</span>track<span class="token operator">?.</span><span class="token punctuation">(</span><span class="token string">"form"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Of course, we need to create the <code>Cypress.track</code> method ourselves. We also need to clean it up to avoid accidentally leaking it from one test to another. Using <code>beforeEach</code> and <code>afterEach</code> hooks works well for this purpose.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// cypress/integration/spec.js</span>
<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token maybe-class-name">Cypress</span><span class="token punctuation">.</span><span class="token property-access">track</span> <span class="token operator">=</span> cy<span class="token punctuation">.</span><span class="token method function property-access">stub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword module">as</span><span class="token punctuation">(</span><span class="token string">"track"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// clean up Cypress.track property</span>
  <span class="token keyword">delete</span> <span class="token maybe-class-name">Cypress</span><span class="token punctuation">.</span><span class="token property-access">track</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Now we can finish our test. We can confirm the <a href="https://on.cypress.io/stub">stub</a> function <code>Cypress.track</code> was called with the first argument "form". From the first such call, we can grab the <em>second</em> argument, which should be an object. We can confirm some properties of the object, and then also use it to confirm what the application sent to the server.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// cypress/integration/spec.js</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"sends the expected form"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  cy<span class="token punctuation">.</span><span class="token method function property-access">visit</span><span class="token punctuation">(</span><span class="token string">"public/index.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  cy<span class="token punctuation">.</span><span class="token method function property-access">intercept</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"/api/v1/message"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword module">as</span><span class="token punctuation">(</span><span class="token string">"post"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  cy<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"form"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">within</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    cy<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"input[name=name]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">type</span><span class="token punctuation">(</span><span class="token string">"John Doe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cy<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"input[name=email]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">type</span><span class="token punctuation">(</span><span class="token string">"joe@doe.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cy<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"input[name=phone]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">type</span><span class="token punctuation">(</span><span class="token string">"+1 (555) 555-5555"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cy<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"input[name=message]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">type</span><span class="token punctuation">(</span><span class="token string">"Hello World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cy<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"input[type=submit]"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// hmm, how do we verify the request as sent by the application?</span>
  cy<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"@track"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">should</span><span class="token punctuation">(</span><span class="token string">"be.calledWith"</span><span class="token punctuation">,</span> <span class="token string">"form"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">its</span><span class="token punctuation">(</span><span class="token string">"firstCall.args.1"</span><span class="token punctuation">)</span>
    <span class="token comment">// you can confirm some properties of the sent data</span>
    <span class="token comment">// Tip: use https://github.com/bahmutov/cy-spok</span>
    <span class="token comment">// for similar object and array assertions</span>
    <span class="token punctuation">.</span><span class="token method function property-access">should</span><span class="token punctuation">(</span><span class="token string">"deep.include"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">"John Doe"</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">"Hello World"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      cy<span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// confirm the network request was sent correctly</span>
      cy<span class="token punctuation">.</span><span class="token method function property-access">wait</span><span class="token punctuation">(</span><span class="token string">"@post"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token method function property-access">its</span><span class="token punctuation">(</span><span class="token string">"request.body"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> timeout<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token method function property-access">should</span><span class="token punctuation">(</span><span class="token string">"deep.equal"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>