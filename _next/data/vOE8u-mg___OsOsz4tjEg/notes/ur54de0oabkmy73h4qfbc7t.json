{"pageProps":{"note":{"id":"ur54de0oabkmy73h4qfbc7t","title":"Five Tips For a Healthier Postgres Database in the New Year","desc":"","updated":1676252268292,"created":1676252126029,"custom":{},"fname":"dev.DB.postgres.five-tips-for-a-healthier-postgres-database-in-the-new-year","type":"note","vault":{"fsPath":"vault"},"contentHash":"6210eb162cd5fdf82bbf915e89e8b0d6","links":[],"anchors":{"set-a-statement-timeout":{"type":"header","text":"Set a statement timeout","value":"set-a-statement-timeout","line":10,"column":0,"depth":2},"ensure-you-have-query-tracking":{"type":"header","text":"Ensure you have query tracking","value":"ensure-you-have-query-tracking","line":20,"column":0,"depth":2},"log-slow-running-queries":{"type":"header","text":"Log slow running queries","value":"log-slow-running-queries","line":32,"column":0,"depth":2},"improve-your-connection-management":{"type":"header","text":"Improve your connection management","value":"improve-your-connection-management","line":38,"column":0,"depth":2},"find-your-goldilocks-range-for-indexes":{"type":"header","text":"Find your goldilocks range for indexes","value":"find-your-goldilocks-range-for-indexes","line":51,"column":0,"depth":2},"heres-to-less-database-problems-in-2022":{"type":"header","text":"Here's to less database problems in 2022","value":"heres-to-less-database-problems-in-2022","line":62,"column":0,"depth":2},"pg_stat_statements-is-not-free":{"type":"header","text":"pg_stat_statements is not free","value":"pg_stat_statements-is-not-free","line":70,"column":0,"depth":2}},"children":[],"parent":"xyg5ao6vugkef44ahxssq60","data":{}},"body":"<h1 id=\"five-tips-for-a-healthier-postgres-database-in-the-new-year\">Five Tips For a Healthier Postgres Database in the New Year<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#five-tips-for-a-healthier-postgres-database-in-the-new-year\"></a></h1>\n<blockquote>\n<p><a href=\"https://www.crunchydata.com/blog/five-tips-for-a-healthier-postgres-database-in-the-new-year\">https://www.crunchydata.com/blog/five-tips-for-a-healthier-postgres-database-in-the-new-year</a></p>\n</blockquote>\n<h2 id=\"set-a-statement-timeout\">Set a statement timeout<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#set-a-statement-timeout\"></a></h2>\n<p>Long running (usually unintentionally so) queries can wreck havoc on a database. They can hold up other queries, replication, or other database processes. Most applications are designed for typical queries to run in a few milliseconds. You may have long running queries for reporting, but these are best offloaded to a read replica for reporting and analytics. To prevent those long running queries you can set a <code>statement_timeout</code>:</p>\n<pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">DATABASE</span> mydatabase <span class=\"token keyword\">SET</span> statement_timeout <span class=\"token operator\">=</span> <span class=\"token string\">'60s'</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p><em>For good measure you may also want to set your <code>idle_in_transaction</code> timeout as well, which will cancel long running transaction that are no longer performing work.</em></p>\n<h2 id=\"ensure-you-have-query-tracking\">Ensure you have query tracking<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#ensure-you-have-query-tracking\"></a></h2>\n<p>Understanding what is going on inside your database is always a good idea. Which queries are slow? Which queries are run too many times? Enter the most useful Postgres extension that exists: <code>pg_stat_statements</code>.</p>\n<p>Pg_stat_statements records every query that runs against your database, parameterizes it, and then records a variety of metrics about it. That makes it easy to answer the above questions. If you don't have it installed already do it today by running:</p>\n<pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> EXTENSION pg_stat_statements<span class=\"token punctuation\">;</span>\n</code></pre>\n<p>Once it's in place you can take a look at our <a href=\"https://www.crunchydata.com/blog/tentative-smarter-query-optimization-in-postgres-starts-with-pg_stat_statements\">deep dive</a> on all the insights it can show you.</p>\n<h2 id=\"log-slow-running-queries\">Log slow running queries<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#log-slow-running-queries\"></a></h2>\n<p>While <code>pg_stat_statements</code> is useful for looking at frequently run queries or queries that may always be slow, sometimes you have extreme outlier queries. With <code>pg_stat_statements</code> you may review your queries every few months. Meanwhile your Postgres logs likely <a href=\"https://docs.crunchybridge.com/how-to/logging/?CrunchyAnonId=caesivkkyecnldlsqpittjuniiyazdbraadbozbw\">feed into</a> some other central system that you are monitoring daily and have alerting on. Catching these slow outlier queries early can be a great canary for things you should quickly move off to a read-replica for scaling or that you should rewrite to be more efficient. You can <a href=\"https://www.crunchydata.com/blog/logging-tips-for-postgres-featuring-your-slow-queries\">log all slow queries</a> that take over a certain time with <code>log_min_duration_statement</code>.</p>\n<p>For many SaaS applications setting your <code>log_min_duration_statement</code> to something like 1 second: <code>1s</code> or even as low as 100 milliseconds: <code>100ms</code> can be a big asset.</p>\n<h2 id=\"improve-your-connection-management\">Improve your connection management<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#improve-your-connection-management\"></a></h2>\n<p>If you're using Rails, Django, Hibernate or any other framework/ORM you've likely set a connection pool in your application settings for your database. That connection pool is likely reducing latency in new connections to your database, but is also limiting the performance available for your database. On versions prior to Postgres 14, connections consumed extra overhead leaving <code>idle</code> connections as wasted space. The solution to this is not to replace your in app connection pooling, but rather add a server side connection pooler such as PgBouncer. With PgBouncer you're able to scale to 10s of thousands of connections with no problem. You can take a quick look at your existing database to see if PgBouncer would help:</p>\n<pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n       state\n<span class=\"token keyword\">FROM</span> pg_stat_activity\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<p>If you see <code>idle</code> is above 20 it's recommended to explore using PgBouncer. Adding PgBouncer is often a no brainer to get better performance without any heavy refactoring required. And to make it easy if you're on <a href=\"https://docs.crunchybridge.com/how-to/pgbouncer/?CrunchyAnonId=caesivkkyecnldlsqpittjuniiyazdbraadbozbw\">Crunchy Bridge</a> it's already available to you.</p>\n<h2 id=\"find-your-goldilocks-range-for-indexes\">Find your goldilocks range for indexes<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#find-your-goldilocks-range-for-indexes\"></a></h2>\n<p>There seems to be a common lifecycle of indexes within applications. First you start off with almost none, maybe a few on primary keys. Then you start adding them, one by one, two by two, until you've got quite a few indexes for most any query you can run. Something is slow? Throw an index at it. What you end up with is some contention on overall throughput of your database, and well a lot of indexes that became a tangled ball of yarn over time.</p>\n<p>We've got a slew of write-ups and guides on indexes and unfortunately there isn't a \"this is your one thing to read and your done\". But a few key things and you can be in a better place:</p>\n<ul>\n<li><a href=\"https://www.crunchydata.com/blog/three-easy-things-to-remember-about-postgres-indexes\">A primer on indexes</a></li>\n<li><a href=\"https://www.crunchydata.com/blog/cleaning-up-your-postgres-database\">Check for unused indexes</a></li>\n<li><a href=\"https://learn.crunchydata.com/postgresql-devel/courses/basics/indextypes\">Index types in Postgres</a></li>\n<li><a href=\"https://learn.crunchydata.com/postgresql-devel/courses/basics/introindex\">A starter lesson on indexes</a></li>\n</ul>\n<h2 id=\"heres-to-less-database-problems-in-2022\">Here's to less database problems in 2022<a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#heres-to-less-database-problems-in-2022\"></a></h2>\n<p>Our goal at Crunchy is to make Postgres great. One part of that is helping our customers understand their database and providing them with support and guidance for all their Postgres needs.</p>\n<p>With <a href=\"https://www.crunchydata.com/products/crunchy-bridge/\">Crunchy Bridge</a> we're working towards making all of the above easier, so it's one less thing you have to worry about. We've already had customers migrate and see <a href=\"https://www.crunchydata.com/case-studies/rival-iq/\">3-5x performance improvement</a> over their existing cloud providers. We know if you're here you're already a fan of Postgres. In this coming year we look forward to making the developer experience of Postgres better than it's ever been.</p>\n<hr>\n<h2 id=\"pg_stat_statements-is-not-free\"><a href=\"https://news.ycombinator.com/item?id=34754445\">pg_stat_statements is not free</a><a aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#pg_stat_statements-is-not-free\"></a></h2>\n<p>pg_stat_statements is useful, but it isn't completely free, e.g. <a href=\"https://www.alibabacloud.com/blog/postgresql-v12-how-pg-stat-statements-causes-high-concurrency-performance-issues_597790\">https://www.alibabacloud.com/blog/postgresql-v12-how-pg-stat-statements-causes-high-concurrency-performance-issues_597790</a> (admittedly from pg12, which is three major versions ago).</p>\n<p>Most people should probably leave it enabled, but if you have a database with a very defined and understood query pattern, then it might be worth running <em>perf</em> and checking if it is costing you.</p>","noteIndex":{"id":"Iy0MoL0KnL55Br3AfTS2C","title":"Luke","desc":"","updated":1761796791487,"created":1644449449778,"custom":{"nav_order":0,"permalink":"/"},"fname":"root","type":"note","vault":{"fsPath":"vault"},"contentHash":"4e745570ca97988a0362cb939b760952","links":[{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"life-tips","position":{"start":{"line":41,"column":5,"offset":2603},"end":{"line":41,"column":29,"offset":2627},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"life-tips","anchorHeader":"wodenokoto"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-read-in.2025","alias":"What I read in 2025","position":{"start":{"line":70,"column":3,"offset":4333},"end":{"line":70,"column":54,"offset":4384},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-read-in.2025"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-read-in.2024","alias":"2024","position":{"start":{"line":71,"column":5,"offset":4389},"end":{"line":71,"column":41,"offset":4425},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-read-in.2024"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-read-in.2023","alias":"2023","position":{"start":{"line":72,"column":5,"offset":4430},"end":{"line":72,"column":41,"offset":4466},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-read-in.2023"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-read-in.2022","alias":"2022","position":{"start":{"line":73,"column":5,"offset":4471},"end":{"line":73,"column":41,"offset":4507},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-read-in.2022"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-struggled-brag-in","position":{"start":{"line":79,"column":3,"offset":4643},"end":{"line":79,"column":39,"offset":4679},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-struggled-brag-in"}}],"anchors":{"what-i-read-in-past":{"type":"header","text":"What I read in past","value":"what-i-read-in-past","line":74,"column":0,"depth":2}},"children":["zd4mq442jike0pr0wba1u3m","6hzeqsofq67gdk88flxlkhp","778ijii93yu5uwnrwmn5zi4","g1fngdjl25nes6fs3lip602","ZbdkdApFqLdks4Moq92R9","uoc5hhki3o4py15cesddu8q","9qf7j06jtdkm6rnx9ymvwb0","5zn10cvj7ajy2gh2is5nqmg","4qo9ma0z0yu1czns6pxl7y5","ok0e729ho7o09xetujkxc0m","GR5x8HnNFEN6fU2UBSEIK","yirtnlj8q24yutcf3ss1xqy","eq0wc6t7wl2wv221yb68ro4","7x2fnv4j6gxts08qk0jguny","ettkt3iClONnxpbGwBVLl","7l4knev6v613tbuoskvmbdg","hvh5bud6yp7dc89tuh95tr9","4fvoqrplw0cweo554usbjos","f8qsfql0a9v8thpeo82udfa","1swsbrhqi9jk41v9eodyi5q","SQqYupi6EFddTerBA8RRD","hjNeNc1F2JUh0lTWanH4h","qf0l4wbrc9jgooyzexmbq5v","uur1lkol353z9vfeqb3n5bv","cd9n1czq3ursgkby985wkmm","k1sr43vwnfqztwc0s43pkcf","wfde75rhdvq2yfa2zy2q6rv","rjcmdv60jokmbw6zoq8u2ef","ujapvww8o6v3kpmlhtryq4k","pkwewou9d5e8ystswn1j2b4"],"parent":null,"data":{},"body":"\nHi there 👋. I'm a Front-end developer.\n\n---\n\n- 단순함과 꾸준함은 가장 쉬우면서도 지키기 어려운 원칙.\n\n- 🥱 -> 🤔💡🌱 - [On The Death of Daydreaming](https://www.afterbabel.com/p/on-the-death-of-daydreaming)\n  - boredom -> easy fun -> art -> profit?\n\n> I've often described my motivation for building software to others using imagery: I like to go find a secluded beach, build a large, magnificent sand castle, and then walk away. Will anyone notice? Probably not. Will the waves eventually destroy it? Yep. Did I still get immense satisfaction? Absolutely. - [aliasxneo](https://news.ycombinator.com/item?id=41497113)\n\n> We love to see the process, not just the result. The imperfections in your work can be beautiful if they show your struggle for perfection, not a lack of care. - [ralphammer](https://ralphammer.com/is-perfection-boring/)\n\n> Simplicity, even if it sacrifices some ideal functionality has better survival characteristics than the-right-thing. - [The Rise of Worse is Better](https://www.dreamsongs.com/RiseOfWorseIsBetter.html)\n\n> [Roberto Blake was talking about making 100 crappy videos](https://www.youtube.com/watch?v=OnUBaQ1Sp_E) to get better over time. Putting in the reps and improving a little bit each time.\n>\n> Putting in the work without expecting any external reward at first (eg views, followers, likes, etc) will pay off in the long run. - [100 Scrappy Things](https://www.florin-pop.com/blog/100-scrappy-things/)\n\n> Make the difficult habitual, the habitual easy, and the easy beautiful. - [Constantin S. Stanislavski](https://www.goodreads.com/quotes/7102271-make-the-difficult-habitual-the-habitual-easy-and-the-easy)\n\n> A good match is a **structured** dance, where players aim to **score** while they are following well-defined **rules**. This **freedom within a structure** is what makes it fun. - [ralphammer](https://ralphammer.com/how-to-get-started/)\n\n- [Pivot Points](https://longform.asmartbear.com/pivot-points/)\n\n  - non-judgmental aspects of personality that can be strengths in some contexts and weaknesses in others\n  - Pivot Points are fixed in the short term\n\n- [Hedged Bets](https://longform.asmartbear.com/predict-the-future/#hedged-bets)\n  - trading slightly less maximum upside for predictable, net-positive outcomes.\n\n> “Motivation often comes after starting, not before. Action produces momentum.”\n> [When you start a new habit, it should take less than two minutes to do.](https://jamesclear.com/how-to-stop-procrastinating)\n>\n> - James Clear\n\n> Focus is more about **not** keeping busy when you need to wait for something.  \n> Eat the boredom for a minute.\n>\n> - [[life-tips#wodenokoto]]\n\n> [4 minutes run hard enough to push heart rate to 90%, 3 minutes recover, repeat 4 times](https://news.ycombinator.com/item?id=34213181)\n>\n> - https://www.ntnu.edu/cerg/advice\n> - [Get running with Couch to 5K](https://www.nhs.uk/live-well/exercise/running-and-aerobic-exercises/get-running-with-couch-to-5k/)\n\n> [recommended routine - bodyweightfitness](https://www.reddit.com/r/bodyweightfitness/wiki/kb/recommended_routine/) - I Don't Have This Much Time!\n>\n> - Don't workout at all (saves anywhere from 20 to 60 minutes, but really, really, really, really, really, really, really, really, really not recommended)\n\n> 도무지 읽히지 않는 책 앞에서 내가 택한 방법은 펼쳐진 페이지 앞에서 멍때리기이다. 다르게 표현하면 이렇다. 펼쳐진 두 페이지 앞에서 오래 머물기.\n>\n> 책을 펼쳐놓는 것으로 충분하다. 읽지 못해도 좋다. 매일 정해진 진도를 나가야 하는 학교 수업이 아니니까. 하지만 읽지 않아도 괜찮다고 해서 펼쳐두지조차 않으면 곤란하다. 가능한 한 자주 책을 펼쳐두도록 하자. 전혀 읽지 않고 멍하니 바라보고 있다가 다시 덮게 되더라도\n>\n> - 막막한 독서. 시로군. P.10~13\n\n> I think it should be everyone's primary focus to sleep well, drink water, get outside, get active, and eat generally decently. I hate to say it, but if you're not eating a good amount of vegetables and fruit, decent protein, sleep, etc, no amount of XYZ will catch up to that detriment. - [CE02](https://news.ycombinator.com/item?id=35056071)\n\n> My real battle is doing good versus doing nothing. - [Deirdre Sullivan](https://www.npr.org/2005/08/08/4785079/always-go-to-the-funeral)\n\n[Kind Engineering](https://kind.engineering/) - How To Engineer Kindness\n\n> Sometimes magic is just someone spending more time on something than anyone else might reasonably expect. - [Teller](https://www.goodreads.com/quotes/6641527-sometimes-magic-is-just-someone-spending-more-time-on-something)\n\n---\n\n## What I read in past\n\n- [[What I read in 2025|journal.what-i-read-in.2025]]\n  - [[2024|journal.what-i-read-in.2024]]\n  - [[2023|journal.what-i-read-in.2023]]\n  - [[2022|journal.what-i-read-in.2022]]\n- 📝 [Gists](https://gist.github.com/Luke-SNAW)\n- 📜 [Journals](https://luke-snaw.github.io/Luke-SNAW__netlify-CMS.github.io/)\n\n---\n\n- [[journal.what-i-struggled-brag-in]]\n"},"collectionChildren":null,"customHeadContent":null,"config":{"version":5,"dev":{"enablePreviewV2":true},"commands":{"lookup":{"note":{"selectionMode":"extract","confirmVaultOnCreate":true,"vaultSelectionModeOnCreate":"smart","leaveTrace":false,"bubbleUpCreateNew":true,"fuzzThreshold":0.2}},"randomNote":{},"insertNoteLink":{"aliasMode":"none","enableMultiSelect":false},"insertNoteIndex":{"enableMarker":false},"copyNoteLink":{"aliasMode":"title"},"templateHierarchy":"template"},"workspace":{"vaults":[{"fsPath":"vault"}],"journal":{"dailyDomain":"daily","name":"journal","dateFormat":"y.MM.dd","addBehavior":"childOfDomain"},"scratch":{"name":"scratch","dateFormat":"y.MM.dd.HHmmss","addBehavior":"asOwnDomain"},"task":{"name":"","dateFormat":"","addBehavior":"childOfCurrent","statusSymbols":{"":" ","wip":"w","done":"x","assigned":"a","moved":"m","blocked":"b","delegated":"l","dropped":"d","pending":"y"},"prioritySymbols":{"H":"high","M":"medium","L":"low"},"todoIntegration":false,"createTaskSelectionType":"selection2link","taskCompleteStatus":["done","x"]},"graph":{"zoomSpeed":1,"createStub":false},"enableAutoCreateOnDefinition":false,"enableXVaultWikiLink":false,"enableRemoteVaultInit":true,"enableUserTags":false,"enableHashTags":true,"workspaceVaultSyncMode":"noCommit","enableAutoFoldFrontmatter":false,"enableEditorDecorations":true,"maxPreviewsCached":10,"maxNoteLength":204800,"dendronVersion":"0.115.0","enableFullHierarchyNoteTitle":false,"enablePersistentHistory":false},"preview":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enablePrettyRefs":true,"enableKatex":true,"automaticallyShowPreview":false,"enableFrontmatterTags":true,"enableHashesForFMTags":false},"publishing":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enablePrettyRefs":true,"enableKatex":true,"copyAssets":true,"siteHierarchies":["root"],"writeStubs":false,"siteRootDir":"docs","seo":{"title":"Luke SNAW","description":"Personal knowledge space"},"github":{"enableEditLink":false,"editLinkText":"Edit this page on GitHub","editBranch":"main","editViewMode":"tree"},"enableSiteLastModified":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableRandomlyColoredTags":true,"enableTaskNotes":true,"enablePrettyLinks":true,"searchMode":"lookup","siteUrl":"https://luke-snaw.github.io/","duplicateNoteBehavior":{"action":"useVault","payload":["vault"]},"siteFaviconPath":"favicon.ico","siteIndex":"root"}}},"__N_SSG":true}