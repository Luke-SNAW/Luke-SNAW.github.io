<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/favicon.ico"/><title>Tasks, microtasks, queues and schedules</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="description" content="Personal knowledge space"/><meta property="og:title" content="Tasks, microtasks, queues and schedules"/><meta property="og:description" content="Personal knowledge space"/><meta property="og:url" content="https://luke-snaw.github.io//notes/x97lshfu1d3p5kjjbki4hhn/"/><meta property="og:type" content="article"/><meta property="article:published_time" content="7/5/2022"/><meta property="article:modified_time" content="7/5/2022"/><link rel="canonical" href="https://luke-snaw.github.io//notes/x97lshfu1d3p5kjjbki4hhn/"/><meta name="next-head-count" content="14"/><link rel="preload" href="/_next/static/css/8e7b7e4bce421c0a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8e7b7e4bce421c0a.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-3d209faeb64f2f97.js" defer=""></script><script src="/_next/static/chunks/framework-28c999baf2863c3d.js" defer=""></script><script src="/_next/static/chunks/main-104451f3d1a5c4bc.js" defer=""></script><script src="/_next/static/chunks/pages/_app-9d8e0603730b15a3.js" defer=""></script><script src="/_next/static/chunks/935-4dee79e80b8641c6.js" defer=""></script><script src="/_next/static/chunks/6-50972def09142ee2.js" defer=""></script><script src="/_next/static/chunks/pages/notes/%5Bid%5D-78d472fa3b924116.js" defer=""></script><script src="/_next/static/wirstT2ztC8OQsbzKjhvw/_buildManifest.js" defer=""></script><script src="/_next/static/wirstT2ztC8OQsbzKjhvw/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><section class="ant-layout" style="width:100%;min-height:100%"><header class="ant-layout-header" style="position:fixed;isolation:isolate;z-index:1;width:100%;border-bottom:1px solid #d4dadf;height:64px;padding:0 24px 0 2px"><div class="ant-row ant-row-center" style="max-width:992px;justify-content:space-between;margin:0 auto"><div style="display:flex" class="ant-col ant-col-xs-20 ant-col-sm-4"></div><div class="ant-col gutter-row ant-col-xs-0 ant-col-sm-20 ant-col-md-20 ant-col-lg-19"><div class="ant-select ant-select-lg ant-select-auto-complete ant-select-single ant-select-allow-clear ant-select-show-search" style="width:100%"><div class="ant-select-selector"><span class="ant-select-selection-search"><input type="search" autoComplete="off" class="ant-select-selection-search-input" role="combobox" aria-haspopup="listbox" aria-owns="undefined_list" aria-autocomplete="list" aria-controls="undefined_list" aria-activedescendant="undefined_list_0" value=""/></span><span class="ant-select-selection-placeholder">For full text search please use the &#x27;?&#x27; prefix. e.g. ? Onboarding</span></div></div></div><div style="display:none;align-items:center;justify-content:center" class="ant-col ant-col-xs-4 ant-col-sm-4 ant-col-md-0 ant-col-lg-0"><span role="img" aria-label="menu" style="font-size:24px" tabindex="-1" class="anticon anticon-menu"><svg viewBox="64 64 896 896" focusable="false" data-icon="menu" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></span></div></div></header><section class="ant-layout" style="margin-top:64px;display:flex;flex-direction:row"><div class="site-layout-sidebar" style="flex:0 0 auto;width:calc(max((100% - 992px) / 2, 0px) + 200px);min-width:200px;padding-left:calc((100% - 992px) / 2)"><aside class="ant-layout-sider ant-layout-sider-dark" style="position:fixed;overflow:auto;height:calc(100vh - 64px);background-color:transparent;flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"></div></aside></div><main class="ant-layout-content side-layout-main" style="max-width:1200px;min-width:0;display:block"><div style="padding:0 24px"><div class="main-content" role="main"><div class="ant-row"><div class="ant-col ant-col-24"><div class="ant-row" style="margin-left:-10px;margin-right:-10px"><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-24 ant-col-md-18"><div><h1 id="tasks-microtasks-queues-and-schedules">Tasks, microtasks, queues and schedules<a aria-hidden="true" class="anchor-heading icon-link" href="#tasks-microtasks-queues-and-schedules"></a></h1>
<blockquote>
<p><a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/">https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/</a></p>
</blockquote>
<p>When I told my colleague <a href="https://twitter.com/gauntface">Matt Gaunt</a> I was thinking of writing a piece on microtask queueing and execution within the browser's event loop, he said "I'll be honest with you Jake, I'm not going to read that". Well, I've written it anyway, so we're all going to sit here and enjoy it, ok?</p>
<p>Actually, if video's more your thing, <a href="https://twitter.com/philip_roberts">Philip Roberts</a> gave a <a href="https://www.youtube.com/watch?v=8aGhZQkoFbQ">great talk at JSConf on the event loop</a> - microtasks aren't covered, but it's a great introduction to the rest. Anyway, on with the show…</p>
<p>Take this little bit of JavaScript:</p>
<pre class="language-js"><code class="language-js"><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"script start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"setTimeout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"promise1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"promise2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"script end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>In what order should the logs appear?</p>
<h2 id="try-it">Try it<a aria-hidden="true" class="anchor-heading icon-link" href="#try-it"></a></h2>
<p>The correct answer: <code>script start</code>, <code>script end</code>, <code>promise1</code>, <code>promise2</code>, <code>setTimeout</code>, but it's pretty wild out there in terms of browser support.</p>
<p>Microsoft Edge, Firefox 40, iOS Safari and desktop Safari 8.0.8 log <code>setTimeout</code> before <code>promise1</code> and <code>promise2</code> - although it appears to be a race condition. This is really weird, as Firefox 39 and Safari 8.0.7 get it consistently right.</p>
<h2 id="why-this-happens">Why this happens<a aria-hidden="true" class="anchor-heading icon-link" href="#why-this-happens"></a></h2>
<p>To understand this you need to know how the event loop handles tasks and microtasks. This can be a lot to get your head around the first time you encounter it. Deep breath…</p>
<p>Each 'thread' gets its own <strong>event loop</strong>, so each web worker gets its own, so it can execute independently, whereas all windows on the same origin share an event loop as they can synchronously communicate. The event loop runs continually, executing any tasks queued. An event loop has multiple task sources which guarantees execution order within that source (specs <a href="https://w3c.github.io/IndexedDB/#database-access-task-source">such as IndexedDB</a> define their own), but the browser gets to pick which source to take a task from on each turn of the loop. This allows the browser to give preference to performance sensitive tasks such as user-input. Ok ok, stay with me…</p>
<p><strong>Tasks</strong> are scheduled so the browser can get from its internals into JavaScript/DOM land and ensures these actions happen sequentially. Between tasks, the browser <em>may</em> render updates. Getting from a mouse click to an event callback requires scheduling a task, as does parsing HTML, and in the above example, <code>setTimeout</code>.</p>
<p><code>setTimeout</code> waits for a given delay then schedules a new task for its callback. This is why <code>setTimeout</code> is logged after <code>script end</code>, as logging <code>script end</code> is part of the first task, and <code>setTimeout</code> is logged in a separate task. Right, we're almost through this, but I need you to stay strong for this next bit…</p>
<p><strong>Microtasks</strong> are usually scheduled for things that should happen straight after the currently executing script, such as reacting to a batch of actions, or to make something async without taking the penalty of a whole new task. The microtask queue is processed after callbacks as long as no other JavaScript is mid-execution, and at the end of each task. Any additional microtasks queued during microtasks are added to the end of the queue and also processed. Microtasks include mutation observer callbacks, and as in the above example, promise callbacks.</p>
<p>Once a promise settles, or if it has already settled, it queues a <em>microtask</em> for its reactionary callbacks. This ensures promise callbacks are async even if the promise has already settled. So calling <code>.then(yey, nay)</code> against a settled promise immediately queues a microtask. This is why <code>promise1</code> and <code>promise2</code> are logged after <code>script end</code>, as the currently running script must finish before microtasks are handled. <code>promise1</code> and <code>promise2</code> are logged before <code>setTimeout</code>, as microtasks always happen before the next task.</p>
<p>So, step by step:</p>
<pre class="language-js"><code class="language-js"><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"script start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"setTimeout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"promise1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"promise2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"script end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Tasks</p>
<p>Run script</p>
<p>setTimeout callback</p>
<p>Microtasks</p>
<p>Promise then</p>
<p>Promise then</p>
<p>JS stack</p>
<p>Log</p>
<p>script start</p>
<p>script end</p>
<p>promise1</p>
<p>promise2</p>
<p>setTimeout</p>
<p>Yes that's right, I created an animated step-by-step diagram. How did you spend <em>your</em> Saturday? Went out in the <em>sun</em> with your <em>friends</em>? Well <em>I didn't</em>. Um, in case it isn't clear from my amazing UI design, click the arrows above to advance.</p>
<h3 id="what-are-some-browsers-doing-differently">What are some browsers doing differently?<a aria-hidden="true" class="anchor-heading icon-link" href="#what-are-some-browsers-doing-differently"></a></h3>
<p>Some browsers log <code>script start</code>, <code>script end</code>, <code>setTimeout</code>, <code>promise1</code>, <code>promise2</code>. They're running promise callbacks after <code>setTimeout</code>. It's likely that they're calling promise callbacks as part of a new task rather than as a microtask.</p>
<p>This is sort-of excusable, as promises come from ECMAScript rather than HTML. ECMAScript has the concept of "jobs" which are similar to microtasks, but the relationship isn't explicit aside from <a href="https://esdiscuss.org/topic/the-initialization-steps-for-web-browsers#content-16">vague mailing list discussions</a>. However, the general consensus is that promises should be part of the microtask queue, and for good reason.</p>
<p>Treating promises as tasks leads to performance problems, as callbacks may be unnecessarily delayed by task-related things such as rendering. It also causes non-determinism due to interaction with other task sources, and can break interactions with other APIs, but more on that later.</p>
<p>Here's <a href="https://connect.microsoft.com/IE/feedback/details/1658365">an Edge ticket</a> for making promises use microtasks. WebKit nightly is doing the right thing, so I assume Safari will pick up the fix eventually, and it appears to be fixed in Firefox 43.</p>
<p>Really interesting that both Safari and Firefox suffered a regression here that's since been fixed. I wonder if it's just a coincidence.</p>
<h2 id="how-to-tell-if-something-uses-tasks-or-microtasks">How to tell if something uses tasks or microtasks<a aria-hidden="true" class="anchor-heading icon-link" href="#how-to-tell-if-something-uses-tasks-or-microtasks"></a></h2>
<p>Testing is one way. See when logs appear relative to promises &#x26; <code>setTimeout</code>, although you're relying on the implementation to be correct.</p>
<p>The certain way, is to look up the spec. For instance, <a href="https://html.spec.whatwg.org/multipage/webappapis.html#timer-initialisation-steps">step 14 of <code>setTimeout</code></a> queues a task, whereas <a href="https://dom.spec.whatwg.org/#queue-a-mutation-record">step 5 of queuing a mutation record</a> queues a microtask.</p>
<p>As mentioned, in ECMAScript land, they call microtasks "jobs". In <a href="https://www.ecma-international.org/ecma-262/6.0/#sec-performpromisethen">step 8.a of <code>PerformPromiseThen</code></a>, <code>EnqueueJob</code> is called to queue a microtask.</p>
<p>Now, let's look at a more complicated example. <em>Cut to a concerned apprentice</em> "No, they're not ready!". Ignore him, you're ready. Let's do this…</p>
<h2 id="level-1-bossfight">Level 1 bossfight<a aria-hidden="true" class="anchor-heading icon-link" href="#level-1-bossfight"></a></h2>
<p>Before writing this post I'd have gotten this wrong. Here's a bit of html:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>outer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>div</span><span class="token punctuation">></span></span>
</code></pre>
<p>Given the following JS, what will be logged if I click <code>div.inner</code>?</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// Let's get hold of those elements</span>
<span class="token keyword">var</span> outer <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">".outer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> inner <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">".inner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Let's listen for attribute changes on the</span>
<span class="token comment">// outer element</span>
<span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"mutate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">observe</span><span class="token punctuation">(</span>outer<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  attributes<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Here's a click listener…</span>
<span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"promise"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  outer<span class="token punctuation">.</span><span class="token method function property-access">setAttribute</span><span class="token punctuation">(</span><span class="token string">"data-random"</span><span class="token punctuation">,</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// …which we'll attach to both elements</span>
inner<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> onClick<span class="token punctuation">)</span><span class="token punctuation">;</span>
outer<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> onClick<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Go on, give it a go before peeking at the answer. <em>Clue:</em> Logs can happen more than once.</p>
<h2 id="test-it">Test it<a aria-hidden="true" class="anchor-heading icon-link" href="#test-it"></a></h2>
<p>Click the inner square to trigger a click event:</p>
<p>Was your guess different? If so, you may still be right. Unfortunately the browsers don't really agree here:</p>
<ul>
<li><img src="/c/chrome-9c931ed6.png" alt="Chrome">
<ul>
<li>click</li>
<li>promise</li>
<li>mutate</li>
<li>click</li>
<li>promise</li>
<li>mutate</li>
<li>timeout</li>
<li>timeout</li>
</ul>
</li>
<li><img src="/c/firefox-2af43875.png" alt="Firefox">
<ul>
<li>click</li>
<li>mutate</li>
<li>click</li>
<li>mutate</li>
<li>timeout</li>
<li>promise</li>
<li>promise</li>
<li>timeout</li>
</ul>
</li>
<li><img src="/c/safari-167d0e40.png" alt="Safari">
<ul>
<li>click</li>
<li>mutate</li>
<li>click</li>
<li>mutate</li>
<li>promise</li>
<li>promise</li>
<li>timeout</li>
<li>timeout</li>
</ul>
</li>
<li><img src="/c/edge-599a5370.png" alt="Edge">
<ul>
<li>click</li>
<li>click</li>
<li>mutate</li>
<li>timeout</li>
<li>promise</li>
<li>timeout</li>
<li>promise</li>
</ul>
</li>
</ul>
<h2 id="whos-right">Who's right?<a aria-hidden="true" class="anchor-heading icon-link" href="#whos-right"></a></h2>
<p>Dispatching the 'click' event is a task. Mutation observer and promise callbacks are queued as microtasks. The <code>setTimeout</code> callback is queued as a task. So here's how it goes:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// Let's get hold of those elements</span>
<span class="token keyword">var</span> outer <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">".outer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> inner <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">".inner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Let's listen for attribute changes on the</span>
<span class="token comment">// outer element</span>
<span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"mutate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">observe</span><span class="token punctuation">(</span>outer<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  attributes<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Here's a click listener…</span>
<span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"promise"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  outer<span class="token punctuation">.</span><span class="token method function property-access">setAttribute</span><span class="token punctuation">(</span><span class="token string">"data-random"</span><span class="token punctuation">,</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// …which we'll attach to both elements</span>
inner<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> onClick<span class="token punctuation">)</span><span class="token punctuation">;</span>
outer<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> onClick<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Tasks</p>
<p>Dispatch click</p>
<p>setTimeout callback</p>
<p>setTimeout callback</p>
<p>Microtasks</p>
<p>Promise then</p>
<p>Mutation observers</p>
<p>Promise then</p>
<p>Mutation observers</p>
<p>JS stack</p>
<p>Log</p>
<p>click</p>
<p>promise</p>
<p>mutate</p>
<p>click</p>
<p>promise</p>
<p>mutate</p>
<p>timeout</p>
<p>timeout</p>
<p>So it's Chrome that gets it right. The bit that was 'news to me' is that microtasks are processed after callbacks (as long as no other JavaScript is mid-execution), I thought it was limited to end-of-task. This rule comes from the HTML spec for calling a callback:</p>
<blockquote>
<p>If the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#stack-of-script-settings-objects">stack of script settings objects</a> is now empty, <a href="https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint">perform a microtask checkpoint</a></p>
<p>— <a href="https://html.spec.whatwg.org/multipage/webappapis.html#clean-up-after-running-a-callback">HTML: Cleaning up after a callback</a> step 3</p>
</blockquote>
<p>…and a microtask checkpoint involves going through the microtask queue, unless we're already processing the microtask queue. Similarly, ECMAScript says this of jobs:</p>
<blockquote>
<p>Execution of a Job can be initiated only when there is no running execution context and the execution context stack is empty…</p>
<p>— <a href="https://www.ecma-international.org/ecma-262/6.0/#sec-jobs-and-job-queues">ECMAScript: Jobs and Job Queues</a></p>
</blockquote>
<p>…although the "can be" becomes "must be" when in an HTML context.</p>
<h2 id="what-did-browsers-get-wrong">What did browsers get wrong?<a aria-hidden="true" class="anchor-heading icon-link" href="#what-did-browsers-get-wrong"></a></h2>
<p><strong>Firefox</strong> and <strong>Safari</strong> are correctly exhausting the microtask queue between click listeners, as shown by the mutation callbacks, but promises appear to be queued differently. This is sort-of excusable given that the link between jobs &#x26; microtasks is vague, but I'd still expect them to execute between listener callbacks. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1193394">Firefox ticket</a>. <a href="https://bugs.webkit.org/show_bug.cgi?id=147933">Safari ticket</a>.</p>
<p>With <strong>Edge</strong> we've already seen it queue promises incorrectly, but it also fails to exhaust the microtask queue between click listeners, instead it does so after calling all listeners, which accounts for the single <code>mutate</code> log after both <code>click</code> logs. <a href="https://connect.microsoft.com/IE/feedbackdetail/view/1658386/microtasks-queues-should-be-processed-following-event-listeners">Bug ticket</a>.</p>
<h2 id="level-1-bosss-angry-older-brother">Level 1 boss's angry older brother<a aria-hidden="true" class="anchor-heading icon-link" href="#level-1-bosss-angry-older-brother"></a></h2>
<p>Ohh boy. Using the same example from above, what happens if we execute:</p>
<pre class="language-js"><code class="language-js">inner<span class="token punctuation">.</span><span class="token method function property-access">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>This will start the event dispatching as before, but using script rather than a real interaction.</p>
<h2 id="try-it-1">Try it<a aria-hidden="true" class="anchor-heading icon-link" href="#try-it-1"></a></h2>
<p>Clear log Run test</p>
<p>var jsActivatedClick = false; document.querySelector('.test-2').addEventListener('click', function() { jsActivatedClick = true; inner.click(); setTimeout(function() { jsActivatedClick = false; }, 100); }); document.querySelector('.clear-log-3').addEventListener('click', function() { document.querySelector('.log-output-3').value = ''; });</p>
<p>And here's what the browsers say:</p>
<ul>
<li><img src="/c/chrome-9c931ed6.png" alt="Chrome">
<ul>
<li>click</li>
<li>click</li>
<li>promise</li>
<li>mutate</li>
<li>promise</li>
<li>timeout</li>
<li>timeout</li>
</ul>
</li>
<li><img src="/c/firefox-2af43875.png" alt="Firefox">
<ul>
<li>click</li>
<li>click</li>
<li>mutate</li>
<li>timeout</li>
<li>promise</li>
<li>promise</li>
<li>timeout</li>
</ul>
</li>
<li><img src="/c/safari-167d0e40.png" alt="Safari">
<ul>
<li>click</li>
<li>click</li>
<li>mutate</li>
<li>promise</li>
<li>promise</li>
<li>timeout</li>
<li>timeout</li>
</ul>
</li>
<li><img src="/c/edge-599a5370.png" alt="Edge">
<ul>
<li>click</li>
<li>click</li>
<li>mutate</li>
<li>timeout</li>
<li>promise</li>
<li>timeout</li>
<li>promise</li>
</ul>
</li>
</ul>
<p>And I swear I keep getting different results from Chrome, I've updated this chart a ton of times thinking I was testing Canary by mistake. If you get different results in Chrome, tell me which version in the comments.</p>
<h2 id="why-is-it-different">Why is it different?<a aria-hidden="true" class="anchor-heading icon-link" href="#why-is-it-different"></a></h2>
<p>Here's how it should happen:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// Let's get hold of those elements</span>
<span class="token keyword">var</span> outer <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">".outer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> inner <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">".inner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Let's listen for attribute changes on the</span>
<span class="token comment">// outer element</span>
<span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"mutate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">observe</span><span class="token punctuation">(</span>outer<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  attributes<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Here's a click listener…</span>
<span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"promise"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  outer<span class="token punctuation">.</span><span class="token method function property-access">setAttribute</span><span class="token punctuation">(</span><span class="token string">"data-random"</span><span class="token punctuation">,</span> <span class="token known-class-name class-name">Math</span><span class="token punctuation">.</span><span class="token method function property-access">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// …which we'll attach to both elements</span>
inner<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> onClick<span class="token punctuation">)</span><span class="token punctuation">;</span>
outer<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> onClick<span class="token punctuation">)</span><span class="token punctuation">;</span>

inner<span class="token punctuation">.</span><span class="token method function property-access">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Tasks</p>
<p>Run script</p>
<p>setTimeout callback</p>
<p>setTimeout callback</p>
<p>Microtasks</p>
<p>Promise then</p>
<p>Mutation observers</p>
<p>Promise then</p>
<p>JS stack</p>
<p>Log</p>
<p>click</p>
<p>click</p>
<p>promise</p>
<p>mutate</p>
<p>promise</p>
<p>timeout</p>
<p>timeout</p>
<p>So the correct order is: <code>click</code>, <code>click</code>, <code>promise</code>, <code>mutate</code>, <code>promise</code>, <code>timeout</code>, <code>timeout</code>, which Chrome seems to get right.</p>
<p>After each listener callback is called…</p>
<blockquote>
<p>If the <a href="https://html.spec.whatwg.org/multipage/webappapis.html#stack-of-script-settings-objects">stack of script settings objects</a> is now empty, <a href="https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint">perform a microtask checkpoint</a></p>
<p>— <a href="https://html.spec.whatwg.org/multipage/webappapis.html#clean-up-after-running-a-callback">HTML: Cleaning up after a callback</a> step 3</p>
</blockquote>
<p>Previously, this meant that microtasks ran between listener callbacks, but <code>.click()</code> causes the event to dispatch synchronously, so the script that calls <code>.click()</code> is still in the stack between callbacks. The above rule ensures microtasks don't interrupt JavaScript that's mid-execution. This means we don't process the microtask queue between listener callbacks, they're processed after both listeners.</p>
<h2 id="does-any-of-this-matter">Does any of this matter?<a aria-hidden="true" class="anchor-heading icon-link" href="#does-any-of-this-matter"></a></h2>
<p>Yeah, it'll bite you in obscure places (ouch). I encountered this while trying to create <a href="https://github.com/jakearchibald/indexeddb-promised/blob/master/lib/idb.js">a simple wrapper library for IndexedDB that uses promises</a> rather than weird <code>IDBRequest</code> objects. It <a href="https://github.com/jakearchibald/indexeddb-promised/blob/master/test/idb.js#L36"><em>almost</em> makes IDB fun to use</a>.</p>
<p>When IDB fires a success event, the related <a href="https://w3c.github.io/IndexedDB/#fire-a-success-event">transaction object becomes inactive after dispatching</a> (step 4). If I create a promise that resolves when this event fires, the callbacks should run before step 4 while the transaction is still active, but that doesn't happen in browsers other than Chrome, rendering the library kinda useless.</p>
<p>You can actually work around this problem in Firefox, because promise polyfills such as <a href="https://github.com/jakearchibald/es6-promise">es6-promise</a> use mutation observers for callbacks, which correctly use microtasks. Safari seems to suffer from race conditions with that fix, but that could just be their <a href="http://www.raymondcamden.com/2014/09/25/IndexedDB-on-iOS-8-Broken-Bad">broken implementation of IDB</a>. Unfortunately, things consistently fail in IE/Edge, as mutation events aren't handled after callbacks.</p>
<p>Hopefully we'll start to see some interoperability here soon.</p>
<h2 id="you-made-it">You made it!<a aria-hidden="true" class="anchor-heading icon-link" href="#you-made-it"></a></h2>
<p>In summary:</p>
<ul>
<li>Tasks execute in order, and the browser may render between them</li>
<li>Microtasks execute in order, and are executed:
<ul>
<li>after every callback, as long as no other JavaScript is mid-execution</li>
<li>at the end of each task</li>
</ul>
</li>
</ul>
<p>Hopefully you now know your way around the event loop, or at least have an excuse to go and have a lie down.</p>
<p>Actually, is anyone still reading? Hello? Hello?</p>
<p>Thanks to Anne van Kesteren, Domenic Denicola, Brian Kardell, and Matt Gaunt for proofreading &#x26; corrections. Yeah, Matt actually read it in the end, I didn't even need to go full "Clockwork Orange" on him.</p></div></div><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-0 ant-col-md-6"><div><div class=""><div class="ant-anchor-wrapper dendron-toc" style="max-height:calc(100vh - 64px);z-index:1"><div class="ant-anchor"><div class="ant-anchor-ink"><span class="ant-anchor-ink-ball"></span></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#try-it" title="Try it">Try it</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#why-this-happens" title="Why this happens">Why this happens</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#what-are-some-browsers-doing-differently" title="What are some browsers doing differently?">What are some browsers doing differently?</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#how-to-tell-if-something-uses-tasks-or-microtasks" title="How to tell if something uses tasks or microtasks">How to tell if something uses tasks or microtasks</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#level-1-bossfight" title="Level 1 bossfight">Level 1 bossfight</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#test-it" title="Test it">Test it</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#whos-right" title="Who&#x27;s right?">Who&#x27;s right?</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#what-did-browsers-get-wrong" title="What did browsers get wrong?">What did browsers get wrong?</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#level-1-bosss-angry-older-brother" title="Level 1 boss&#x27;s angry older brother">Level 1 boss&#x27;s angry older brother</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#try-it-1" title="Try it">Try it</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#why-is-it-different" title="Why is it different?">Why is it different?</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#does-any-of-this-matter" title="Does any of this matter?">Does any of this matter?</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#you-made-it" title="You made it!">You made it!</a></div></div></div></div></div></div></div></div></div></div></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><footer class="ant-layout-footer" style="padding:0 24px 24px"></footer></main></section></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"note":{"id":"x97lshfu1d3p5kjjbki4hhn","title":"Tasks, microtasks, queues and schedules","desc":"","updated":1656985392333,"created":1656985233821,"custom":{},"fname":"dev.javascript.language.Tasks microtasks queues and schedules","type":"note","vault":{"fsPath":"vault"},"contentHash":"cb5a8549bc5e58312275d1e077c850af","links":[],"anchors":{"try-it":{"type":"header","text":"Try it","value":"try-it","line":36,"column":0,"depth":2},"why-this-happens":{"type":"header","text":"Why this happens","value":"why-this-happens","line":42,"column":0,"depth":2},"what-are-some-browsers-doing-differently":{"type":"header","text":"What are some browsers doing differently?","value":"what-are-some-browsers-doing-differently","line":104,"column":0,"depth":3},"how-to-tell-if-something-uses-tasks-or-microtasks":{"type":"header","text":"How to tell if something uses tasks or microtasks","value":"how-to-tell-if-something-uses-tasks-or-microtasks","line":116,"column":0,"depth":2},"level-1-bossfight":{"type":"header","text":"Level 1 bossfight","value":"level-1-bossfight","line":126,"column":0,"depth":2},"test-it":{"type":"header","text":"Test it","value":"test-it","line":173,"column":0,"depth":2},"whos-right":{"type":"header","text":"Who's right?","value":"whos-right","line":215,"column":0,"depth":2},"what-did-browsers-get-wrong":{"type":"header","text":"What did browsers get wrong?","value":"what-did-browsers-get-wrong","line":304,"column":0,"depth":2},"level-1-bosss-angry-older-brother":{"type":"header","text":"Level 1 boss's angry older brother","value":"level-1-bosss-angry-older-brother","line":310,"column":0,"depth":2},"try-it-1":{"type":"header","text":"Try it","value":"try-it-1","line":320,"column":0,"depth":2},"why-is-it-different":{"type":"header","text":"Why is it different?","value":"why-is-it-different","line":363,"column":0,"depth":2},"does-any-of-this-matter":{"type":"header","text":"Does any of this matter?","value":"does-any-of-this-matter","line":446,"column":0,"depth":2},"you-made-it":{"type":"header","text":"You made it!","value":"you-made-it","line":456,"column":0,"depth":2}},"children":[],"parent":"mraMGoestTO9V6pkpE8XE","data":{}},"body":"\u003ch1 id=\"tasks-microtasks-queues-and-schedules\"\u003eTasks, microtasks, queues and schedules\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#tasks-microtasks-queues-and-schedules\"\u003e\u003c/a\u003e\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/\"\u003ehttps://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eWhen I told my colleague \u003ca href=\"https://twitter.com/gauntface\"\u003eMatt Gaunt\u003c/a\u003e I was thinking of writing a piece on microtask queueing and execution within the browser's event loop, he said \"I'll be honest with you Jake, I'm not going to read that\". Well, I've written it anyway, so we're all going to sit here and enjoy it, ok?\u003c/p\u003e\n\u003cp\u003eActually, if video's more your thing, \u003ca href=\"https://twitter.com/philip_roberts\"\u003ePhilip Roberts\u003c/a\u003e gave a \u003ca href=\"https://www.youtube.com/watch?v=8aGhZQkoFbQ\"\u003egreat talk at JSConf on the event loop\u003c/a\u003e - microtasks aren't covered, but it's a great introduction to the rest. Anyway, on with the show…\u003c/p\u003e\n\u003cp\u003eTake this little bit of JavaScript:\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"script start\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"setTimeout\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token known-class-name class-name\"\u003ePromise\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eresolve\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"promise1\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"promise2\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"script end\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn what order should the logs appear?\u003c/p\u003e\n\u003ch2 id=\"try-it\"\u003eTry it\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#try-it\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eThe correct answer: \u003ccode\u003escript start\u003c/code\u003e, \u003ccode\u003escript end\u003c/code\u003e, \u003ccode\u003epromise1\u003c/code\u003e, \u003ccode\u003epromise2\u003c/code\u003e, \u003ccode\u003esetTimeout\u003c/code\u003e, but it's pretty wild out there in terms of browser support.\u003c/p\u003e\n\u003cp\u003eMicrosoft Edge, Firefox 40, iOS Safari and desktop Safari 8.0.8 log \u003ccode\u003esetTimeout\u003c/code\u003e before \u003ccode\u003epromise1\u003c/code\u003e and \u003ccode\u003epromise2\u003c/code\u003e - although it appears to be a race condition. This is really weird, as Firefox 39 and Safari 8.0.7 get it consistently right.\u003c/p\u003e\n\u003ch2 id=\"why-this-happens\"\u003eWhy this happens\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#why-this-happens\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eTo understand this you need to know how the event loop handles tasks and microtasks. This can be a lot to get your head around the first time you encounter it. Deep breath…\u003c/p\u003e\n\u003cp\u003eEach 'thread' gets its own \u003cstrong\u003eevent loop\u003c/strong\u003e, so each web worker gets its own, so it can execute independently, whereas all windows on the same origin share an event loop as they can synchronously communicate. The event loop runs continually, executing any tasks queued. An event loop has multiple task sources which guarantees execution order within that source (specs \u003ca href=\"https://w3c.github.io/IndexedDB/#database-access-task-source\"\u003esuch as IndexedDB\u003c/a\u003e define their own), but the browser gets to pick which source to take a task from on each turn of the loop. This allows the browser to give preference to performance sensitive tasks such as user-input. Ok ok, stay with me…\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eTasks\u003c/strong\u003e are scheduled so the browser can get from its internals into JavaScript/DOM land and ensures these actions happen sequentially. Between tasks, the browser \u003cem\u003emay\u003c/em\u003e render updates. Getting from a mouse click to an event callback requires scheduling a task, as does parsing HTML, and in the above example, \u003ccode\u003esetTimeout\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esetTimeout\u003c/code\u003e waits for a given delay then schedules a new task for its callback. This is why \u003ccode\u003esetTimeout\u003c/code\u003e is logged after \u003ccode\u003escript end\u003c/code\u003e, as logging \u003ccode\u003escript end\u003c/code\u003e is part of the first task, and \u003ccode\u003esetTimeout\u003c/code\u003e is logged in a separate task. Right, we're almost through this, but I need you to stay strong for this next bit…\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eMicrotasks\u003c/strong\u003e are usually scheduled for things that should happen straight after the currently executing script, such as reacting to a batch of actions, or to make something async without taking the penalty of a whole new task. The microtask queue is processed after callbacks as long as no other JavaScript is mid-execution, and at the end of each task. Any additional microtasks queued during microtasks are added to the end of the queue and also processed. Microtasks include mutation observer callbacks, and as in the above example, promise callbacks.\u003c/p\u003e\n\u003cp\u003eOnce a promise settles, or if it has already settled, it queues a \u003cem\u003emicrotask\u003c/em\u003e for its reactionary callbacks. This ensures promise callbacks are async even if the promise has already settled. So calling \u003ccode\u003e.then(yey, nay)\u003c/code\u003e against a settled promise immediately queues a microtask. This is why \u003ccode\u003epromise1\u003c/code\u003e and \u003ccode\u003epromise2\u003c/code\u003e are logged after \u003ccode\u003escript end\u003c/code\u003e, as the currently running script must finish before microtasks are handled. \u003ccode\u003epromise1\u003c/code\u003e and \u003ccode\u003epromise2\u003c/code\u003e are logged before \u003ccode\u003esetTimeout\u003c/code\u003e, as microtasks always happen before the next task.\u003c/p\u003e\n\u003cp\u003eSo, step by step:\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"script start\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"setTimeout\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token known-class-name class-name\"\u003ePromise\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eresolve\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"promise1\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"promise2\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"script end\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eTasks\u003c/p\u003e\n\u003cp\u003eRun script\u003c/p\u003e\n\u003cp\u003esetTimeout callback\u003c/p\u003e\n\u003cp\u003eMicrotasks\u003c/p\u003e\n\u003cp\u003ePromise then\u003c/p\u003e\n\u003cp\u003ePromise then\u003c/p\u003e\n\u003cp\u003eJS stack\u003c/p\u003e\n\u003cp\u003eLog\u003c/p\u003e\n\u003cp\u003escript start\u003c/p\u003e\n\u003cp\u003escript end\u003c/p\u003e\n\u003cp\u003epromise1\u003c/p\u003e\n\u003cp\u003epromise2\u003c/p\u003e\n\u003cp\u003esetTimeout\u003c/p\u003e\n\u003cp\u003eYes that's right, I created an animated step-by-step diagram. How did you spend \u003cem\u003eyour\u003c/em\u003e Saturday? Went out in the \u003cem\u003esun\u003c/em\u003e with your \u003cem\u003efriends\u003c/em\u003e? Well \u003cem\u003eI didn't\u003c/em\u003e. Um, in case it isn't clear from my amazing UI design, click the arrows above to advance.\u003c/p\u003e\n\u003ch3 id=\"what-are-some-browsers-doing-differently\"\u003eWhat are some browsers doing differently?\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#what-are-some-browsers-doing-differently\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eSome browsers log \u003ccode\u003escript start\u003c/code\u003e, \u003ccode\u003escript end\u003c/code\u003e, \u003ccode\u003esetTimeout\u003c/code\u003e, \u003ccode\u003epromise1\u003c/code\u003e, \u003ccode\u003epromise2\u003c/code\u003e. They're running promise callbacks after \u003ccode\u003esetTimeout\u003c/code\u003e. It's likely that they're calling promise callbacks as part of a new task rather than as a microtask.\u003c/p\u003e\n\u003cp\u003eThis is sort-of excusable, as promises come from ECMAScript rather than HTML. ECMAScript has the concept of \"jobs\" which are similar to microtasks, but the relationship isn't explicit aside from \u003ca href=\"https://esdiscuss.org/topic/the-initialization-steps-for-web-browsers#content-16\"\u003evague mailing list discussions\u003c/a\u003e. However, the general consensus is that promises should be part of the microtask queue, and for good reason.\u003c/p\u003e\n\u003cp\u003eTreating promises as tasks leads to performance problems, as callbacks may be unnecessarily delayed by task-related things such as rendering. It also causes non-determinism due to interaction with other task sources, and can break interactions with other APIs, but more on that later.\u003c/p\u003e\n\u003cp\u003eHere's \u003ca href=\"https://connect.microsoft.com/IE/feedback/details/1658365\"\u003ean Edge ticket\u003c/a\u003e for making promises use microtasks. WebKit nightly is doing the right thing, so I assume Safari will pick up the fix eventually, and it appears to be fixed in Firefox 43.\u003c/p\u003e\n\u003cp\u003eReally interesting that both Safari and Firefox suffered a regression here that's since been fixed. I wonder if it's just a coincidence.\u003c/p\u003e\n\u003ch2 id=\"how-to-tell-if-something-uses-tasks-or-microtasks\"\u003eHow to tell if something uses tasks or microtasks\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#how-to-tell-if-something-uses-tasks-or-microtasks\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eTesting is one way. See when logs appear relative to promises \u0026#x26; \u003ccode\u003esetTimeout\u003c/code\u003e, although you're relying on the implementation to be correct.\u003c/p\u003e\n\u003cp\u003eThe certain way, is to look up the spec. For instance, \u003ca href=\"https://html.spec.whatwg.org/multipage/webappapis.html#timer-initialisation-steps\"\u003estep 14 of \u003ccode\u003esetTimeout\u003c/code\u003e\u003c/a\u003e queues a task, whereas \u003ca href=\"https://dom.spec.whatwg.org/#queue-a-mutation-record\"\u003estep 5 of queuing a mutation record\u003c/a\u003e queues a microtask.\u003c/p\u003e\n\u003cp\u003eAs mentioned, in ECMAScript land, they call microtasks \"jobs\". In \u003ca href=\"https://www.ecma-international.org/ecma-262/6.0/#sec-performpromisethen\"\u003estep 8.a of \u003ccode\u003ePerformPromiseThen\u003c/code\u003e\u003c/a\u003e, \u003ccode\u003eEnqueueJob\u003c/code\u003e is called to queue a microtask.\u003c/p\u003e\n\u003cp\u003eNow, let's look at a more complicated example. \u003cem\u003eCut to a concerned apprentice\u003c/em\u003e \"No, they're not ready!\". Ignore him, you're ready. Let's do this…\u003c/p\u003e\n\u003ch2 id=\"level-1-bossfight\"\u003eLevel 1 bossfight\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#level-1-bossfight\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eBefore writing this post I'd have gotten this wrong. Here's a bit of html:\u003c/p\u003e\n\u003cpre class=\"language-html\"\u003e\u003ccode class=\"language-html\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ediv\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003eclass\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003eouter\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003ediv\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003eclass\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003einner\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ediv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003ediv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eGiven the following JS, what will be logged if I click \u003ccode\u003ediv.inner\u003c/code\u003e?\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token comment\"\u003e// Let's get hold of those elements\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e outer \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token dom variable\"\u003edocument\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003equerySelector\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\".outer\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e inner \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token dom variable\"\u003edocument\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003equerySelector\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\".inner\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Let's listen for attribute changes on the\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// outer element\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMutationObserver\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"mutate\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eobserve\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eouter\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  attributes\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Here's a click listener…\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003eonClick\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"click\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token function\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"timeout\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token known-class-name class-name\"\u003ePromise\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eresolve\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"promise\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  outer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esetAttribute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"data-random\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eMath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003erandom\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// …which we'll attach to both elements\u003c/span\u003e\ninner\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"click\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e onClick\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nouter\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"click\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e onClick\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eGo on, give it a go before peeking at the answer. \u003cem\u003eClue:\u003c/em\u003e Logs can happen more than once.\u003c/p\u003e\n\u003ch2 id=\"test-it\"\u003eTest it\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#test-it\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eClick the inner square to trigger a click event:\u003c/p\u003e\n\u003cp\u003eWas your guess different? If so, you may still be right. Unfortunately the browsers don't really agree here:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cimg src=\"/c/chrome-9c931ed6.png\" alt=\"Chrome\"\u003e\n\u003cul\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003cli\u003emutate\u003c/li\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003cli\u003emutate\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cimg src=\"/c/firefox-2af43875.png\" alt=\"Firefox\"\u003e\n\u003cul\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003emutate\u003c/li\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003emutate\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cimg src=\"/c/safari-167d0e40.png\" alt=\"Safari\"\u003e\n\u003cul\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003emutate\u003c/li\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003emutate\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cimg src=\"/c/edge-599a5370.png\" alt=\"Edge\"\u003e\n\u003cul\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003emutate\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"whos-right\"\u003eWho's right?\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#whos-right\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eDispatching the 'click' event is a task. Mutation observer and promise callbacks are queued as microtasks. The \u003ccode\u003esetTimeout\u003c/code\u003e callback is queued as a task. So here's how it goes:\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token comment\"\u003e// Let's get hold of those elements\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e outer \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token dom variable\"\u003edocument\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003equerySelector\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\".outer\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e inner \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token dom variable\"\u003edocument\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003equerySelector\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\".inner\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Let's listen for attribute changes on the\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// outer element\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMutationObserver\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"mutate\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eobserve\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eouter\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  attributes\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Here's a click listener…\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003eonClick\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"click\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token function\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"timeout\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token known-class-name class-name\"\u003ePromise\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eresolve\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"promise\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  outer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esetAttribute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"data-random\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eMath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003erandom\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// …which we'll attach to both elements\u003c/span\u003e\ninner\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"click\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e onClick\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nouter\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"click\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e onClick\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eTasks\u003c/p\u003e\n\u003cp\u003eDispatch click\u003c/p\u003e\n\u003cp\u003esetTimeout callback\u003c/p\u003e\n\u003cp\u003esetTimeout callback\u003c/p\u003e\n\u003cp\u003eMicrotasks\u003c/p\u003e\n\u003cp\u003ePromise then\u003c/p\u003e\n\u003cp\u003eMutation observers\u003c/p\u003e\n\u003cp\u003ePromise then\u003c/p\u003e\n\u003cp\u003eMutation observers\u003c/p\u003e\n\u003cp\u003eJS stack\u003c/p\u003e\n\u003cp\u003eLog\u003c/p\u003e\n\u003cp\u003eclick\u003c/p\u003e\n\u003cp\u003epromise\u003c/p\u003e\n\u003cp\u003emutate\u003c/p\u003e\n\u003cp\u003eclick\u003c/p\u003e\n\u003cp\u003epromise\u003c/p\u003e\n\u003cp\u003emutate\u003c/p\u003e\n\u003cp\u003etimeout\u003c/p\u003e\n\u003cp\u003etimeout\u003c/p\u003e\n\u003cp\u003eSo it's Chrome that gets it right. The bit that was 'news to me' is that microtasks are processed after callbacks (as long as no other JavaScript is mid-execution), I thought it was limited to end-of-task. This rule comes from the HTML spec for calling a callback:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eIf the \u003ca href=\"https://html.spec.whatwg.org/multipage/webappapis.html#stack-of-script-settings-objects\"\u003estack of script settings objects\u003c/a\u003e is now empty, \u003ca href=\"https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint\"\u003eperform a microtask checkpoint\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e— \u003ca href=\"https://html.spec.whatwg.org/multipage/webappapis.html#clean-up-after-running-a-callback\"\u003eHTML: Cleaning up after a callback\u003c/a\u003e step 3\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e…and a microtask checkpoint involves going through the microtask queue, unless we're already processing the microtask queue. Similarly, ECMAScript says this of jobs:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eExecution of a Job can be initiated only when there is no running execution context and the execution context stack is empty…\u003c/p\u003e\n\u003cp\u003e— \u003ca href=\"https://www.ecma-international.org/ecma-262/6.0/#sec-jobs-and-job-queues\"\u003eECMAScript: Jobs and Job Queues\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e…although the \"can be\" becomes \"must be\" when in an HTML context.\u003c/p\u003e\n\u003ch2 id=\"what-did-browsers-get-wrong\"\u003eWhat did browsers get wrong?\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#what-did-browsers-get-wrong\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eFirefox\u003c/strong\u003e and \u003cstrong\u003eSafari\u003c/strong\u003e are correctly exhausting the microtask queue between click listeners, as shown by the mutation callbacks, but promises appear to be queued differently. This is sort-of excusable given that the link between jobs \u0026#x26; microtasks is vague, but I'd still expect them to execute between listener callbacks. \u003ca href=\"https://bugzilla.mozilla.org/show_bug.cgi?id=1193394\"\u003eFirefox ticket\u003c/a\u003e. \u003ca href=\"https://bugs.webkit.org/show_bug.cgi?id=147933\"\u003eSafari ticket\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eWith \u003cstrong\u003eEdge\u003c/strong\u003e we've already seen it queue promises incorrectly, but it also fails to exhaust the microtask queue between click listeners, instead it does so after calling all listeners, which accounts for the single \u003ccode\u003emutate\u003c/code\u003e log after both \u003ccode\u003eclick\u003c/code\u003e logs. \u003ca href=\"https://connect.microsoft.com/IE/feedbackdetail/view/1658386/microtasks-queues-should-be-processed-following-event-listeners\"\u003eBug ticket\u003c/a\u003e.\u003c/p\u003e\n\u003ch2 id=\"level-1-bosss-angry-older-brother\"\u003eLevel 1 boss's angry older brother\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#level-1-bosss-angry-older-brother\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eOhh boy. Using the same example from above, what happens if we execute:\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003einner\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eclick\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will start the event dispatching as before, but using script rather than a real interaction.\u003c/p\u003e\n\u003ch2 id=\"try-it-1\"\u003eTry it\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#try-it-1\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eClear log Run test\u003c/p\u003e\n\u003cp\u003evar jsActivatedClick = false; document.querySelector('.test-2').addEventListener('click', function() { jsActivatedClick = true; inner.click(); setTimeout(function() { jsActivatedClick = false; }, 100); }); document.querySelector('.clear-log-3').addEventListener('click', function() { document.querySelector('.log-output-3').value = ''; });\u003c/p\u003e\n\u003cp\u003eAnd here's what the browsers say:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cimg src=\"/c/chrome-9c931ed6.png\" alt=\"Chrome\"\u003e\n\u003cul\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003cli\u003emutate\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cimg src=\"/c/firefox-2af43875.png\" alt=\"Firefox\"\u003e\n\u003cul\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003emutate\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cimg src=\"/c/safari-167d0e40.png\" alt=\"Safari\"\u003e\n\u003cul\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003emutate\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cimg src=\"/c/edge-599a5370.png\" alt=\"Edge\"\u003e\n\u003cul\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003eclick\u003c/li\u003e\n\u003cli\u003emutate\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003cli\u003etimeout\u003c/li\u003e\n\u003cli\u003epromise\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAnd I swear I keep getting different results from Chrome, I've updated this chart a ton of times thinking I was testing Canary by mistake. If you get different results in Chrome, tell me which version in the comments.\u003c/p\u003e\n\u003ch2 id=\"why-is-it-different\"\u003eWhy is it different?\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#why-is-it-different\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eHere's how it should happen:\u003c/p\u003e\n\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token comment\"\u003e// Let's get hold of those elements\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e outer \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token dom variable\"\u003edocument\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003equerySelector\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\".outer\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e inner \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token dom variable\"\u003edocument\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003equerySelector\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\".inner\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Let's listen for attribute changes on the\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// outer element\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMutationObserver\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"mutate\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eobserve\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eouter\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  attributes\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Here's a click listener…\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003eonClick\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"click\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token function\"\u003esetTimeout\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"timeout\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token known-class-name class-name\"\u003ePromise\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eresolve\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"promise\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  outer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esetAttribute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"data-random\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eMath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003erandom\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// …which we'll attach to both elements\u003c/span\u003e\ninner\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"click\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e onClick\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nouter\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"click\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e onClick\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\ninner\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eclick\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eTasks\u003c/p\u003e\n\u003cp\u003eRun script\u003c/p\u003e\n\u003cp\u003esetTimeout callback\u003c/p\u003e\n\u003cp\u003esetTimeout callback\u003c/p\u003e\n\u003cp\u003eMicrotasks\u003c/p\u003e\n\u003cp\u003ePromise then\u003c/p\u003e\n\u003cp\u003eMutation observers\u003c/p\u003e\n\u003cp\u003ePromise then\u003c/p\u003e\n\u003cp\u003eJS stack\u003c/p\u003e\n\u003cp\u003eLog\u003c/p\u003e\n\u003cp\u003eclick\u003c/p\u003e\n\u003cp\u003eclick\u003c/p\u003e\n\u003cp\u003epromise\u003c/p\u003e\n\u003cp\u003emutate\u003c/p\u003e\n\u003cp\u003epromise\u003c/p\u003e\n\u003cp\u003etimeout\u003c/p\u003e\n\u003cp\u003etimeout\u003c/p\u003e\n\u003cp\u003eSo the correct order is: \u003ccode\u003eclick\u003c/code\u003e, \u003ccode\u003eclick\u003c/code\u003e, \u003ccode\u003epromise\u003c/code\u003e, \u003ccode\u003emutate\u003c/code\u003e, \u003ccode\u003epromise\u003c/code\u003e, \u003ccode\u003etimeout\u003c/code\u003e, \u003ccode\u003etimeout\u003c/code\u003e, which Chrome seems to get right.\u003c/p\u003e\n\u003cp\u003eAfter each listener callback is called…\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eIf the \u003ca href=\"https://html.spec.whatwg.org/multipage/webappapis.html#stack-of-script-settings-objects\"\u003estack of script settings objects\u003c/a\u003e is now empty, \u003ca href=\"https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint\"\u003eperform a microtask checkpoint\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e— \u003ca href=\"https://html.spec.whatwg.org/multipage/webappapis.html#clean-up-after-running-a-callback\"\u003eHTML: Cleaning up after a callback\u003c/a\u003e step 3\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003ePreviously, this meant that microtasks ran between listener callbacks, but \u003ccode\u003e.click()\u003c/code\u003e causes the event to dispatch synchronously, so the script that calls \u003ccode\u003e.click()\u003c/code\u003e is still in the stack between callbacks. The above rule ensures microtasks don't interrupt JavaScript that's mid-execution. This means we don't process the microtask queue between listener callbacks, they're processed after both listeners.\u003c/p\u003e\n\u003ch2 id=\"does-any-of-this-matter\"\u003eDoes any of this matter?\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#does-any-of-this-matter\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eYeah, it'll bite you in obscure places (ouch). I encountered this while trying to create \u003ca href=\"https://github.com/jakearchibald/indexeddb-promised/blob/master/lib/idb.js\"\u003ea simple wrapper library for IndexedDB that uses promises\u003c/a\u003e rather than weird \u003ccode\u003eIDBRequest\u003c/code\u003e objects. It \u003ca href=\"https://github.com/jakearchibald/indexeddb-promised/blob/master/test/idb.js#L36\"\u003e\u003cem\u003ealmost\u003c/em\u003e makes IDB fun to use\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eWhen IDB fires a success event, the related \u003ca href=\"https://w3c.github.io/IndexedDB/#fire-a-success-event\"\u003etransaction object becomes inactive after dispatching\u003c/a\u003e (step 4). If I create a promise that resolves when this event fires, the callbacks should run before step 4 while the transaction is still active, but that doesn't happen in browsers other than Chrome, rendering the library kinda useless.\u003c/p\u003e\n\u003cp\u003eYou can actually work around this problem in Firefox, because promise polyfills such as \u003ca href=\"https://github.com/jakearchibald/es6-promise\"\u003ees6-promise\u003c/a\u003e use mutation observers for callbacks, which correctly use microtasks. Safari seems to suffer from race conditions with that fix, but that could just be their \u003ca href=\"http://www.raymondcamden.com/2014/09/25/IndexedDB-on-iOS-8-Broken-Bad\"\u003ebroken implementation of IDB\u003c/a\u003e. Unfortunately, things consistently fail in IE/Edge, as mutation events aren't handled after callbacks.\u003c/p\u003e\n\u003cp\u003eHopefully we'll start to see some interoperability here soon.\u003c/p\u003e\n\u003ch2 id=\"you-made-it\"\u003eYou made it!\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#you-made-it\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eIn summary:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTasks execute in order, and the browser may render between them\u003c/li\u003e\n\u003cli\u003eMicrotasks execute in order, and are executed:\n\u003cul\u003e\n\u003cli\u003eafter every callback, as long as no other JavaScript is mid-execution\u003c/li\u003e\n\u003cli\u003eat the end of each task\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHopefully you now know your way around the event loop, or at least have an excuse to go and have a lie down.\u003c/p\u003e\n\u003cp\u003eActually, is anyone still reading? Hello? Hello?\u003c/p\u003e\n\u003cp\u003eThanks to Anne van Kesteren, Domenic Denicola, Brian Kardell, and Matt Gaunt for proofreading \u0026#x26; corrections. Yeah, Matt actually read it in the end, I didn't even need to go full \"Clockwork Orange\" on him.\u003c/p\u003e","noteIndex":{"id":"Iy0MoL0KnL55Br3AfTS2C","title":"Luke","desc":"","updated":1766965759366,"created":1644449449778,"custom":{"nav_order":0,"permalink":"/"},"fname":"root","type":"note","vault":{"fsPath":"vault"},"contentHash":"a724de3efd251cf89fe82a5860d9008b","links":[{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"life-tips","position":{"start":{"line":43,"column":5,"offset":2710},"end":{"line":43,"column":29,"offset":2734},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"life-tips","anchorHeader":"wodenokoto"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"read.2026.articles","alias":"What I read in 2026","position":{"start":{"line":72,"column":3,"offset":4440},"end":{"line":72,"column":45,"offset":4482},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"read.2026.articles"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"read.2025.articles","alias":"2025","position":{"start":{"line":73,"column":5,"offset":4487},"end":{"line":73,"column":32,"offset":4514},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"read.2025.articles"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"read.2024.articles","alias":"2024","position":{"start":{"line":74,"column":5,"offset":4519},"end":{"line":74,"column":32,"offset":4546},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"read.2024.articles"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"read.2023.articles","alias":"2023","position":{"start":{"line":75,"column":5,"offset":4551},"end":{"line":75,"column":32,"offset":4578},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"read.2023.articles"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"read.2022.articles","alias":"2022","position":{"start":{"line":76,"column":5,"offset":4583},"end":{"line":76,"column":32,"offset":4610},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"read.2022.articles"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-struggled-brag-in","position":{"start":{"line":82,"column":3,"offset":4746},"end":{"line":82,"column":39,"offset":4782},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-struggled-brag-in"}}],"anchors":{"what-i-read-in-past":{"type":"header","text":"What I read in past","value":"what-i-read-in-past","line":76,"column":0,"depth":2}},"children":["zd4mq442jike0pr0wba1u3m","6hzeqsofq67gdk88flxlkhp","778ijii93yu5uwnrwmn5zi4","g1fngdjl25nes6fs3lip602","ZbdkdApFqLdks4Moq92R9","uoc5hhki3o4py15cesddu8q","9qf7j06jtdkm6rnx9ymvwb0","5zn10cvj7ajy2gh2is5nqmg","4qo9ma0z0yu1czns6pxl7y5","ok0e729ho7o09xetujkxc0m","GR5x8HnNFEN6fU2UBSEIK","yirtnlj8q24yutcf3ss1xqy","eq0wc6t7wl2wv221yb68ro4","7x2fnv4j6gxts08qk0jguny","ettkt3iClONnxpbGwBVLl","7l4knev6v613tbuoskvmbdg","hvh5bud6yp7dc89tuh95tr9","4fvoqrplw0cweo554usbjos","f8qsfql0a9v8thpeo82udfa","1swsbrhqi9jk41v9eodyi5q","SQqYupi6EFddTerBA8RRD","hjNeNc1F2JUh0lTWanH4h","qf0l4wbrc9jgooyzexmbq5v","o7xruzrah5wzqetottecss7","z1zo2mp6ddji5p317i4x9xw","v06c2tjelh341x4resa50fh","0yqesk4rcffwgyuab5x8rfa","sy2vkbtyu671chkvgn1yt8j","ufixpmxoydiccoh59kphrib","alswadkx4wb05y1z9iwfzfv","1daut9dpw70xd0zh5a7j5p4"],"parent":null,"data":{},"body":"\nHi there 👋. I'm a Front-end developer.\n\n---\n\n- 현실은 인간의 연산으로 완전히 파악할 수 없는 복잡계. 주어진 상황과 능력으로 할 수 있는 최선의 적응은 단순함과 꾸준함.\n\n  - 파산을 면하는 선에서 여러가지를 해보고 자신에게 맞는 걸 위주로 꾸준히. 그를 위해 단순, 편안, 쾌적함이 필요.\n\n- 🥱 -\u003e 🤔💡🌱 - [On The Death of Daydreaming](https://www.afterbabel.com/p/on-the-death-of-daydreaming)\n  - boredom -\u003e easy fun -\u003e art -\u003e profit?\n\n\u003e I've often described my motivation for building software to others using imagery: I like to go find a secluded beach, build a large, magnificent sand castle, and then walk away. Will anyone notice? Probably not. Will the waves eventually destroy it? Yep. Did I still get immense satisfaction? Absolutely. - [aliasxneo](https://news.ycombinator.com/item?id=41497113)\n\n\u003e We love to see the process, not just the result. The imperfections in your work can be beautiful if they show your struggle for perfection, not a lack of care. - [ralphammer](https://ralphammer.com/is-perfection-boring/)\n\n\u003e Simplicity, even if it sacrifices some ideal functionality has better survival characteristics than the-right-thing. - [The Rise of Worse is Better](https://www.dreamsongs.com/RiseOfWorseIsBetter.html)\n\n\u003e [Roberto Blake was talking about making 100 crappy videos](https://www.youtube.com/watch?v=OnUBaQ1Sp_E) to get better over time. Putting in the reps and improving a little bit each time.\n\u003e\n\u003e Putting in the work without expecting any external reward at first (eg views, followers, likes, etc) will pay off in the long run. - [100 Scrappy Things](https://www.florin-pop.com/blog/100-scrappy-things/)\n\n\u003e Make the difficult habitual, the habitual easy, and the easy beautiful. - [Constantin S. Stanislavski](https://www.goodreads.com/quotes/7102271-make-the-difficult-habitual-the-habitual-easy-and-the-easy)\n\n\u003e A good match is a **structured** dance, where players aim to **score** while they are following well-defined **rules**. This **freedom within a structure** is what makes it fun. - [ralphammer](https://ralphammer.com/how-to-get-started/)\n\n- [Pivot Points](https://longform.asmartbear.com/pivot-points/)\n\n  - non-judgmental aspects of personality that can be strengths in some contexts and weaknesses in others\n  - Pivot Points are fixed in the short term\n\n- [Hedged Bets](https://longform.asmartbear.com/predict-the-future/#hedged-bets)\n  - trading slightly less maximum upside for predictable, net-positive outcomes.\n\n\u003e “Motivation often comes after starting, not before. Action produces momentum.”\n\u003e [When you start a new habit, it should take less than two minutes to do.](https://jamesclear.com/how-to-stop-procrastinating)\n\u003e\n\u003e - James Clear\n\n\u003e Focus is more about **not** keeping busy when you need to wait for something.  \n\u003e Eat the boredom for a minute.\n\u003e\n\u003e - [[life-tips#wodenokoto]]\n\n\u003e [4 minutes run hard enough to push heart rate to 90%, 3 minutes recover, repeat 4 times](https://news.ycombinator.com/item?id=34213181)\n\u003e\n\u003e - https://www.ntnu.edu/cerg/advice\n\u003e - [Get running with Couch to 5K](https://www.nhs.uk/live-well/exercise/running-and-aerobic-exercises/get-running-with-couch-to-5k/)\n\n\u003e [recommended routine - bodyweightfitness](https://www.reddit.com/r/bodyweightfitness/wiki/kb/recommended_routine/) - I Don't Have This Much Time!\n\u003e\n\u003e - Don't workout at all (saves anywhere from 20 to 60 minutes, but really, really, really, really, really, really, really, really, really not recommended)\n\n\u003e 도무지 읽히지 않는 책 앞에서 내가 택한 방법은 펼쳐진 페이지 앞에서 멍때리기이다. 다르게 표현하면 이렇다. 펼쳐진 두 페이지 앞에서 오래 머물기.\n\u003e\n\u003e 책을 펼쳐놓는 것으로 충분하다. 읽지 못해도 좋다. 매일 정해진 진도를 나가야 하는 학교 수업이 아니니까. 하지만 읽지 않아도 괜찮다고 해서 펼쳐두지조차 않으면 곤란하다. 가능한 한 자주 책을 펼쳐두도록 하자. 전혀 읽지 않고 멍하니 바라보고 있다가 다시 덮게 되더라도\n\u003e\n\u003e - 막막한 독서. 시로군. P.10~13\n\n\u003e I think it should be everyone's primary focus to sleep well, drink water, get outside, get active, and eat generally decently. I hate to say it, but if you're not eating a good amount of vegetables and fruit, decent protein, sleep, etc, no amount of XYZ will catch up to that detriment. - [CE02](https://news.ycombinator.com/item?id=35056071)\n\n\u003e My real battle is doing good versus doing nothing. - [Deirdre Sullivan](https://www.npr.org/2005/08/08/4785079/always-go-to-the-funeral)\n\n[Kind Engineering](https://kind.engineering/) - How To Engineer Kindness\n\n\u003e Sometimes magic is just someone spending more time on something than anyone else might reasonably expect. - [Teller](https://www.goodreads.com/quotes/6641527-sometimes-magic-is-just-someone-spending-more-time-on-something)\n\n---\n\n## What I read in past\n\n- [[What I read in 2026|read.2026.articles]]\n  - [[2025|read.2025.articles]]\n  - [[2024|read.2024.articles]]\n  - [[2023|read.2023.articles]]\n  - [[2022|read.2022.articles]]\n- 📝 [Gists](https://gist.github.com/Luke-SNAW)\n- 📜 [Journals](https://luke-snaw.github.io/Luke-SNAW__netlify-CMS.github.io/)\n\n---\n\n- [[journal.what-i-struggled-brag-in]]\n"},"collectionChildren":null,"customHeadContent":null,"config":{"version":5,"dev":{"enablePreviewV2":true},"commands":{"lookup":{"note":{"selectionMode":"extract","confirmVaultOnCreate":true,"vaultSelectionModeOnCreate":"smart","leaveTrace":false,"bubbleUpCreateNew":true,"fuzzThreshold":0.2}},"randomNote":{},"insertNoteLink":{"aliasMode":"none","enableMultiSelect":false},"insertNoteIndex":{"enableMarker":false},"copyNoteLink":{"aliasMode":"title"},"templateHierarchy":"template"},"workspace":{"vaults":[{"fsPath":"vault"}],"journal":{"dailyDomain":"daily","name":"journal","dateFormat":"y.MM.dd","addBehavior":"childOfDomain"},"scratch":{"name":"scratch","dateFormat":"y.MM.dd.HHmmss","addBehavior":"asOwnDomain"},"task":{"name":"","dateFormat":"","addBehavior":"childOfCurrent","statusSymbols":{"":" ","wip":"w","done":"x","assigned":"a","moved":"m","blocked":"b","delegated":"l","dropped":"d","pending":"y"},"prioritySymbols":{"H":"high","M":"medium","L":"low"},"todoIntegration":false,"createTaskSelectionType":"selection2link","taskCompleteStatus":["done","x"]},"graph":{"zoomSpeed":1,"createStub":false},"enableAutoCreateOnDefinition":false,"enableXVaultWikiLink":false,"enableRemoteVaultInit":true,"enableUserTags":false,"enableHashTags":true,"workspaceVaultSyncMode":"noCommit","enableAutoFoldFrontmatter":false,"enableEditorDecorations":true,"maxPreviewsCached":10,"maxNoteLength":204800,"dendronVersion":"0.115.0","enableFullHierarchyNoteTitle":false,"enablePersistentHistory":false},"preview":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enablePrettyRefs":true,"enableKatex":true,"automaticallyShowPreview":false,"enableFrontmatterTags":true,"enableHashesForFMTags":false},"publishing":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enablePrettyRefs":true,"enableKatex":true,"copyAssets":true,"siteHierarchies":["root"],"writeStubs":false,"siteRootDir":"docs","seo":{"title":"Luke SNAW","description":"Personal knowledge space"},"github":{"enableEditLink":false,"editLinkText":"Edit this page on GitHub","editBranch":"main","editViewMode":"tree"},"enableSiteLastModified":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableRandomlyColoredTags":true,"enableTaskNotes":true,"enablePrettyLinks":true,"searchMode":"lookup","siteUrl":"https://luke-snaw.github.io/","duplicateNoteBehavior":{"action":"useVault","payload":["vault"]},"siteFaviconPath":"favicon.ico","siteIndex":"root"}}},"__N_SSG":true},"page":"/notes/[id]","query":{"id":"x97lshfu1d3p5kjjbki4hhn"},"buildId":"wirstT2ztC8OQsbzKjhvw","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>