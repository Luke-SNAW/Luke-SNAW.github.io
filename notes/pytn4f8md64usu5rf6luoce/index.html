<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/favicon.ico"/><title>Efficient Pagination Using Deferred Joins</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="description" content="Personal knowledge space"/><meta property="og:title" content="Efficient Pagination Using Deferred Joins"/><meta property="og:description" content="Personal knowledge space"/><meta property="og:url" content="https://luke-snaw.github.io//notes/pytn4f8md64usu5rf6luoce/"/><meta property="og:type" content="article"/><meta property="article:published_time" content="8/24/2022"/><meta property="article:modified_time" content="8/24/2022"/><link rel="canonical" href="https://luke-snaw.github.io//notes/pytn4f8md64usu5rf6luoce/"/><meta name="next-head-count" content="14"/><link rel="preload" href="/_next/static/css/8e7b7e4bce421c0a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8e7b7e4bce421c0a.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-3d209faeb64f2f97.js" defer=""></script><script src="/_next/static/chunks/framework-28c999baf2863c3d.js" defer=""></script><script src="/_next/static/chunks/main-104451f3d1a5c4bc.js" defer=""></script><script src="/_next/static/chunks/pages/_app-9d8e0603730b15a3.js" defer=""></script><script src="/_next/static/chunks/935-4dee79e80b8641c6.js" defer=""></script><script src="/_next/static/chunks/6-50972def09142ee2.js" defer=""></script><script src="/_next/static/chunks/pages/notes/%5Bid%5D-78d472fa3b924116.js" defer=""></script><script src="/_next/static/vOE8u-mg___OsOsz4tjEg/_buildManifest.js" defer=""></script><script src="/_next/static/vOE8u-mg___OsOsz4tjEg/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><section class="ant-layout" style="width:100%;min-height:100%"><header class="ant-layout-header" style="position:fixed;isolation:isolate;z-index:1;width:100%;border-bottom:1px solid #d4dadf;height:64px;padding:0 24px 0 2px"><div class="ant-row ant-row-center" style="max-width:992px;justify-content:space-between;margin:0 auto"><div style="display:flex" class="ant-col ant-col-xs-20 ant-col-sm-4"></div><div class="ant-col gutter-row ant-col-xs-0 ant-col-sm-20 ant-col-md-20 ant-col-lg-19"><div class="ant-select ant-select-lg ant-select-auto-complete ant-select-single ant-select-allow-clear ant-select-show-search" style="width:100%"><div class="ant-select-selector"><span class="ant-select-selection-search"><input type="search" autoComplete="off" class="ant-select-selection-search-input" role="combobox" aria-haspopup="listbox" aria-owns="undefined_list" aria-autocomplete="list" aria-controls="undefined_list" aria-activedescendant="undefined_list_0" value=""/></span><span class="ant-select-selection-placeholder">For full text search please use the &#x27;?&#x27; prefix. e.g. ? Onboarding</span></div></div></div><div style="display:none;align-items:center;justify-content:center" class="ant-col ant-col-xs-4 ant-col-sm-4 ant-col-md-0 ant-col-lg-0"><span role="img" aria-label="menu" style="font-size:24px" tabindex="-1" class="anticon anticon-menu"><svg viewBox="64 64 896 896" focusable="false" data-icon="menu" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></span></div></div></header><section class="ant-layout" style="margin-top:64px;display:flex;flex-direction:row"><div class="site-layout-sidebar" style="flex:0 0 auto;width:calc(max((100% - 992px) / 2, 0px) + 200px);min-width:200px;padding-left:calc((100% - 992px) / 2)"><aside class="ant-layout-sider ant-layout-sider-dark" style="position:fixed;overflow:auto;height:calc(100vh - 64px);background-color:transparent;flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"></div></aside></div><main class="ant-layout-content side-layout-main" style="max-width:1200px;min-width:0;display:block"><div style="padding:0 24px"><div class="main-content" role="main"><div class="ant-row"><div class="ant-col ant-col-24"><div class="ant-row" style="margin-left:-10px;margin-right:-10px"><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-24 ant-col-md-18"><div><h1 id="efficient-pagination-using-deferred-joins">Efficient Pagination Using Deferred Joins<a aria-hidden="true" class="anchor-heading icon-link" href="#efficient-pagination-using-deferred-joins"></a></h1>
<blockquote>
<p><a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins">https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins</a></p>
</blockquote>
<p>Paginating records across large datasets in a web application seems like an easy problem that can actually be pretty tough to scale. The two main pagination strategies are offset/limit and cursors.</p>
<p>We'll first take a look at the two methods and then a slight modification that can make offset/limit extremely performant.</p>
<blockquote>
<p>I want to hear your feedback on the method I'm proposing in this article, please tweet at me! <a href="https://twitter.com/aarondfrancis">twitter.com/aarondfrancis</a>. I'll be adding them to the <a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#results">results</a> section at the bottom of this page.</p>
</blockquote>
<h2 id="offset--limit-pagination"><a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#offset--limit-pagination" title="Permalink">#</a>Offset / Limit Pagination<a aria-hidden="true" class="anchor-heading icon-link" href="#offset--limit-pagination"></a></h2>
<p>The offset/limit approach is by far the most common, and works by skipping a certain number of records (pages) and limiting the results to one page.</p>
<p>As an example, imagine your application is configured to show 15 records per page. Your SQL would look like this:</p>
<pre class="language-sql"><code class="language-sql"><span class="token comment">-- Page 1</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">order</span> <span class="token keyword">by</span> created_at <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">15</span> <span class="token keyword">offset</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">-- Page 2</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">order</span> <span class="token keyword">by</span> created_at <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">15</span> <span class="token keyword">offset</span> <span class="token number">15</span><span class="token punctuation">;</span>

<span class="token comment">-- Page 3</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">order</span> <span class="token keyword">by</span> created_at <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">15</span> <span class="token keyword">offset</span> <span class="token number">30</span><span class="token punctuation">;</span>
</code></pre>
<p>This is the most common because it's extremely straightforward, easy to reason about, and almost every framework supports it.</p>
<p>In addition to being easy to implement, it also has the nice advantage that pages are directly addressable. For example, if you want to navigate <em>directly</em> to page 20, you can do that because that offset is calculable very easily.</p>
<p>There is a major drawback though, and it lurks in the way that databases handle offsets. <code>Offset</code> tells the database to discard the first <code>N</code> results that are returned from a query. The database still has to fetch those rows from disk though.</p>
<p>This doesn't matter much if you're discarding 100 rows, but if you're discarding 100,000 rows the database is doing <strong>a lot</strong> of work just to throw away the results.</p>
<p>In practice, this means that the first page will load quickly and every page after that will get slower and slower, until you reach a point where the web requests may simply time out.</p>
<h2 id="cursor-based-pagination"><a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#cursor-based-pagination" title="Permalink">#</a>Cursor Based Pagination<a aria-hidden="true" class="anchor-heading icon-link" href="#cursor-based-pagination"></a></h2>
<p>Cursor based pagination covers some shortfalls of offset/limit while introducing a few of its own.</p>
<p>Cursor based pagination works by storing some state about the last record presented to the user and then basing the next query off of that state.</p>
<p>So instead of fetching <em>all</em> the records in order and discarding the first <code>N</code>, it fetches <em>only</em> the records after the last position <code>N</code>.</p>
<p>If sorted by ID, the SQL might look something like this:</p>
<pre class="language-sql"><code class="language-sql"><span class="token comment">-- Page 1</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> id <span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">limit</span> <span class="token number">15</span><span class="token punctuation">;</span>

<span class="token comment">-- Page 2 (Assuming the max ID from page one was 24.)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> id <span class="token operator">></span> <span class="token number">24</span> <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">limit</span> <span class="token number">15</span><span class="token punctuation">;</span>

<span class="token comment">-- Page 3 (Assuming the max ID from page two was 72.)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">where</span> id <span class="token operator">></span> <span class="token number">72</span> <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">limit</span> <span class="token number">15</span><span class="token punctuation">;</span>
</code></pre>
<p>You can probably already see the benefits. Because we know the last ID that we showed the user, we know the next page is going to start with an ID that is higher. We don't even have to inspect rows where the ID is lower, because we know with 100% certainty that those don't need to be shown.</p>
<p>In the example above, I specifically showed that the IDs may not be sequential, i.e. there may be missing records. This makes it impossible <em>calculate</em> what records will show up on a certain page, you have to keep track of what the last record on the page before it was.</p>
<p>Unlike offset / limit pagination, pages are not directly addressable when using cursor pagination, you can only navigate to "next" or "previous" pages.</p>
<p>Cursor pagination does have the benefit of being speedy across any number of pages though. It's also great for infinite scrolling, where pages don't need to be directly addressable in the first place.</p>
<p>The Laravel docs have some good context on the tradeoffs between offset and cursors: <a href="https://laravel.com/docs/8.x/pagination#cursor-vs-offset-pagination">https://laravel.com/docs/pagination#cursor-vs-offset-pagination</a></p>
<p>With all of that in mind, let's take a look at an offset / limit optimization that can make it performant enough to use across thousands of pages.</p>
<h2 id="offset--limit-with-deferred-joins"><a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#offset--limit-with-deferred-joins" title="Permalink">#</a>Offset / Limit with Deferred Joins<a aria-hidden="true" class="anchor-heading icon-link" href="#offset--limit-with-deferred-joins"></a></h2>
<p>A deferred join is a technique that defers access to requested columns until <em>after</em> the offset and limit have been applied.</p>
<p>Using this technique we create an inner query that can be optimized with specific indexes for maximum speed and then join the results back to the same table to fetch the full rows.</p>
<p>It looks something like this:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> contacts          <span class="token comment">-- The full data that you want to show your users.</span>
    <span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token punctuation">(</span>                <span class="token comment">-- The "deferred join."</span>
        <span class="token keyword">select</span> id <span class="token keyword">from</span> contacts <span class="token comment">-- The pagination using a fast index.</span>
            <span class="token keyword">order</span> <span class="token keyword">by</span> id
            <span class="token keyword">limit</span> <span class="token number">15</span> <span class="token keyword">offset</span> <span class="token number">150000</span>
    <span class="token punctuation">)</span> <span class="token keyword">as</span> tmp <span class="token keyword">using</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> id                     <span class="token comment">-- Order the single resulting page as well.</span>
</code></pre>
<p>The benefits can vary pretty wildly based on your dataset, but this method allows the database to examine as little data as possible satisfy the user's intent.</p>
<p>The "expensive" <code>select *</code> part of the query is <em>only</em> run on the 15 rows that match the inner query. The selection of all the data has been deferred, hence the name deferred join.</p>
<p>It's unlikely that this method will ever perform <em>worse</em> than traditional offset / limit, although it is possible, so be sure to test on your data!</p>
<h2 id="a-laravel-implementation"><a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#a-laravel-implementation" title="Permalink">#</a>A Laravel Implementation<a aria-hidden="true" class="anchor-heading icon-link" href="#a-laravel-implementation"></a></h2>
<p>How do we bring this to our favorite web frameworks like Laravel and Rails?</p>
<p>Let's look at Laravel specifically, because I don't know Rails.</p>
<p>(This is available as a package at <a href="https://github.com/hammerstonedev/fast-paginate">github.com/hammerstonedev/fast-paginate</a>)</p>
<p>Thanks to Laravel's macroable trait, we can extend the Eloquent Query Builder to add a new method called <code>fastPaginate</code>. We'll mimic the signature of the regular <code>paginate</code> for consistency:</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&#x3C;?php</span>
<span class="token comment">// Mimic the standard `paginate` signature.</span>
<span class="token scope">Builder<span class="token punctuation">::</span></span><span class="token function">macro</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'fastPaginate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$perPage</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token variable">$columns</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$pageName</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'page'</span><span class="token punctuation">,</span> <span class="token variable">$page</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Add our new pagination logic here.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Now you can use it on all your model queries.</span>
<span class="token scope">Contact<span class="token punctuation">::</span></span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">fastPaginate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token delimiter important">?></span></span>
</code></pre>
<p>We're going to try to do <em>as little custom work as possible</em> and leave most of it up to Laravel.</p>
<p>Here's what we're going to do:</p>
<ul>
<li>reset the <code>select</code> on the query to only select the primary key</li>
<li>run that modified query through the regular pagination process</li>
<li>take the resulting keys and run a second query to get full rows</li>
<li>combine the new records with the old paginator</li>
</ul>
<p>This should give us all the benefits of Laravel's <code>LengthAwarePaginator</code> <em>and</em> deferred joins!</p>
<p>Here's a basic representation (note that the package is more complex, and covers more edge cases!):</p>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&#x3C;?php</span>
<span class="token scope">Builder<span class="token punctuation">::</span></span><span class="token function">macro</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'fastPaginate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$perPage</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token variable">$columns</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$pageName</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'page'</span><span class="token punctuation">,</span> <span class="token variable">$page</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$model</span> <span class="token operator">=</span> <span class="token this">$this</span><span class="token operator">-></span><span class="token function">newModelInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token variable">$model</span><span class="token operator">-></span><span class="token function">getKeyName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$table</span> <span class="token operator">=</span> <span class="token variable">$model</span><span class="token operator">-></span><span class="token function">getTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$paginator</span> <span class="token operator">=</span> <span class="token this">$this</span><span class="token operator">-></span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// We don't need them for this query, they'll remain</span>
        <span class="token comment">// on the query that actually gets the records.</span>
        <span class="token operator">-></span><span class="token function">setEagerLoads</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">// Only select the primary key, we'll get the full</span>
        <span class="token comment">// records in a second query below.</span>
        <span class="token operator">-></span><span class="token function">paginate</span><span class="token punctuation">(</span><span class="token variable">$perPage</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string double-quoted-string">"<span class="token interpolation"><span class="token variable">$table</span></span>.<span class="token interpolation"><span class="token variable">$key</span></span>"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$pageName</span><span class="token punctuation">,</span> <span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add our values in directly using "raw," instead of adding new bindings.</span>
    <span class="token comment">// This is basically the `whereIntegerInRaw` that Laravel uses in some</span>
    <span class="token comment">// places, but we're not guaranteed the primary keys are integers, so</span>
    <span class="token comment">// we can't use that. We're sure that these values are safe because</span>
    <span class="token comment">// they came directly from the database in the first place.</span>
    <span class="token this">$this</span><span class="token operator">-></span><span class="token property">query</span><span class="token operator">-></span><span class="token property">wheres</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'type'</span>   <span class="token operator">=></span> <span class="token string single-quoted-string">'InRaw'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'column'</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"<span class="token interpolation"><span class="token variable">$table</span></span>.<span class="token interpolation"><span class="token variable">$key</span></span>"</span><span class="token punctuation">,</span>
        <span class="token comment">// Get the key values from the records on the *current* page, without mutating them.</span>
        <span class="token string single-quoted-string">'values'</span>  <span class="token operator">=></span> <span class="token variable">$paginator</span><span class="token operator">-></span><span class="token function">getCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token property">map</span><span class="token operator">-></span><span class="token function">getRawOriginal</span><span class="token punctuation">(</span><span class="token variable">$key</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'boolean'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'and'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// simplePaginate increments by one to see if there's another page. We'll</span>
    <span class="token comment">// decrement to counteract that since it's unnecessary in our situation.</span>
    <span class="token variable">$page</span> <span class="token operator">=</span> <span class="token this">$this</span><span class="token operator">-></span><span class="token function">simplePaginate</span><span class="token punctuation">(</span><span class="token variable">$paginator</span><span class="token operator">-></span><span class="token function">perPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$columns</span><span class="token punctuation">,</span> <span class="token variable">$pageName</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Create a new paginator so that we can put our full records in,</span>
    <span class="token comment">// not the ones that we modified to select only the primary key.</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LengthAwarePaginator</span><span class="token punctuation">(</span>
        <span class="token variable">$page</span><span class="token operator">-></span><span class="token function">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token variable">$paginator</span><span class="token operator">-></span><span class="token function">total</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token variable">$paginator</span><span class="token operator">-></span><span class="token function">perPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token variable">$paginator</span><span class="token operator">-></span><span class="token function">currentPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token variable">$paginator</span><span class="token operator">-></span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token scope">Relation<span class="token punctuation">::</span></span><span class="token function">macro</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'fastPaginate'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$perPage</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token variable">$columns</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$pageName</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'page'</span><span class="token punctuation">,</span> <span class="token variable">$page</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token this">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">HasManyThrough</span> <span class="token operator">||</span> <span class="token this">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">BelongsToMany</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token this">$this</span><span class="token operator">-></span><span class="token property">query</span><span class="token operator">-></span><span class="token function">addSelect</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-></span><span class="token function">shouldSelect</span><span class="token punctuation">(</span><span class="token variable">$columns</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">tap</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-></span><span class="token property">query</span><span class="token operator">-></span><span class="token function">fastPaginate</span><span class="token punctuation">(</span><span class="token variable">$perPage</span><span class="token punctuation">,</span> <span class="token variable">$columns</span><span class="token punctuation">,</span> <span class="token variable">$pageName</span><span class="token punctuation">,</span> <span class="token variable">$page</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$paginator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token this">$this</span> <span class="token keyword">instanceof</span> <span class="token class-name">BelongsToMany</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token this">$this</span><span class="token operator">-></span><span class="token function">hydratePivotRelation</span><span class="token punctuation">(</span><span class="token variable">$paginator</span><span class="token operator">-></span><span class="token function">items</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
</code></pre>
<p>You'll notice that we're actually not using a <code>join</code> here, but rather a <code>where in</code>. This is primarily because Laravel's paginator has already run the query, so we can just use the keys that were returned. We don't need to run the query again, so we don't. (We also have to add a macro to the Relation class, to mimic how Laravel works under the hood. Read more <a href="https://github.com/hammerstonedev/fast-paginate/pull/1">here</a>.)</p>
<blockquote>
<p>The Laravel code above works with integer and string primary keys, but it will not work with composite primary keys. That should be possible, but I haven't done it yet. I've tested this on several queries, but there are absolutely edge cases I haven't considered. Test it in your apps and please report any issues!</p>
</blockquote>
<p>We're not quite done yet though...</p>
<h2 id="deferred-joins-and-covering-indexes"><a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#deferred-joins-and-covering-indexes" title="Permalink">#</a>Deferred Joins and Covering Indexes<a aria-hidden="true" class="anchor-heading icon-link" href="#deferred-joins-and-covering-indexes"></a></h2>
<p>The main benefit of using deferred joins is reducing the amount of data that the database has to retrieve and then throw away. We can take this even further by helping the database get the data it needs <em>without ever fetching the underlying rows</em>.</p>
<p>The way to do that is called a "<strong>covering index</strong>," and it's the ultimate solution to ensure speedy offset / limit pagination.</p>
<p>A covering index is an index where all required fields for the query are contained in the index itself. When all parts of a query can be "covered" by an index, the database does not have to read the row at all, it can get everything it needs from the index.</p>
<p>Note that covering indexes aren't created in any special way. It only refers to the <em>situation</em> where a single index satisfies everything required by a query. A covering index on one query is likely not a covering index on another query.</p>
<p>In the next few examples we'll use this basic table, which I've filled with ~10 million rows:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>contacts<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>email<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>created_at<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>updated_at<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>users_email_unique<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>email<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre>
<p>Let's take a look at a simple query that selects only a column that is indexed. In this case we'll select <code>email</code> from the <code>contacts</code> table.</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">select</span> email <span class="token keyword">from</span> contacts <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre>
<p>In this case, the database will not have to read the underlying row at all. In MySQL, we can verify that by running an <code>explain</code> and looking at the <code>extra</code> column:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"select_type"</span><span class="token operator">:</span> <span class="token string">"SIMPLE"</span><span class="token punctuation">,</span>
  <span class="token property">"table"</span><span class="token operator">:</span> <span class="token string">"contacts"</span><span class="token punctuation">,</span>
  <span class="token property">"partitions"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"index"</span><span class="token punctuation">,</span>
  <span class="token property">"possible_keys"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"users_email_unique"</span><span class="token punctuation">,</span>
  <span class="token property">"key_len"</span><span class="token operator">:</span> <span class="token string">"1022"</span><span class="token punctuation">,</span>
  <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"rows"</span><span class="token operator">:</span> <span class="token number">10690173</span><span class="token punctuation">,</span>
  <span class="token property">"filtered"</span><span class="token operator">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
  <span class="token property">"Extra"</span><span class="token operator">:</span> <span class="token string">"Using index"</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Code highlighting powered by <a href="https://torchlight.dev/?ref=aaronfrancis.com">torchlight.dev</a> (A service I created!)</p>
<p>The <code>extra: using index</code> tells us that MySQL was able to satisfy the entire query using the index only, without looking at the underlying rows.</p>
<p>If we try <code>select name from contacts limit 10</code>, we would expect MySQL to have to go to the row to get the data since <code>name</code> is not indexed. That's exactly what happens, shown by the following explain:</p>
<pre class="language-sql"><code class="language-sql">{
    <span class="token string">"id"</span>: <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string">"select_type"</span>: <span class="token string">"SIMPLE"</span><span class="token punctuation">,</span>
    <span class="token string">"table"</span>: <span class="token string">"contacts"</span><span class="token punctuation">,</span>
    <span class="token string">"partitions"</span>: <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token string">"type"</span>: <span class="token string">"ALL"</span><span class="token punctuation">,</span>
    <span class="token string">"possible_keys"</span>: <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token string">"key"</span>: <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token string">"key_len"</span>: <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token string">"ref"</span>: <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token string">"rows"</span>: <span class="token number">10690173</span><span class="token punctuation">,</span>
    <span class="token string">"filtered"</span>: <span class="token number">100.00</span><span class="token punctuation">,</span>
    <span class="token string">"Extra"</span>: <span class="token boolean">null</span>
}
</code></pre>
<p>The <code>extra</code> no longer says <code>using index</code>, so we did not use a covering index.</p>
<p>In the case of a covering index used for pagination, you have to be careful to <em>only</em> use the columns that are available in your index, otherwise you may force the database to read the rows.</p>
<p>Assuming you have 15 records per page and your user wants to view page 10,001, your inner query would end up looking like this:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">select</span> id <span class="token keyword">from</span> contacts <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">limit</span> <span class="token number">15</span> <span class="token keyword">OFFSET</span> <span class="token number">150000</span>
</code></pre>
<p>And the <code>explain</code>, again, shows the use of a covered index</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"select_type"</span><span class="token operator">:</span> <span class="token string">"SIMPLE"</span><span class="token punctuation">,</span>
  <span class="token property">"table"</span><span class="token operator">:</span> <span class="token string">"contacts"</span><span class="token punctuation">,</span>
  <span class="token property">"partitions"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"index"</span><span class="token punctuation">,</span>
  <span class="token property">"possible_keys"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"PRIMARY"</span><span class="token punctuation">,</span>
  <span class="token property">"key_len"</span><span class="token operator">:</span> <span class="token string">"8"</span><span class="token punctuation">,</span>
  <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"rows"</span><span class="token operator">:</span> <span class="token number">150015</span><span class="token punctuation">,</span>
  <span class="token property">"filtered"</span><span class="token operator">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
  <span class="token property">"Extra"</span><span class="token operator">:</span> <span class="token string">"Using index"</span>
<span class="token punctuation">}</span>
</code></pre>
<p>MySQL is able to perform this query looking at the index alone. It does not simply skip the first 150,000 rows, there's no way around that with offset, but it does not have to <em>read</em> 150,000 rows. (Only cursor pagination lets you skip rows altogether.)</p>
<p>Even when using covering indexes and deferred joins, the results will slow down as you reach later pages, although it should be minimal compared to traditional offset / limit. You can easily go thousands of pages deep using these methods.</p>
<h2 id="better-covering-indexes"><a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#better-covering-indexes" title="Permalink">#</a>Better Covering Indexes<a aria-hidden="true" class="anchor-heading icon-link" href="#better-covering-indexes"></a></h2>
<p>A lot of the benefit here depends on having good covering indexes, so let's talk about that for a bit. Everything depends on your data and the usage patterns of your users, but there are a few things you can do to ensure the highest hit-rate on your queries.</p>
<p>This is going to primarily speak to MySQL, as that's where I have experience. Things are likely to be different in other databases.</p>
<h3 id="multi-column-indexes"><a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#multi-column-indexes" title="Permalink">#</a>Multi-Column Indexes<a aria-hidden="true" class="anchor-heading icon-link" href="#multi-column-indexes"></a></h3>
<p>Most developers are accustomed to adding indexes to single columns, but there's nothing stopping you from adding indexes to multiple columns. In fact, if you're aiming to create a covering index for an expensive pagination query, you're almost certainly going to need a multi-column index.</p>
<p>When you're trying to optimize an index for pagination, be sure to put the <code>order by</code> column at the very end. If your users are going to be ordering by <code>updated_at</code>, that should be the last column in your composite index.</p>
<p>Look at the following index that includes three columns:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> contacts <span class="token keyword">add</span> <span class="token keyword">index</span> <span class="token punctuation">`</span>composite<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>is_deleted<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>is_archived<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>updated_at<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Or done in Laravel:</p>
<pre class="language-php"><code class="language-php"><span class="token variable">$table</span><span class="token operator">-></span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'is_deleted'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'is_archived'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'updated_at'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'composite'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>In MySQL, <strong>composite indexes are accessed left to right, and MySQL stops using an index if a column is missing, or after the first range condition.</strong></p>
<p>MySQL will be able to use this index in the following scenarios:</p>
<ul>
<li>You query against <code>is_deleted</code></li>
<li>You query against <code>is_deleted</code> and <code>is_archived</code></li>
<li>You query against <code>is_deleted</code> and <code>is_archived</code> and <code>updated_at</code></li>
<li>You query against <code>is_deleted</code> and <code>is_archived</code> and order by <code>updated_at</code></li>
</ul>
<p>If you skip <code>is_archived</code>, MySQL won't be able to access <code>updated_at</code> and will have to resort to sorting without that index or not use that index at all, so make sure you plan accordingly.</p>
<h3 id="the-primary-key-is-always-there"><a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#the-primary-key-is-always-there" title="Permalink">#</a>The Primary Key is Always There<a aria-hidden="true" class="anchor-heading icon-link" href="#the-primary-key-is-always-there"></a></h3>
<p>In the case of MySQL's InnoDB, <strong>all indexes have the primary key appended</strong>. That means that an index on <code>(email)</code> is actually an index on <code>(email, id)</code>, which is pretty important when it comes to covering indexes and deferred joins.</p>
<p>The query <code>select email from contacts order by id</code> is completely covered by a single index on <code>email</code>, because InnoDB appends <code>id</code> to that index!</p>
<p>Using our composite example from above, you can see where this is beneficial:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">select</span>
  id                   <span class="token comment">-- implicitly in the index</span>
<span class="token keyword">from</span>
  contacts
<span class="token keyword">where</span>
  is_deleted <span class="token operator">=</span> <span class="token number">0</span>       <span class="token comment">-- explicitly in the index</span>
  <span class="token operator">and</span> is_archived <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment">-- explicitly in the index</span>
<span class="token keyword">order</span> <span class="token keyword">by</span>
  updated_at <span class="token keyword">desc</span>      <span class="token comment">-- explicitly in the index</span>
</code></pre>
<p>Because the composite index covers <code>is_deleted</code>, <code>is_archived</code>, <code>updated_at</code>, and (by function of InnoDB) <code>id</code>, this entire query can be satisfied by index alone.</p>
<h3 id="descending-indexes"><a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#descending-indexes" title="Permalink">#</a>Descending Indexes<a aria-hidden="true" class="anchor-heading icon-link" href="#descending-indexes"></a></h3>
<p>Most of the time, users are looking for the "newest" items, i.e. the most recently updated or created items, which can be satisfied by ordering by <code>updated_at DESC</code>.</p>
<p>If you know that your users are going to be primarily sorting their results in descending order, it might make sense to specifically make your index a descending index.</p>
<blockquote>
<p>MySQL 8 is the first MySQL version to support descending indexes.</p>
</blockquote>
<p>If you see <code>Backward index scan</code> in the <code>Extra</code> section of your explain, you might be able to configure a better index.</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"select_type"</span><span class="token operator">:</span> <span class="token string">"SIMPLE"</span><span class="token punctuation">,</span>
  <span class="token property">"table"</span><span class="token operator">:</span> <span class="token string">"contacts"</span><span class="token punctuation">,</span>
  <span class="token property">"partitions"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"index"</span><span class="token punctuation">,</span>
  <span class="token property">"possible_keys"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"users_email_unique"</span><span class="token punctuation">,</span>
  <span class="token property">"key_len"</span><span class="token operator">:</span> <span class="token string">"1022"</span><span class="token punctuation">,</span>
  <span class="token property">"ref"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">"rows"</span><span class="token operator">:</span> <span class="token number">10690173</span><span class="token punctuation">,</span>
  <span class="token property">"filtered"</span><span class="token operator">:</span> <span class="token number">100.0</span><span class="token punctuation">,</span>
  <span class="token property">"Extra"</span><span class="token operator">:</span> <span class="token string">"Backward index scan; Using index"</span>
<span class="token punctuation">}</span>
</code></pre>
<p>To declare an index as descending, you can just add <code>DESC</code> to your index statement. To do it in Laravel, you'll need to reach for the <code>DB::raw()</code> method:</p>
<pre class="language-php"><code class="language-php"><span class="token variable">$table</span><span class="token operator">-></span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'is_deleted'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'is_archived'</span><span class="token punctuation">,</span> <span class="token scope">DB<span class="token punctuation">::</span></span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'`updated_at` DESC'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'composite'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Forward index scans are <a href="https://dev.mysql.com/blog-archive/mysql-8-0-labs-descending-indexes-in-mysql/">~15% faster than backward scans</a>, so you'll want to add the index in the order that you think your users will use most often, and take the penalty for the minority use case.</p>
<h2 id="nothing-new-under-the-sun"><a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#nothing-new-under-the-sun" title="Permalink">#</a>Nothing New Under the Sun<a aria-hidden="true" class="anchor-heading icon-link" href="#nothing-new-under-the-sun"></a></h2>
<p>This method of using offset / limit pagination with deferred joins and covering indexes isn't a silver bullet.</p>
<p>Deferred joins alone can probably get you a nice boost in speed, but it takes some extra thought to design the right indexes to get you the maximum benefit.</p>
<p>An argument could be made that deferred joins should be the default offset / limit method in frameworks, and any time a covering index hits it's just a bonus. I haven't tested in enough production environments to strongly advocate for that yet.</p>
<p>Finally, before you shower me with applause and accolades, please understand that this is not an original concept! The basic idea is outlined in a book called "<a href="https://amzn.to/3fwWavn">High Performance MySQL, 3rd Edition</a>." (There is also a <a href="https://amzn.to/3qxmHyW">4th edition</a> now.)</p>
<p>I read this book a while ago and kind of forgot about this little method. Then, a few days ago, I was helping a friend optimize their Laravel + MySQL app and we ran into this exact problem, where page 1 worked fine and page 3,231 never loaded.</p>
<p>I remembered some obscure thing I had read, so I went back to the book to look it up and figured out how to implement it in Laravel, against their dataset.</p>
<p>I love reading physical technical books for this reason. I had highlighted that part as potentially interesting, not knowing when I'd really need it, but I was aware vaguely that some solution existed. Then when it was time to use it I could just go look it up!</p>
<p>I highly recommend that MySQL book, by the way.</p>
<p>If you need help optimizing your Laravel and MySQL applications, please reach out to me <a href="https://twitter.com/aarondfrancis">on Twitter</a>. I'm available for day-long performance engagements. I'm also working on a MySQL video course, which you can sign up for below!</p>
<p>window.Reform=window.Reform||function(){(Reform.q=Reform.q||[]).push(arguments)}; Reform('init', { url: '<a href="https://forms.reform.app/uVXl5x/mysql-early-access&#x27;">https://forms.reform.app/uVXl5x/mysql-early-access'</a>, target: '#my-reform', background: 'transparent', })</p>
<h2 id="results"><a href="https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#results">Results</a><a aria-hidden="true" class="anchor-heading icon-link" href="#results"></a></h2>
<p>I'll be adding some results here as they come in.</p>
<ul>
<li>
<p>28 seconds → 2 seconds</p>
</li>
<li>
<p>7.5x improvement</p>
</li>
<li>
<p>1100ms --> 100ms</p>
</li>
<li>
<p>20s --> 2s</p>
</li>
<li>
<p>10x improvement</p>
</li>
<li>
<p>"Very helpful"</p>
</li>
</ul></div></div><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-0 ant-col-md-6"><div><div class=""><div class="ant-anchor-wrapper dendron-toc" style="max-height:calc(100vh - 64px);z-index:1"><div class="ant-anchor"><div class="ant-anchor-ink"><span class="ant-anchor-ink-ball"></span></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#offset--limit-pagination" title="#Offset / Limit Pagination">#Offset / Limit Pagination</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#cursor-based-pagination" title="#Cursor Based Pagination">#Cursor Based Pagination</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#offset--limit-with-deferred-joins" title="#Offset / Limit with Deferred Joins">#Offset / Limit with Deferred Joins</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#a-laravel-implementation" title="#A Laravel Implementation">#A Laravel Implementation</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#deferred-joins-and-covering-indexes" title="#Deferred Joins and Covering Indexes">#Deferred Joins and Covering Indexes</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#better-covering-indexes" title="#Better Covering Indexes">#Better Covering Indexes</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#multi-column-indexes" title="#Multi-Column Indexes">#Multi-Column Indexes</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#the-primary-key-is-always-there" title="#The Primary Key is Always There">#The Primary Key is Always There</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#descending-indexes" title="#Descending Indexes">#Descending Indexes</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#nothing-new-under-the-sun" title="#Nothing New Under the Sun">#Nothing New Under the Sun</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#results" title="Results">Results</a></div></div></div></div></div></div></div></div></div></div></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><footer class="ant-layout-footer" style="padding:0 24px 24px"></footer></main></section></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"note":{"id":"pytn4f8md64usu5rf6luoce","title":"Efficient Pagination Using Deferred Joins","desc":"","updated":1661304623787,"created":1661304184678,"custom":{},"fname":"dev.db.Efficient Pagination Using Deferred Joins","type":"note","vault":{"fsPath":"vault"},"contentHash":"b1050706e4f9bb553852720c317dc238","links":[],"anchors":{"offset--limit-pagination":{"type":"header","text":"#Offset / Limit Pagination","value":"offset--limit-pagination","line":16,"column":0,"depth":2},"cursor-based-pagination":{"type":"header","text":"#Cursor Based Pagination","value":"cursor-based-pagination","line":43,"column":0,"depth":2},"offset--limit-with-deferred-joins":{"type":"header","text":"#Offset / Limit with Deferred Joins","value":"offset--limit-with-deferred-joins","line":76,"column":0,"depth":2},"a-laravel-implementation":{"type":"header","text":"#A Laravel Implementation","value":"a-laravel-implementation","line":100,"column":0,"depth":2},"deferred-joins-and-covering-indexes":{"type":"header","text":"#Deferred Joins and Covering Indexes","value":"deferred-joins-and-covering-indexes","line":198,"column":0,"depth":2},"better-covering-indexes":{"type":"header","text":"#Better Covering Indexes","value":"better-covering-indexes","line":303,"column":0,"depth":2},"multi-column-indexes":{"type":"header","text":"#Multi-Column Indexes","value":"multi-column-indexes","line":309,"column":0,"depth":3},"the-primary-key-is-always-there":{"type":"header","text":"#The Primary Key is Always There","value":"the-primary-key-is-always-there","line":338,"column":0,"depth":3},"descending-indexes":{"type":"header","text":"#Descending Indexes","value":"descending-indexes","line":360,"column":0,"depth":3},"nothing-new-under-the-sun":{"type":"header","text":"#Nothing New Under the Sun","value":"nothing-new-under-the-sun","line":395,"column":0,"depth":2},"results":{"type":"header","text":"Results","value":"results","line":417,"column":0,"depth":2}},"children":[],"parent":"eha8xvsaz0zdh4f18pqqls2","data":{}},"body":"\u003ch1 id=\"efficient-pagination-using-deferred-joins\"\u003eEfficient Pagination Using Deferred Joins\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#efficient-pagination-using-deferred-joins\"\u003e\u003c/a\u003e\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins\"\u003ehttps://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003ePaginating records across large datasets in a web application seems like an easy problem that can actually be pretty tough to scale. The two main pagination strategies are offset/limit and cursors.\u003c/p\u003e\n\u003cp\u003eWe'll first take a look at the two methods and then a slight modification that can make offset/limit extremely performant.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eI want to hear your feedback on the method I'm proposing in this article, please tweet at me! \u003ca href=\"https://twitter.com/aarondfrancis\"\u003etwitter.com/aarondfrancis\u003c/a\u003e. I'll be adding them to the \u003ca href=\"https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#results\"\u003eresults\u003c/a\u003e section at the bottom of this page.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"offset--limit-pagination\"\u003e\u003ca href=\"https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#offset--limit-pagination\" title=\"Permalink\"\u003e#\u003c/a\u003eOffset / Limit Pagination\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#offset--limit-pagination\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eThe offset/limit approach is by far the most common, and works by skipping a certain number of records (pages) and limiting the results to one page.\u003c/p\u003e\n\u003cp\u003eAs an example, imagine your application is configured to show 15 records per page. Your SQL would look like this:\u003c/p\u003e\n\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token comment\"\u003e-- Page 1\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e users \u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e created_at \u003cspan class=\"token keyword\"\u003edesc\u003c/span\u003e \u003cspan class=\"token keyword\"\u003elimit\u003c/span\u003e \u003cspan class=\"token number\"\u003e15\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eoffset\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e-- Page 2\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e users \u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e created_at \u003cspan class=\"token keyword\"\u003edesc\u003c/span\u003e \u003cspan class=\"token keyword\"\u003elimit\u003c/span\u003e \u003cspan class=\"token number\"\u003e15\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eoffset\u003c/span\u003e \u003cspan class=\"token number\"\u003e15\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e-- Page 3\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e users \u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e created_at \u003cspan class=\"token keyword\"\u003edesc\u003c/span\u003e \u003cspan class=\"token keyword\"\u003elimit\u003c/span\u003e \u003cspan class=\"token number\"\u003e15\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eoffset\u003c/span\u003e \u003cspan class=\"token number\"\u003e30\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is the most common because it's extremely straightforward, easy to reason about, and almost every framework supports it.\u003c/p\u003e\n\u003cp\u003eIn addition to being easy to implement, it also has the nice advantage that pages are directly addressable. For example, if you want to navigate \u003cem\u003edirectly\u003c/em\u003e to page 20, you can do that because that offset is calculable very easily.\u003c/p\u003e\n\u003cp\u003eThere is a major drawback though, and it lurks in the way that databases handle offsets. \u003ccode\u003eOffset\u003c/code\u003e tells the database to discard the first \u003ccode\u003eN\u003c/code\u003e results that are returned from a query. The database still has to fetch those rows from disk though.\u003c/p\u003e\n\u003cp\u003eThis doesn't matter much if you're discarding 100 rows, but if you're discarding 100,000 rows the database is doing \u003cstrong\u003ea lot\u003c/strong\u003e of work just to throw away the results.\u003c/p\u003e\n\u003cp\u003eIn practice, this means that the first page will load quickly and every page after that will get slower and slower, until you reach a point where the web requests may simply time out.\u003c/p\u003e\n\u003ch2 id=\"cursor-based-pagination\"\u003e\u003ca href=\"https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#cursor-based-pagination\" title=\"Permalink\"\u003e#\u003c/a\u003eCursor Based Pagination\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#cursor-based-pagination\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eCursor based pagination covers some shortfalls of offset/limit while introducing a few of its own.\u003c/p\u003e\n\u003cp\u003eCursor based pagination works by storing some state about the last record presented to the user and then basing the next query off of that state.\u003c/p\u003e\n\u003cp\u003eSo instead of fetching \u003cem\u003eall\u003c/em\u003e the records in order and discarding the first \u003ccode\u003eN\u003c/code\u003e, it fetches \u003cem\u003eonly\u003c/em\u003e the records after the last position \u003ccode\u003eN\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eIf sorted by ID, the SQL might look something like this:\u003c/p\u003e\n\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token comment\"\u003e-- Page 1\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e users \u003cspan class=\"token keyword\"\u003ewhere\u003c/span\u003e id \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e id \u003cspan class=\"token keyword\"\u003elimit\u003c/span\u003e \u003cspan class=\"token number\"\u003e15\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e-- Page 2 (Assuming the max ID from page one was 24.)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e users \u003cspan class=\"token keyword\"\u003ewhere\u003c/span\u003e id \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token number\"\u003e24\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e id \u003cspan class=\"token keyword\"\u003elimit\u003c/span\u003e \u003cspan class=\"token number\"\u003e15\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e-- Page 3 (Assuming the max ID from page two was 72.)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e users \u003cspan class=\"token keyword\"\u003ewhere\u003c/span\u003e id \u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token number\"\u003e72\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e id \u003cspan class=\"token keyword\"\u003elimit\u003c/span\u003e \u003cspan class=\"token number\"\u003e15\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can probably already see the benefits. Because we know the last ID that we showed the user, we know the next page is going to start with an ID that is higher. We don't even have to inspect rows where the ID is lower, because we know with 100% certainty that those don't need to be shown.\u003c/p\u003e\n\u003cp\u003eIn the example above, I specifically showed that the IDs may not be sequential, i.e. there may be missing records. This makes it impossible \u003cem\u003ecalculate\u003c/em\u003e what records will show up on a certain page, you have to keep track of what the last record on the page before it was.\u003c/p\u003e\n\u003cp\u003eUnlike offset / limit pagination, pages are not directly addressable when using cursor pagination, you can only navigate to \"next\" or \"previous\" pages.\u003c/p\u003e\n\u003cp\u003eCursor pagination does have the benefit of being speedy across any number of pages though. It's also great for infinite scrolling, where pages don't need to be directly addressable in the first place.\u003c/p\u003e\n\u003cp\u003eThe Laravel docs have some good context on the tradeoffs between offset and cursors: \u003ca href=\"https://laravel.com/docs/8.x/pagination#cursor-vs-offset-pagination\"\u003ehttps://laravel.com/docs/pagination#cursor-vs-offset-pagination\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eWith all of that in mind, let's take a look at an offset / limit optimization that can make it performant enough to use across thousands of pages.\u003c/p\u003e\n\u003ch2 id=\"offset--limit-with-deferred-joins\"\u003e\u003ca href=\"https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#offset--limit-with-deferred-joins\" title=\"Permalink\"\u003e#\u003c/a\u003eOffset / Limit with Deferred Joins\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#offset--limit-with-deferred-joins\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eA deferred join is a technique that defers access to requested columns until \u003cem\u003eafter\u003c/em\u003e the offset and limit have been applied.\u003c/p\u003e\n\u003cp\u003eUsing this technique we create an inner query that can be optimized with specific indexes for maximum speed and then join the results back to the same table to fetch the full rows.\u003c/p\u003e\n\u003cp\u003eIt looks something like this:\u003c/p\u003e\n\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e contacts          \u003cspan class=\"token comment\"\u003e-- The full data that you want to show your users.\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003einner\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ejoin\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e                \u003cspan class=\"token comment\"\u003e-- The \"deferred join.\"\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e id \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e contacts \u003cspan class=\"token comment\"\u003e-- The pagination using a fast index.\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e id\n            \u003cspan class=\"token keyword\"\u003elimit\u003c/span\u003e \u003cspan class=\"token number\"\u003e15\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eoffset\u003c/span\u003e \u003cspan class=\"token number\"\u003e150000\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e tmp \u003cspan class=\"token keyword\"\u003eusing\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e id                     \u003cspan class=\"token comment\"\u003e-- Order the single resulting page as well.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe benefits can vary pretty wildly based on your dataset, but this method allows the database to examine as little data as possible satisfy the user's intent.\u003c/p\u003e\n\u003cp\u003eThe \"expensive\" \u003ccode\u003eselect *\u003c/code\u003e part of the query is \u003cem\u003eonly\u003c/em\u003e run on the 15 rows that match the inner query. The selection of all the data has been deferred, hence the name deferred join.\u003c/p\u003e\n\u003cp\u003eIt's unlikely that this method will ever perform \u003cem\u003eworse\u003c/em\u003e than traditional offset / limit, although it is possible, so be sure to test on your data!\u003c/p\u003e\n\u003ch2 id=\"a-laravel-implementation\"\u003e\u003ca href=\"https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#a-laravel-implementation\" title=\"Permalink\"\u003e#\u003c/a\u003eA Laravel Implementation\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#a-laravel-implementation\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eHow do we bring this to our favorite web frameworks like Laravel and Rails?\u003c/p\u003e\n\u003cp\u003eLet's look at Laravel specifically, because I don't know Rails.\u003c/p\u003e\n\u003cp\u003e(This is available as a package at \u003ca href=\"https://github.com/hammerstonedev/fast-paginate\"\u003egithub.com/hammerstonedev/fast-paginate\u003c/a\u003e)\u003c/p\u003e\n\u003cp\u003eThanks to Laravel's macroable trait, we can extend the Eloquent Query Builder to add a new method called \u003ccode\u003efastPaginate\u003c/code\u003e. We'll mimic the signature of the regular \u003ccode\u003epaginate\u003c/code\u003e for consistency:\u003c/p\u003e\n\u003cpre class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token php language-php\"\u003e\u003cspan class=\"token delimiter important\"\u003e\u0026#x3C;?php\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// Mimic the standard `paginate` signature.\u003c/span\u003e\n\u003cspan class=\"token scope\"\u003eBuilder\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003emacro\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'fastPaginate'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$perPage\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token constant\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$columns\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'*'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$pageName\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'page'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$page\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token constant\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// Add our new pagination logic here.\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Now you can use it on all your model queries.\u003c/span\u003e\n\u003cspan class=\"token scope\"\u003eContact\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003equery\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003efastPaginate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token delimiter important\"\u003e?\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe're going to try to do \u003cem\u003eas little custom work as possible\u003c/em\u003e and leave most of it up to Laravel.\u003c/p\u003e\n\u003cp\u003eHere's what we're going to do:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ereset the \u003ccode\u003eselect\u003c/code\u003e on the query to only select the primary key\u003c/li\u003e\n\u003cli\u003erun that modified query through the regular pagination process\u003c/li\u003e\n\u003cli\u003etake the resulting keys and run a second query to get full rows\u003c/li\u003e\n\u003cli\u003ecombine the new records with the old paginator\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis should give us all the benefits of Laravel's \u003ccode\u003eLengthAwarePaginator\u003c/code\u003e \u003cem\u003eand\u003c/em\u003e deferred joins!\u003c/p\u003e\n\u003cp\u003eHere's a basic representation (note that the package is more complex, and covers more edge cases!):\u003c/p\u003e\n\u003cpre class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token php language-php\"\u003e\u003cspan class=\"token delimiter important\"\u003e\u0026#x3C;?php\u003c/span\u003e\n\u003cspan class=\"token scope\"\u003eBuilder\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003emacro\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'fastPaginate'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$perPage\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token constant\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$columns\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'*'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$pageName\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'page'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$page\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token constant\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$model\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token this\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003enewModelInstance\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$key\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$model\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egetKeyName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$table\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$model\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egetTable\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token variable\"\u003e$paginator\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token this\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eclone\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// We don't need them for this query, they'll remain\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// on the query that actually gets the records.\u003c/span\u003e\n        \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003esetEagerLoads\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// Only select the primary key, we'll get the full\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// records in a second query below.\u003c/span\u003e\n        \u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003epaginate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$perPage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string double-quoted-string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token variable\"\u003e$table\u003c/span\u003e\u003c/span\u003e.\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token variable\"\u003e$key\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$pageName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$page\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// Add our values in directly using \"raw,\" instead of adding new bindings.\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// This is basically the `whereIntegerInRaw` that Laravel uses in some\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// places, but we're not guaranteed the primary keys are integers, so\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// we can't use that. We're sure that these values are safe because\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// they came directly from the database in the first place.\u003c/span\u003e\n    \u003cspan class=\"token this\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token property\"\u003equery\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token property\"\u003ewheres\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"token string single-quoted-string\"\u003e'type'\u003c/span\u003e   \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'InRaw'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token string single-quoted-string\"\u003e'column'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token string double-quoted-string\"\u003e\"\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token variable\"\u003e$table\u003c/span\u003e\u003c/span\u003e.\u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token variable\"\u003e$key\u003c/span\u003e\u003c/span\u003e\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// Get the key values from the records on the *current* page, without mutating them.\u003c/span\u003e\n        \u003cspan class=\"token string single-quoted-string\"\u003e'values'\u003c/span\u003e  \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$paginator\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egetCollection\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token property\"\u003emap\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egetRawOriginal\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$key\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003etoArray\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token string single-quoted-string\"\u003e'boolean'\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'and'\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// simplePaginate increments by one to see if there's another page. We'll\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// decrement to counteract that since it's unnecessary in our situation.\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$page\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token this\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003esimplePaginate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$paginator\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eperPage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$columns\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$pageName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// Create a new paginator so that we can put our full records in,\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// not the ones that we modified to select only the primary key.\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eLengthAwarePaginator\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$page\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eitems\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$paginator\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003etotal\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$paginator\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eperPage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$paginator\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003ecurrentPage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$paginator\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003egetOptions\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token scope\"\u003eRelation\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003emacro\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'fastPaginate'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$perPage\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token constant\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$columns\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'*'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$pageName\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'page'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$page\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token constant\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token this\"\u003e$this\u003c/span\u003e \u003cspan class=\"token keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eHasManyThrough\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e \u003cspan class=\"token this\"\u003e$this\u003c/span\u003e \u003cspan class=\"token keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBelongsToMany\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token this\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token property\"\u003equery\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddSelect\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token this\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eshouldSelect\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$columns\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003etap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token this\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token property\"\u003equery\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003efastPaginate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$perPage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$columns\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$pageName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$page\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$paginator\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token this\"\u003e$this\u003c/span\u003e \u003cspan class=\"token keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBelongsToMany\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token this\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003ehydratePivotRelation\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$paginator\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eitems\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token delimiter important\"\u003e?\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou'll notice that we're actually not using a \u003ccode\u003ejoin\u003c/code\u003e here, but rather a \u003ccode\u003ewhere in\u003c/code\u003e. This is primarily because Laravel's paginator has already run the query, so we can just use the keys that were returned. We don't need to run the query again, so we don't. (We also have to add a macro to the Relation class, to mimic how Laravel works under the hood. Read more \u003ca href=\"https://github.com/hammerstonedev/fast-paginate/pull/1\"\u003ehere\u003c/a\u003e.)\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eThe Laravel code above works with integer and string primary keys, but it will not work with composite primary keys. That should be possible, but I haven't done it yet. I've tested this on several queries, but there are absolutely edge cases I haven't considered. Test it in your apps and please report any issues!\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eWe're not quite done yet though...\u003c/p\u003e\n\u003ch2 id=\"deferred-joins-and-covering-indexes\"\u003e\u003ca href=\"https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#deferred-joins-and-covering-indexes\" title=\"Permalink\"\u003e#\u003c/a\u003eDeferred Joins and Covering Indexes\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#deferred-joins-and-covering-indexes\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eThe main benefit of using deferred joins is reducing the amount of data that the database has to retrieve and then throw away. We can take this even further by helping the database get the data it needs \u003cem\u003ewithout ever fetching the underlying rows\u003c/em\u003e.\u003c/p\u003e\n\u003cp\u003eThe way to do that is called a \"\u003cstrong\u003ecovering index\u003c/strong\u003e,\" and it's the ultimate solution to ensure speedy offset / limit pagination.\u003c/p\u003e\n\u003cp\u003eA covering index is an index where all required fields for the query are contained in the index itself. When all parts of a query can be \"covered\" by an index, the database does not have to read the row at all, it can get everything it needs from the index.\u003c/p\u003e\n\u003cp\u003eNote that covering indexes aren't created in any special way. It only refers to the \u003cem\u003esituation\u003c/em\u003e where a single index satisfies everything required by a query. A covering index on one query is likely not a covering index on another query.\u003c/p\u003e\n\u003cp\u003eIn the next few examples we'll use this basic table, which I've filled with ~10 million rows:\u003c/p\u003e\n\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token keyword\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eTABLE\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003econtacts\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ebigint\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"token operator\"\u003eNOT\u003c/span\u003e \u003cspan class=\"token boolean\"\u003eNULL\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eAUTO_INCREMENT\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003ename\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evarchar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e255\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eDEFAULT\u003c/span\u003e \u003cspan class=\"token boolean\"\u003eNULL\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003eemail\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003e \u003cspan class=\"token keyword\"\u003evarchar\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e255\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003eNOT\u003c/span\u003e \u003cspan class=\"token boolean\"\u003eNULL\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003ecreated_at\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etimestamp\u003c/span\u003e \u003cspan class=\"token boolean\"\u003eNULL\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003eupdated_at\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etimestamp\u003c/span\u003e \u003cspan class=\"token boolean\"\u003eNULL\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ePRIMARY\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eKEY\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003eid\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eUNIQUE\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eKEY\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003eusers_email_unique\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003eemail\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLet's take a look at a simple query that selects only a column that is indexed. In this case we'll select \u003ccode\u003eemail\u003c/code\u003e from the \u003ccode\u003econtacts\u003c/code\u003e table.\u003c/p\u003e\n\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e email \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e contacts \u003cspan class=\"token keyword\"\u003elimit\u003c/span\u003e \u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn this case, the database will not have to read the underlying row at all. In MySQL, we can verify that by running an \u003ccode\u003eexplain\u003c/code\u003e and looking at the \u003ccode\u003eextra\u003c/code\u003e column:\u003c/p\u003e\n\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"id\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"select_type\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"SIMPLE\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"table\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"contacts\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"partitions\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token null keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"type\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"index\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"possible_keys\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token null keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"key\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"users_email_unique\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"key_len\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"1022\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"ref\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token null keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"rows\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e10690173\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"filtered\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e100.0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"Extra\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Using index\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eCode highlighting powered by \u003ca href=\"https://torchlight.dev/?ref=aaronfrancis.com\"\u003etorchlight.dev\u003c/a\u003e (A service I created!)\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003eextra: using index\u003c/code\u003e tells us that MySQL was able to satisfy the entire query using the index only, without looking at the underlying rows.\u003c/p\u003e\n\u003cp\u003eIf we try \u003ccode\u003eselect name from contacts limit 10\u003c/code\u003e, we would expect MySQL to have to go to the row to get the data since \u003ccode\u003ename\u003c/code\u003e is not indexed. That's exactly what happens, shown by the following explain:\u003c/p\u003e\n\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003e{\n    \u003cspan class=\"token string\"\u003e\"id\"\u003c/span\u003e: \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"select_type\"\u003c/span\u003e: \u003cspan class=\"token string\"\u003e\"SIMPLE\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"table\"\u003c/span\u003e: \u003cspan class=\"token string\"\u003e\"contacts\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"partitions\"\u003c/span\u003e: \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"type\"\u003c/span\u003e: \u003cspan class=\"token string\"\u003e\"ALL\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"possible_keys\"\u003c/span\u003e: \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"key\"\u003c/span\u003e: \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"key_len\"\u003c/span\u003e: \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"ref\"\u003c/span\u003e: \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"rows\"\u003c/span\u003e: \u003cspan class=\"token number\"\u003e10690173\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"filtered\"\u003c/span\u003e: \u003cspan class=\"token number\"\u003e100.00\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"Extra\"\u003c/span\u003e: \u003cspan class=\"token boolean\"\u003enull\u003c/span\u003e\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe \u003ccode\u003eextra\u003c/code\u003e no longer says \u003ccode\u003eusing index\u003c/code\u003e, so we did not use a covering index.\u003c/p\u003e\n\u003cp\u003eIn the case of a covering index used for pagination, you have to be careful to \u003cem\u003eonly\u003c/em\u003e use the columns that are available in your index, otherwise you may force the database to read the rows.\u003c/p\u003e\n\u003cp\u003eAssuming you have 15 records per page and your user wants to view page 10,001, your inner query would end up looking like this:\u003c/p\u003e\n\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e id \u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e contacts \u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e id \u003cspan class=\"token keyword\"\u003elimit\u003c/span\u003e \u003cspan class=\"token number\"\u003e15\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eOFFSET\u003c/span\u003e \u003cspan class=\"token number\"\u003e150000\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd the \u003ccode\u003eexplain\u003c/code\u003e, again, shows the use of a covered index\u003c/p\u003e\n\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"id\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"select_type\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"SIMPLE\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"table\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"contacts\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"partitions\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token null keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"type\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"index\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"possible_keys\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token null keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"key\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"PRIMARY\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"key_len\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"8\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"ref\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token null keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"rows\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e150015\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"filtered\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e100.0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"Extra\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Using index\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eMySQL is able to perform this query looking at the index alone. It does not simply skip the first 150,000 rows, there's no way around that with offset, but it does not have to \u003cem\u003eread\u003c/em\u003e 150,000 rows. (Only cursor pagination lets you skip rows altogether.)\u003c/p\u003e\n\u003cp\u003eEven when using covering indexes and deferred joins, the results will slow down as you reach later pages, although it should be minimal compared to traditional offset / limit. You can easily go thousands of pages deep using these methods.\u003c/p\u003e\n\u003ch2 id=\"better-covering-indexes\"\u003e\u003ca href=\"https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#better-covering-indexes\" title=\"Permalink\"\u003e#\u003c/a\u003eBetter Covering Indexes\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#better-covering-indexes\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eA lot of the benefit here depends on having good covering indexes, so let's talk about that for a bit. Everything depends on your data and the usage patterns of your users, but there are a few things you can do to ensure the highest hit-rate on your queries.\u003c/p\u003e\n\u003cp\u003eThis is going to primarily speak to MySQL, as that's where I have experience. Things are likely to be different in other databases.\u003c/p\u003e\n\u003ch3 id=\"multi-column-indexes\"\u003e\u003ca href=\"https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#multi-column-indexes\" title=\"Permalink\"\u003e#\u003c/a\u003eMulti-Column Indexes\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#multi-column-indexes\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eMost developers are accustomed to adding indexes to single columns, but there's nothing stopping you from adding indexes to multiple columns. In fact, if you're aiming to create a covering index for an expensive pagination query, you're almost certainly going to need a multi-column index.\u003c/p\u003e\n\u003cp\u003eWhen you're trying to optimize an index for pagination, be sure to put the \u003ccode\u003eorder by\u003c/code\u003e column at the very end. If your users are going to be ordering by \u003ccode\u003eupdated_at\u003c/code\u003e, that should be the last column in your composite index.\u003c/p\u003e\n\u003cp\u003eLook at the following index that includes three columns:\u003c/p\u003e\n\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token keyword\"\u003ealter\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etable\u003c/span\u003e contacts \u003cspan class=\"token keyword\"\u003eadd\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eindex\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003ecomposite\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003eis_deleted\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003eis_archived\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003eupdated_at\u003cspan class=\"token punctuation\"\u003e`\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOr done in Laravel:\u003c/p\u003e\n\u003cpre class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token variable\"\u003e$table\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eindex\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'is_deleted'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'is_archived'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'updated_at'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'composite'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn MySQL, \u003cstrong\u003ecomposite indexes are accessed left to right, and MySQL stops using an index if a column is missing, or after the first range condition.\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eMySQL will be able to use this index in the following scenarios:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eYou query against \u003ccode\u003eis_deleted\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eYou query against \u003ccode\u003eis_deleted\u003c/code\u003e and \u003ccode\u003eis_archived\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eYou query against \u003ccode\u003eis_deleted\u003c/code\u003e and \u003ccode\u003eis_archived\u003c/code\u003e and \u003ccode\u003eupdated_at\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eYou query against \u003ccode\u003eis_deleted\u003c/code\u003e and \u003ccode\u003eis_archived\u003c/code\u003e and order by \u003ccode\u003eupdated_at\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eIf you skip \u003ccode\u003eis_archived\u003c/code\u003e, MySQL won't be able to access \u003ccode\u003eupdated_at\u003c/code\u003e and will have to resort to sorting without that index or not use that index at all, so make sure you plan accordingly.\u003c/p\u003e\n\u003ch3 id=\"the-primary-key-is-always-there\"\u003e\u003ca href=\"https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#the-primary-key-is-always-there\" title=\"Permalink\"\u003e#\u003c/a\u003eThe Primary Key is Always There\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#the-primary-key-is-always-there\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eIn the case of MySQL's InnoDB, \u003cstrong\u003eall indexes have the primary key appended\u003c/strong\u003e. That means that an index on \u003ccode\u003e(email)\u003c/code\u003e is actually an index on \u003ccode\u003e(email, id)\u003c/code\u003e, which is pretty important when it comes to covering indexes and deferred joins.\u003c/p\u003e\n\u003cp\u003eThe query \u003ccode\u003eselect email from contacts order by id\u003c/code\u003e is completely covered by a single index on \u003ccode\u003eemail\u003c/code\u003e, because InnoDB appends \u003ccode\u003eid\u003c/code\u003e to that index!\u003c/p\u003e\n\u003cp\u003eUsing our composite example from above, you can see where this is beneficial:\u003c/p\u003e\n\u003cpre class=\"language-sql\"\u003e\u003ccode class=\"language-sql\"\u003e\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e\n  id                   \u003cspan class=\"token comment\"\u003e-- implicitly in the index\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efrom\u003c/span\u003e\n  contacts\n\u003cspan class=\"token keyword\"\u003ewhere\u003c/span\u003e\n  is_deleted \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e       \u003cspan class=\"token comment\"\u003e-- explicitly in the index\u003c/span\u003e\n  \u003cspan class=\"token operator\"\u003eand\u003c/span\u003e is_archived \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e  \u003cspan class=\"token comment\"\u003e-- explicitly in the index\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eby\u003c/span\u003e\n  updated_at \u003cspan class=\"token keyword\"\u003edesc\u003c/span\u003e      \u003cspan class=\"token comment\"\u003e-- explicitly in the index\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBecause the composite index covers \u003ccode\u003eis_deleted\u003c/code\u003e, \u003ccode\u003eis_archived\u003c/code\u003e, \u003ccode\u003eupdated_at\u003c/code\u003e, and (by function of InnoDB) \u003ccode\u003eid\u003c/code\u003e, this entire query can be satisfied by index alone.\u003c/p\u003e\n\u003ch3 id=\"descending-indexes\"\u003e\u003ca href=\"https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#descending-indexes\" title=\"Permalink\"\u003e#\u003c/a\u003eDescending Indexes\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#descending-indexes\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eMost of the time, users are looking for the \"newest\" items, i.e. the most recently updated or created items, which can be satisfied by ordering by \u003ccode\u003eupdated_at DESC\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eIf you know that your users are going to be primarily sorting their results in descending order, it might make sense to specifically make your index a descending index.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eMySQL 8 is the first MySQL version to support descending indexes.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eIf you see \u003ccode\u003eBackward index scan\u003c/code\u003e in the \u003ccode\u003eExtra\u003c/code\u003e section of your explain, you might be able to configure a better index.\u003c/p\u003e\n\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"id\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"select_type\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"SIMPLE\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"table\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"contacts\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"partitions\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token null keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"type\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"index\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"possible_keys\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token null keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"key\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"users_email_unique\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"key_len\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"1022\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"ref\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token null keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"rows\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e10690173\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"filtered\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e100.0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"Extra\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Backward index scan; Using index\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eTo declare an index as descending, you can just add \u003ccode\u003eDESC\u003c/code\u003e to your index statement. To do it in Laravel, you'll need to reach for the \u003ccode\u003eDB::raw()\u003c/code\u003e method:\u003c/p\u003e\n\u003cpre class=\"language-php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token variable\"\u003e$table\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eindex\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'is_deleted'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'is_archived'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token scope\"\u003eDB\u003cspan class=\"token punctuation\"\u003e::\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token function\"\u003eraw\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e'`updated_at` DESC'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e'composite'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eForward index scans are \u003ca href=\"https://dev.mysql.com/blog-archive/mysql-8-0-labs-descending-indexes-in-mysql/\"\u003e~15% faster than backward scans\u003c/a\u003e, so you'll want to add the index in the order that you think your users will use most often, and take the penalty for the minority use case.\u003c/p\u003e\n\u003ch2 id=\"nothing-new-under-the-sun\"\u003e\u003ca href=\"https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#nothing-new-under-the-sun\" title=\"Permalink\"\u003e#\u003c/a\u003eNothing New Under the Sun\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#nothing-new-under-the-sun\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eThis method of using offset / limit pagination with deferred joins and covering indexes isn't a silver bullet.\u003c/p\u003e\n\u003cp\u003eDeferred joins alone can probably get you a nice boost in speed, but it takes some extra thought to design the right indexes to get you the maximum benefit.\u003c/p\u003e\n\u003cp\u003eAn argument could be made that deferred joins should be the default offset / limit method in frameworks, and any time a covering index hits it's just a bonus. I haven't tested in enough production environments to strongly advocate for that yet.\u003c/p\u003e\n\u003cp\u003eFinally, before you shower me with applause and accolades, please understand that this is not an original concept! The basic idea is outlined in a book called \"\u003ca href=\"https://amzn.to/3fwWavn\"\u003eHigh Performance MySQL, 3rd Edition\u003c/a\u003e.\" (There is also a \u003ca href=\"https://amzn.to/3qxmHyW\"\u003e4th edition\u003c/a\u003e now.)\u003c/p\u003e\n\u003cp\u003eI read this book a while ago and kind of forgot about this little method. Then, a few days ago, I was helping a friend optimize their Laravel + MySQL app and we ran into this exact problem, where page 1 worked fine and page 3,231 never loaded.\u003c/p\u003e\n\u003cp\u003eI remembered some obscure thing I had read, so I went back to the book to look it up and figured out how to implement it in Laravel, against their dataset.\u003c/p\u003e\n\u003cp\u003eI love reading physical technical books for this reason. I had highlighted that part as potentially interesting, not knowing when I'd really need it, but I was aware vaguely that some solution existed. Then when it was time to use it I could just go look it up!\u003c/p\u003e\n\u003cp\u003eI highly recommend that MySQL book, by the way.\u003c/p\u003e\n\u003cp\u003eIf you need help optimizing your Laravel and MySQL applications, please reach out to me \u003ca href=\"https://twitter.com/aarondfrancis\"\u003eon Twitter\u003c/a\u003e. I'm available for day-long performance engagements. I'm also working on a MySQL video course, which you can sign up for below!\u003c/p\u003e\n\u003cp\u003ewindow.Reform=window.Reform||function(){(Reform.q=Reform.q||[]).push(arguments)}; Reform('init', { url: '\u003ca href=\"https://forms.reform.app/uVXl5x/mysql-early-access\u0026#x27;\"\u003ehttps://forms.reform.app/uVXl5x/mysql-early-access'\u003c/a\u003e, target: '#my-reform', background: 'transparent', })\u003c/p\u003e\n\u003ch2 id=\"results\"\u003e\u003ca href=\"https://aaronfrancis.com/2022/efficient-pagination-using-deferred-joins#results\"\u003eResults\u003c/a\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#results\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eI'll be adding some results here as they come in.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e28 seconds → 2 seconds\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e7.5x improvement\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e1100ms --\u003e 100ms\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e20s --\u003e 2s\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e10x improvement\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\"Very helpful\"\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e","noteIndex":{"id":"Iy0MoL0KnL55Br3AfTS2C","title":"Luke","desc":"","updated":1761796791487,"created":1644449449778,"custom":{"nav_order":0,"permalink":"/"},"fname":"root","type":"note","vault":{"fsPath":"vault"},"contentHash":"4e745570ca97988a0362cb939b760952","links":[{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"life-tips","position":{"start":{"line":41,"column":5,"offset":2603},"end":{"line":41,"column":29,"offset":2627},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"life-tips","anchorHeader":"wodenokoto"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-read-in.2025","alias":"What I read in 2025","position":{"start":{"line":70,"column":3,"offset":4333},"end":{"line":70,"column":54,"offset":4384},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-read-in.2025"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-read-in.2024","alias":"2024","position":{"start":{"line":71,"column":5,"offset":4389},"end":{"line":71,"column":41,"offset":4425},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-read-in.2024"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-read-in.2023","alias":"2023","position":{"start":{"line":72,"column":5,"offset":4430},"end":{"line":72,"column":41,"offset":4466},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-read-in.2023"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-read-in.2022","alias":"2022","position":{"start":{"line":73,"column":5,"offset":4471},"end":{"line":73,"column":41,"offset":4507},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-read-in.2022"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-struggled-brag-in","position":{"start":{"line":79,"column":3,"offset":4643},"end":{"line":79,"column":39,"offset":4679},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-struggled-brag-in"}}],"anchors":{"what-i-read-in-past":{"type":"header","text":"What I read in past","value":"what-i-read-in-past","line":74,"column":0,"depth":2}},"children":["zd4mq442jike0pr0wba1u3m","6hzeqsofq67gdk88flxlkhp","778ijii93yu5uwnrwmn5zi4","g1fngdjl25nes6fs3lip602","ZbdkdApFqLdks4Moq92R9","uoc5hhki3o4py15cesddu8q","9qf7j06jtdkm6rnx9ymvwb0","5zn10cvj7ajy2gh2is5nqmg","4qo9ma0z0yu1czns6pxl7y5","ok0e729ho7o09xetujkxc0m","GR5x8HnNFEN6fU2UBSEIK","yirtnlj8q24yutcf3ss1xqy","eq0wc6t7wl2wv221yb68ro4","7x2fnv4j6gxts08qk0jguny","ettkt3iClONnxpbGwBVLl","7l4knev6v613tbuoskvmbdg","hvh5bud6yp7dc89tuh95tr9","4fvoqrplw0cweo554usbjos","f8qsfql0a9v8thpeo82udfa","1swsbrhqi9jk41v9eodyi5q","SQqYupi6EFddTerBA8RRD","hjNeNc1F2JUh0lTWanH4h","qf0l4wbrc9jgooyzexmbq5v","uur1lkol353z9vfeqb3n5bv","cd9n1czq3ursgkby985wkmm","k1sr43vwnfqztwc0s43pkcf","wfde75rhdvq2yfa2zy2q6rv","rjcmdv60jokmbw6zoq8u2ef","ujapvww8o6v3kpmlhtryq4k","pkwewou9d5e8ystswn1j2b4"],"parent":null,"data":{},"body":"\nHi there 👋. I'm a Front-end developer.\n\n---\n\n- 단순함과 꾸준함은 가장 쉬우면서도 지키기 어려운 원칙.\n\n- 🥱 -\u003e 🤔💡🌱 - [On The Death of Daydreaming](https://www.afterbabel.com/p/on-the-death-of-daydreaming)\n  - boredom -\u003e easy fun -\u003e art -\u003e profit?\n\n\u003e I've often described my motivation for building software to others using imagery: I like to go find a secluded beach, build a large, magnificent sand castle, and then walk away. Will anyone notice? Probably not. Will the waves eventually destroy it? Yep. Did I still get immense satisfaction? Absolutely. - [aliasxneo](https://news.ycombinator.com/item?id=41497113)\n\n\u003e We love to see the process, not just the result. The imperfections in your work can be beautiful if they show your struggle for perfection, not a lack of care. - [ralphammer](https://ralphammer.com/is-perfection-boring/)\n\n\u003e Simplicity, even if it sacrifices some ideal functionality has better survival characteristics than the-right-thing. - [The Rise of Worse is Better](https://www.dreamsongs.com/RiseOfWorseIsBetter.html)\n\n\u003e [Roberto Blake was talking about making 100 crappy videos](https://www.youtube.com/watch?v=OnUBaQ1Sp_E) to get better over time. Putting in the reps and improving a little bit each time.\n\u003e\n\u003e Putting in the work without expecting any external reward at first (eg views, followers, likes, etc) will pay off in the long run. - [100 Scrappy Things](https://www.florin-pop.com/blog/100-scrappy-things/)\n\n\u003e Make the difficult habitual, the habitual easy, and the easy beautiful. - [Constantin S. Stanislavski](https://www.goodreads.com/quotes/7102271-make-the-difficult-habitual-the-habitual-easy-and-the-easy)\n\n\u003e A good match is a **structured** dance, where players aim to **score** while they are following well-defined **rules**. This **freedom within a structure** is what makes it fun. - [ralphammer](https://ralphammer.com/how-to-get-started/)\n\n- [Pivot Points](https://longform.asmartbear.com/pivot-points/)\n\n  - non-judgmental aspects of personality that can be strengths in some contexts and weaknesses in others\n  - Pivot Points are fixed in the short term\n\n- [Hedged Bets](https://longform.asmartbear.com/predict-the-future/#hedged-bets)\n  - trading slightly less maximum upside for predictable, net-positive outcomes.\n\n\u003e “Motivation often comes after starting, not before. Action produces momentum.”\n\u003e [When you start a new habit, it should take less than two minutes to do.](https://jamesclear.com/how-to-stop-procrastinating)\n\u003e\n\u003e - James Clear\n\n\u003e Focus is more about **not** keeping busy when you need to wait for something.  \n\u003e Eat the boredom for a minute.\n\u003e\n\u003e - [[life-tips#wodenokoto]]\n\n\u003e [4 minutes run hard enough to push heart rate to 90%, 3 minutes recover, repeat 4 times](https://news.ycombinator.com/item?id=34213181)\n\u003e\n\u003e - https://www.ntnu.edu/cerg/advice\n\u003e - [Get running with Couch to 5K](https://www.nhs.uk/live-well/exercise/running-and-aerobic-exercises/get-running-with-couch-to-5k/)\n\n\u003e [recommended routine - bodyweightfitness](https://www.reddit.com/r/bodyweightfitness/wiki/kb/recommended_routine/) - I Don't Have This Much Time!\n\u003e\n\u003e - Don't workout at all (saves anywhere from 20 to 60 minutes, but really, really, really, really, really, really, really, really, really not recommended)\n\n\u003e 도무지 읽히지 않는 책 앞에서 내가 택한 방법은 펼쳐진 페이지 앞에서 멍때리기이다. 다르게 표현하면 이렇다. 펼쳐진 두 페이지 앞에서 오래 머물기.\n\u003e\n\u003e 책을 펼쳐놓는 것으로 충분하다. 읽지 못해도 좋다. 매일 정해진 진도를 나가야 하는 학교 수업이 아니니까. 하지만 읽지 않아도 괜찮다고 해서 펼쳐두지조차 않으면 곤란하다. 가능한 한 자주 책을 펼쳐두도록 하자. 전혀 읽지 않고 멍하니 바라보고 있다가 다시 덮게 되더라도\n\u003e\n\u003e - 막막한 독서. 시로군. P.10~13\n\n\u003e I think it should be everyone's primary focus to sleep well, drink water, get outside, get active, and eat generally decently. I hate to say it, but if you're not eating a good amount of vegetables and fruit, decent protein, sleep, etc, no amount of XYZ will catch up to that detriment. - [CE02](https://news.ycombinator.com/item?id=35056071)\n\n\u003e My real battle is doing good versus doing nothing. - [Deirdre Sullivan](https://www.npr.org/2005/08/08/4785079/always-go-to-the-funeral)\n\n[Kind Engineering](https://kind.engineering/) - How To Engineer Kindness\n\n\u003e Sometimes magic is just someone spending more time on something than anyone else might reasonably expect. - [Teller](https://www.goodreads.com/quotes/6641527-sometimes-magic-is-just-someone-spending-more-time-on-something)\n\n---\n\n## What I read in past\n\n- [[What I read in 2025|journal.what-i-read-in.2025]]\n  - [[2024|journal.what-i-read-in.2024]]\n  - [[2023|journal.what-i-read-in.2023]]\n  - [[2022|journal.what-i-read-in.2022]]\n- 📝 [Gists](https://gist.github.com/Luke-SNAW)\n- 📜 [Journals](https://luke-snaw.github.io/Luke-SNAW__netlify-CMS.github.io/)\n\n---\n\n- [[journal.what-i-struggled-brag-in]]\n"},"collectionChildren":null,"customHeadContent":null,"config":{"version":5,"dev":{"enablePreviewV2":true},"commands":{"lookup":{"note":{"selectionMode":"extract","confirmVaultOnCreate":true,"vaultSelectionModeOnCreate":"smart","leaveTrace":false,"bubbleUpCreateNew":true,"fuzzThreshold":0.2}},"randomNote":{},"insertNoteLink":{"aliasMode":"none","enableMultiSelect":false},"insertNoteIndex":{"enableMarker":false},"copyNoteLink":{"aliasMode":"title"},"templateHierarchy":"template"},"workspace":{"vaults":[{"fsPath":"vault"}],"journal":{"dailyDomain":"daily","name":"journal","dateFormat":"y.MM.dd","addBehavior":"childOfDomain"},"scratch":{"name":"scratch","dateFormat":"y.MM.dd.HHmmss","addBehavior":"asOwnDomain"},"task":{"name":"","dateFormat":"","addBehavior":"childOfCurrent","statusSymbols":{"":" ","wip":"w","done":"x","assigned":"a","moved":"m","blocked":"b","delegated":"l","dropped":"d","pending":"y"},"prioritySymbols":{"H":"high","M":"medium","L":"low"},"todoIntegration":false,"createTaskSelectionType":"selection2link","taskCompleteStatus":["done","x"]},"graph":{"zoomSpeed":1,"createStub":false},"enableAutoCreateOnDefinition":false,"enableXVaultWikiLink":false,"enableRemoteVaultInit":true,"enableUserTags":false,"enableHashTags":true,"workspaceVaultSyncMode":"noCommit","enableAutoFoldFrontmatter":false,"enableEditorDecorations":true,"maxPreviewsCached":10,"maxNoteLength":204800,"dendronVersion":"0.115.0","enableFullHierarchyNoteTitle":false,"enablePersistentHistory":false},"preview":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enablePrettyRefs":true,"enableKatex":true,"automaticallyShowPreview":false,"enableFrontmatterTags":true,"enableHashesForFMTags":false},"publishing":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enablePrettyRefs":true,"enableKatex":true,"copyAssets":true,"siteHierarchies":["root"],"writeStubs":false,"siteRootDir":"docs","seo":{"title":"Luke SNAW","description":"Personal knowledge space"},"github":{"enableEditLink":false,"editLinkText":"Edit this page on GitHub","editBranch":"main","editViewMode":"tree"},"enableSiteLastModified":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableRandomlyColoredTags":true,"enableTaskNotes":true,"enablePrettyLinks":true,"searchMode":"lookup","siteUrl":"https://luke-snaw.github.io/","duplicateNoteBehavior":{"action":"useVault","payload":["vault"]},"siteFaviconPath":"favicon.ico","siteIndex":"root"}}},"__N_SSG":true},"page":"/notes/[id]","query":{"id":"pytn4f8md64usu5rf6luoce"},"buildId":"vOE8u-mg___OsOsz4tjEg","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>