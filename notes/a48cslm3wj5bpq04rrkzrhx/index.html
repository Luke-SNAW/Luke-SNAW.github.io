<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/favicon.ico"/><title>Services By Lifecycle</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="description" content="Personal knowledge space"/><meta property="og:title" content="Services By Lifecycle"/><meta property="og:description" content="Personal knowledge space"/><meta property="og:url" content="https://luke-snaw.github.io//notes/a48cslm3wj5bpq04rrkzrhx/"/><meta property="og:type" content="article"/><meta property="article:published_time" content="5/24/2023"/><meta property="article:modified_time" content="5/24/2023"/><link rel="canonical" href="https://luke-snaw.github.io//notes/a48cslm3wj5bpq04rrkzrhx/"/><meta name="next-head-count" content="14"/><link rel="preload" href="/_next/static/css/8e7b7e4bce421c0a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8e7b7e4bce421c0a.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-3d209faeb64f2f97.js" defer=""></script><script src="/_next/static/chunks/framework-28c999baf2863c3d.js" defer=""></script><script src="/_next/static/chunks/main-104451f3d1a5c4bc.js" defer=""></script><script src="/_next/static/chunks/pages/_app-9d8e0603730b15a3.js" defer=""></script><script src="/_next/static/chunks/935-4dee79e80b8641c6.js" defer=""></script><script src="/_next/static/chunks/6-50972def09142ee2.js" defer=""></script><script src="/_next/static/chunks/pages/notes/%5Bid%5D-78d472fa3b924116.js" defer=""></script><script src="/_next/static/vOE8u-mg___OsOsz4tjEg/_buildManifest.js" defer=""></script><script src="/_next/static/vOE8u-mg___OsOsz4tjEg/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><section class="ant-layout" style="width:100%;min-height:100%"><header class="ant-layout-header" style="position:fixed;isolation:isolate;z-index:1;width:100%;border-bottom:1px solid #d4dadf;height:64px;padding:0 24px 0 2px"><div class="ant-row ant-row-center" style="max-width:992px;justify-content:space-between;margin:0 auto"><div style="display:flex" class="ant-col ant-col-xs-20 ant-col-sm-4"></div><div class="ant-col gutter-row ant-col-xs-0 ant-col-sm-20 ant-col-md-20 ant-col-lg-19"><div class="ant-select ant-select-lg ant-select-auto-complete ant-select-single ant-select-allow-clear ant-select-show-search" style="width:100%"><div class="ant-select-selector"><span class="ant-select-selection-search"><input type="search" autoComplete="off" class="ant-select-selection-search-input" role="combobox" aria-haspopup="listbox" aria-owns="undefined_list" aria-autocomplete="list" aria-controls="undefined_list" aria-activedescendant="undefined_list_0" value=""/></span><span class="ant-select-selection-placeholder">For full text search please use the &#x27;?&#x27; prefix. e.g. ? Onboarding</span></div></div></div><div style="display:none;align-items:center;justify-content:center" class="ant-col ant-col-xs-4 ant-col-sm-4 ant-col-md-0 ant-col-lg-0"><span role="img" aria-label="menu" style="font-size:24px" tabindex="-1" class="anticon anticon-menu"><svg viewBox="64 64 896 896" focusable="false" data-icon="menu" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></span></div></div></header><section class="ant-layout" style="margin-top:64px;display:flex;flex-direction:row"><div class="site-layout-sidebar" style="flex:0 0 auto;width:calc(max((100% - 992px) / 2, 0px) + 200px);min-width:200px;padding-left:calc((100% - 992px) / 2)"><aside class="ant-layout-sider ant-layout-sider-dark" style="position:fixed;overflow:auto;height:calc(100vh - 64px);background-color:transparent;flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"></div></aside></div><main class="ant-layout-content side-layout-main" style="max-width:1200px;min-width:0;display:block"><div style="padding:0 24px"><div class="main-content" role="main"><div class="ant-row"><div class="ant-col ant-col-24"><div class="ant-row" style="margin-left:-10px;margin-right:-10px"><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-24 ant-col-md-18"><div><h1 id="services-by-lifecycle">Services By Lifecycle<a aria-hidden="true" class="anchor-heading icon-link" href="#services-by-lifecycle"></a></h1>
<blockquote>
<p><a href="https://www.michaelnygard.com/blog/2018/01/services-by-lifecycle/">https://www.michaelnygard.com/blog/2018/01/services-by-lifecycle/</a></p>
</blockquote>
<p>This post took a lot longer to pull together than I expected. Not because it was hard to write, but because it was too easy to write <em>too much</em>. Like a <a href="https://www.youtube.com/watch?v=96aW1V8DhEU">pre-bonsai tree</a>, it would grow out of control and get pruned back over and over.</p>
<p>In the meantime, I delivered <a href="https://n6consulting.com/workshop/arch-without-end-state/">a workshop</a> and spent some lovely holiday time with my family.</p>
<p>But it’s a new year now, and January is devoid of holidays so it’s high time I got back to business.</p>
<h2 id="avoiding-the-entity-service">Avoiding the Entity Service<a aria-hidden="true" class="anchor-heading icon-link" href="#avoiding-the-entity-service"></a></h2>
<p>In my <a href="/dev.software-engineering.the-entity-service-antipattern.md">last post</a>, I made a case against entity services. To recap, an entity service is a set of CRUD operations on a business entity such as <em>Person</em>, <em>Location</em>, <em>Contract</em>, <em>Order</em>, etc. It’s an antipattern because it creates high semantic and operational coupling. Edge services suffer from common-mode failures through their shared dependency on the entity services. Changes or outages in the entity services have large “failure domains.”</p>
<p>A lot of good advice springs from Eric Evan’s hugely influential book “Domain-Driven Design.” It was written before the service era, but seems to apply well now. I’m not an expert on DDD, though, so I’m going to offer some techniques that may or may not be described there. (I dig the “bounded context” idea, but need to re-read the whole book before I comment on it more.)</p>
<p>There are several ways to avoid entity services. This post explores just one (though it’s one I particularly like.) Future posts will look at additional techniques.</p>
<h3 id="focus-on-behavior-instead-of-data">Focus on Behavior Instead of Data<a aria-hidden="true" class="anchor-heading icon-link" href="#focus-on-behavior-instead-of-data"></a></h3>
<p>When you think about what a service <em>knows</em>, you always end up back at CRUD. I recommend thinking in terms of the service’s responsibilities. (And don’t say it’s responsible for <em>knowing some data</em>!) Does it apply policy? Does it aggregate a stream of concepts into a summary? Does it facilitate some kinds of changes? Does it calculate something? And so on.</p>
<p>Once you know what a service does, you can figure out what it needs to know. For instance, a service that restricts content delivery based on local laws needs to know a few things:</p>
<ol>
<li>What jurisdiction applies?</li>
<li>What classifiers are on the content?</li>
<li>What classifiers are not allowed in that jurisdiction?</li>
</ol>
<p>Notice that #1 and #2 are specific to an individual request, while #3 is slowly-changing data. Thus it makes sense for the service to <em>know</em> #3 and be <em>told</em> #1 and #2.</p>
<p>This leads us to a deeper discussion about what the service knows. How does that data get into the service? Is there a GUI for a legal team? Maybe there’s a feed we can purchase from a data vendor. Maybe we need to apply machine learning based on lawsuits and penalties incurred when we violate local laws. (I’m kidding! Don’t do the last one!) The answers to these questions will firm up your design and situate your service in its ecosystem.</p>
<h3 id="model-like-its-1999">Model Like It’s 1999<a aria-hidden="true" class="anchor-heading icon-link" href="#model-like-its-1999"></a></h3>
<p>When modeling, I like to use a technique from object-oriented design. <a href="http://wiki.c2.com/?CrcCard">CRC cards</a> let me lay out physical tokens that represent services. Then I can play a game where I simulate a request coming in at the edge. A service can add information to a request and pass it along to another service, following the “Tell, Don’t Ask” principle.</p>
<p>If you are in a team, you can deal out cards to players then simulate a request by passing a physical object around. That will quickly reveal gaps in a design. Some common gaps that I see:</p>
<ol>
<li>A service doesn’t know where to send the request. It lacks knowledge of other services that can continue processing. The solution is either to statically introduce it to the next party or to provide URLs in the data that lead to the handler.</li>
<li>A service receives a request that is insufficient. The incoming request either lacks information or has an implicit context that should be turned into data on the request.</li>
</ol>
<p>While playing the CRC game, it’s OK to assume your service already has data it naturally depends on. That is, slowly-changing data the service uses should be considered an asynchronous process relative to the current request. But do make note of that slowly-changing data so you remember to build in the flows needed to populate it.</p>
<p>If you follow “Tell, Don’t Ask” strictly, then the activation set will be a strict tree. Anywhere a service calls out to more than one downstream, it should be sending instructions forward in parallel rather than serially making queries followed by an instruction.</p>
<h3 id="dealing-with-consistency">Dealing with Consistency<a aria-hidden="true" class="anchor-heading icon-link" href="#dealing-with-consistency"></a></h3>
<p>If it were just a matter of passing requests along with extra data, then life would be simple. As often happens, trouble comes from side effects.</p>
<p>Services are not pure functions. If a service call <em>always</em> results in the same result for the same parameters, then you don’t need a service. Make a library and avoid the operational overhead! Services only make sense when they change something in the world. That means state and state changes are unavoidable concerns in a service-based architecture.</p>
<p>Consistency immediately comes up as an issue. Many words have already been written about <a href="https://en.m.wikipedia.org/wiki/CAP_theorem">CAP</a>. Some good, some misguided, and some pure marketing. I even wrote an earlier post about the subtle differences between the <a href="http://thinkrelevance.com/blog/2013/12/23/beware-inconsistent-definitions-of-consistency">C in CAP versus the C in ACID</a>.</p>
<p>Let’s look at one way to deal with consistency in the face of changing state.</p>
<h3 id="divide-services-by-lifecycle-in-a-business-process">Divide Services by Lifecycle in a Business Process<a aria-hidden="true" class="anchor-heading icon-link" href="#divide-services-by-lifecycle-in-a-business-process"></a></h3>
<p>Many business processes have entities that go through a series of milestones. In a particular state, changes are allowed to certain attributes but not others. Once a subset of the properties are “valid” (whatever <em>that</em> means) the entity can transition to the next stage of the business process.</p>
<p>Instead of viewing this as a single entity with a bunch of booleans, or a CURRENT<em>STATE attribute (which implies a state machine that is unknown to consumers) we can view each state as a _different thing</em>.</p>
<p>For example, consider this process from a peer-to-peer lending situation:</p>
<ol>
<li>A loan requestor starts by creating a project proposal. The requestor can provide descriptive text, an amount to request, some media assets (projects with big vivid pictures get funded faster.)</li>
<li>Once the loan request is completed, the requestor submits it for approval. At this point, the requestor is no longer allowed to change the amount requested.</li>
<li>An analyst from the host company reviews the proposal. In parallel, a background job checks the requestor’s credit score, repayment history, and criminal record.</li>
<li>The analyst reviews the request and either assigns a target interest rate, rejects the request outright, or indicates that more information is needed from the requestor.</li>
<li>Once approved, the proposal is visible to funders. Funders can commit to a certain amount (contingent on <em>their</em> credit scores.) At this stage, none of the proposal information can be changed, although the whole proposal could be withdrawn.</li>
<li>Once fully funded, funders must transfer money within 3 days. No additional funders are allowed to join the project at this time, but they can go on a waiting list in case some of the committed funders fail to supply the money.</li>
<li>Once funds are in the funders' accounts, it all gets transfered into a short-term holding account. The project information, all the individuals' information (tax IDs, etc.) goes to an underwriter who produces a legal loan document for all parties to sign.</li>
</ol>
<p>For the moment, we’re leaving out some of the tributaries of this flow.</p>
<p>Notice how moving through the business process causes previous information to become effectively read-only?</p>
<p>The original form of this system was a monolith that had a state field on a “Loan” model object. That was a <em>wide</em> object, since it had everything from the initial proposal through to the ultimate payment. If we made that into a “Loan” microservice we would exactly end up with an entity service, CRUD operations, and high coupling into that service, as shown below.</p>
<p><img src="/assets/images/software-engineering/services-by-lifecycle__with-loan-entity-service.svg" alt="With loan entity service"></p>
<p>Try playing CRC with this design. You’ll find that all requests reach the Loan service.</p>
<p>What is less evident from the diagram is about the cost of embedding a state model into the entity service directly. If we put a state field on the Loan, then every Loan must go through the same state machine. It locks us into a single kind of business process. At the time, we already knew the company was exploring direct-funded loans through a banking partner. So there would be a minimum of two flavors of process. (Or one process with proliferating branches.)</p>
<p>I briefly considered using <a href="https://github.com/mtnygard/devs">my DEVS library</a> to represent the state plus state machine as EDN data on each Loan, but ultimately decided against it.</p>
<p>Instead, I thought we could make each state into its own service, as shown here.</p>
<p><img src="/assets/images/software-engineering/services-by-lifecycle__with-lifecycle.svg" alt="With Lifecycle"></p>
<p>Now as the business process moves along, we’re really sending documents to each service. For example, from Proposal to Project, we send a “ProjectStarter” document that contains all the attributes needed for a Project. When the analyst approves a project, the analyst GUI (or backend for same) creates a “LoanStarter” and sends it to the UnfundedLoan service. Likewise, once all funding is received, the “Collection” service creates a “LoanPackage” document and sends it to the “Underwriting” service. (That’s “collection” as in “gatherer of documents” not “collection” as in “break your kneecaps.") Further downstream, we set up a schedule of payments to receive from the requestor and payments to issue to the backers. We also keep a set of ledgers to track balances per account.</p>
<p>Each of the services has facilities to add or update information relevant to that service. It ignores anything in the incoming documents that it doesn’t need.</p>
<p>This gives us a lot of flexibility in how we build the overall process.</p>
<p>Consider our direct-funding scenario. We need a new “DirectFunding” service that finds suitable candidates. It sends a document out to the bank and receives a response. On a favorable response, DirectFunding can create its own version of the LoanPackage document for underwriting. In other words, treating these stages as services connected by well-defined document formats allows us to introduce more pathways without creating the state machine from hell.</p>
<p>As an additional benefit, we can easily monitor the flow of documents to see when the process is healthy. We can monitor each service’s activity to create a cumulative flow diagram. We get a lot of visibility. And since some stages are triggered by humans (e.g., the analysts) we can even figure out how our staff model must scale with business throughput.</p>
<p>It should also be clear that this style works well with event transfer instead of document transfer. It would be natural to put all the documents onto a message bus.</p>
<p>Overall, I think this style offers a nice degree of alignment between the technology and the business. The only “downside” I can see is that it requires a service developer to understand how that service contributes to value streams and business processes.</p>
<h3 id="backtracking-errors-and-races">Backtracking, Errors, and Races<a aria-hidden="true" class="anchor-heading icon-link" href="#backtracking-errors-and-races"></a></h3>
<p>There is still a minute window of opportunity for <em>perceived</em> inconsistency to sneak in. For example, what happens if the requestor tries to change the proposal while the analyst is reviewing it? Or worse, what if they change it in those milliseconds between when the analyst clicks “Approve” in the GUI and when the document goes over to the Project service? For that matter, how do we tell the Proposal service that the proposal can no longer be edited without withdrawing the request and resubmitting as a new Project?</p>
<p>This post is already getting too long, so I’m going to answer those questions next time. It shouldn’t take another month since we’re past the holiday-fun-times and into the serious winter months.</p>
<hr>
<strong>Backlinks</strong>
<ul>
<li><a href="/notes/tgud80cj6687x0o11ht4sn6">The Entity Service Antipattern</a></li>
</ul></div></div><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-0 ant-col-md-6"><div><div class=""><div class="ant-anchor-wrapper dendron-toc" style="max-height:calc(100vh - 64px);z-index:1"><div class="ant-anchor"><div class="ant-anchor-ink"><span class="ant-anchor-ink-ball"></span></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#avoiding-the-entity-service" title="Avoiding the Entity Service">Avoiding the Entity Service</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#focus-on-behavior-instead-of-data" title="Focus on Behavior Instead of Data">Focus on Behavior Instead of Data</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#model-like-its-1999" title="Model Like It’s 1999">Model Like It’s 1999</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#dealing-with-consistency" title="Dealing with Consistency">Dealing with Consistency</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#divide-services-by-lifecycle-in-a-business-process" title="Divide Services by Lifecycle in a Business Process">Divide Services by Lifecycle in a Business Process</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#backtracking-errors-and-races" title="Backtracking, Errors, and Races">Backtracking, Errors, and Races</a></div></div></div></div></div></div></div></div></div></div></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><footer class="ant-layout-footer" style="padding:0 24px 24px"></footer></main></section></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"note":{"id":"a48cslm3wj5bpq04rrkzrhx","title":"Services By Lifecycle","desc":"","updated":1684906244245,"created":1684906038693,"custom":{},"fname":"dev.software-engineering.services-by-lifecycle","type":"note","vault":{"fsPath":"vault"},"contentHash":"3891e17e8fe04c85fd05beef41c622ee","links":[{"from":{"fname":"dev.software-engineering.the-entity-service-antipattern","id":"tgud80cj6687x0o11ht4sn6","vaultName":"vault"},"type":"backlink","position":{"start":{"line":83,"column":16,"offset":7655},"end":{"line":83,"column":66,"offset":7705},"indent":[]},"value":"dev.software-engineering.services-by-lifecycle"}],"anchors":{"avoiding-the-entity-service":{"type":"header","text":"Avoiding the Entity Service","value":"avoiding-the-entity-service","line":16,"column":0,"depth":2},"focus-on-behavior-instead-of-data":{"type":"header","text":"Focus on Behavior Instead of Data","value":"focus-on-behavior-instead-of-data","line":24,"column":0,"depth":3},"model-like-its-1999":{"type":"header","text":"Model Like It’s 1999","value":"model-like-its-1999","line":38,"column":0,"depth":3},"dealing-with-consistency":{"type":"header","text":"Dealing with Consistency","value":"dealing-with-consistency","line":51,"column":0,"depth":3},"divide-services-by-lifecycle-in-a-business-process":{"type":"header","text":"Divide Services by Lifecycle in a Business Process","value":"divide-services-by-lifecycle-in-a-business-process","line":61,"column":0,"depth":3},"backtracking-errors-and-races":{"type":"header","text":"Backtracking, Errors, and Races","value":"backtracking-errors-and-races","line":109,"column":0,"depth":3}},"children":[],"parent":"j0N1aVKxe96dktmyADG9U","data":{}},"body":"\u003ch1 id=\"services-by-lifecycle\"\u003eServices By Lifecycle\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#services-by-lifecycle\"\u003e\u003c/a\u003e\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"https://www.michaelnygard.com/blog/2018/01/services-by-lifecycle/\"\u003ehttps://www.michaelnygard.com/blog/2018/01/services-by-lifecycle/\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eThis post took a lot longer to pull together than I expected. Not because it was hard to write, but because it was too easy to write \u003cem\u003etoo much\u003c/em\u003e. Like a \u003ca href=\"https://www.youtube.com/watch?v=96aW1V8DhEU\"\u003epre-bonsai tree\u003c/a\u003e, it would grow out of control and get pruned back over and over.\u003c/p\u003e\n\u003cp\u003eIn the meantime, I delivered \u003ca href=\"https://n6consulting.com/workshop/arch-without-end-state/\"\u003ea workshop\u003c/a\u003e and spent some lovely holiday time with my family.\u003c/p\u003e\n\u003cp\u003eBut it’s a new year now, and January is devoid of holidays so it’s high time I got back to business.\u003c/p\u003e\n\u003ch2 id=\"avoiding-the-entity-service\"\u003eAvoiding the Entity Service\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#avoiding-the-entity-service\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eIn my \u003ca href=\"/dev.software-engineering.the-entity-service-antipattern.md\"\u003elast post\u003c/a\u003e, I made a case against entity services. To recap, an entity service is a set of CRUD operations on a business entity such as \u003cem\u003ePerson\u003c/em\u003e, \u003cem\u003eLocation\u003c/em\u003e, \u003cem\u003eContract\u003c/em\u003e, \u003cem\u003eOrder\u003c/em\u003e, etc. It’s an antipattern because it creates high semantic and operational coupling. Edge services suffer from common-mode failures through their shared dependency on the entity services. Changes or outages in the entity services have large “failure domains.”\u003c/p\u003e\n\u003cp\u003eA lot of good advice springs from Eric Evan’s hugely influential book “Domain-Driven Design.” It was written before the service era, but seems to apply well now. I’m not an expert on DDD, though, so I’m going to offer some techniques that may or may not be described there. (I dig the “bounded context” idea, but need to re-read the whole book before I comment on it more.)\u003c/p\u003e\n\u003cp\u003eThere are several ways to avoid entity services. This post explores just one (though it’s one I particularly like.) Future posts will look at additional techniques.\u003c/p\u003e\n\u003ch3 id=\"focus-on-behavior-instead-of-data\"\u003eFocus on Behavior Instead of Data\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#focus-on-behavior-instead-of-data\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eWhen you think about what a service \u003cem\u003eknows\u003c/em\u003e, you always end up back at CRUD. I recommend thinking in terms of the service’s responsibilities. (And don’t say it’s responsible for \u003cem\u003eknowing some data\u003c/em\u003e!) Does it apply policy? Does it aggregate a stream of concepts into a summary? Does it facilitate some kinds of changes? Does it calculate something? And so on.\u003c/p\u003e\n\u003cp\u003eOnce you know what a service does, you can figure out what it needs to know. For instance, a service that restricts content delivery based on local laws needs to know a few things:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eWhat jurisdiction applies?\u003c/li\u003e\n\u003cli\u003eWhat classifiers are on the content?\u003c/li\u003e\n\u003cli\u003eWhat classifiers are not allowed in that jurisdiction?\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eNotice that #1 and #2 are specific to an individual request, while #3 is slowly-changing data. Thus it makes sense for the service to \u003cem\u003eknow\u003c/em\u003e #3 and be \u003cem\u003etold\u003c/em\u003e #1 and #2.\u003c/p\u003e\n\u003cp\u003eThis leads us to a deeper discussion about what the service knows. How does that data get into the service? Is there a GUI for a legal team? Maybe there’s a feed we can purchase from a data vendor. Maybe we need to apply machine learning based on lawsuits and penalties incurred when we violate local laws. (I’m kidding! Don’t do the last one!) The answers to these questions will firm up your design and situate your service in its ecosystem.\u003c/p\u003e\n\u003ch3 id=\"model-like-its-1999\"\u003eModel Like It’s 1999\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#model-like-its-1999\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eWhen modeling, I like to use a technique from object-oriented design. \u003ca href=\"http://wiki.c2.com/?CrcCard\"\u003eCRC cards\u003c/a\u003e let me lay out physical tokens that represent services. Then I can play a game where I simulate a request coming in at the edge. A service can add information to a request and pass it along to another service, following the “Tell, Don’t Ask” principle.\u003c/p\u003e\n\u003cp\u003eIf you are in a team, you can deal out cards to players then simulate a request by passing a physical object around. That will quickly reveal gaps in a design. Some common gaps that I see:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eA service doesn’t know where to send the request. It lacks knowledge of other services that can continue processing. The solution is either to statically introduce it to the next party or to provide URLs in the data that lead to the handler.\u003c/li\u003e\n\u003cli\u003eA service receives a request that is insufficient. The incoming request either lacks information or has an implicit context that should be turned into data on the request.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eWhile playing the CRC game, it’s OK to assume your service already has data it naturally depends on. That is, slowly-changing data the service uses should be considered an asynchronous process relative to the current request. But do make note of that slowly-changing data so you remember to build in the flows needed to populate it.\u003c/p\u003e\n\u003cp\u003eIf you follow “Tell, Don’t Ask” strictly, then the activation set will be a strict tree. Anywhere a service calls out to more than one downstream, it should be sending instructions forward in parallel rather than serially making queries followed by an instruction.\u003c/p\u003e\n\u003ch3 id=\"dealing-with-consistency\"\u003eDealing with Consistency\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#dealing-with-consistency\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eIf it were just a matter of passing requests along with extra data, then life would be simple. As often happens, trouble comes from side effects.\u003c/p\u003e\n\u003cp\u003eServices are not pure functions. If a service call \u003cem\u003ealways\u003c/em\u003e results in the same result for the same parameters, then you don’t need a service. Make a library and avoid the operational overhead! Services only make sense when they change something in the world. That means state and state changes are unavoidable concerns in a service-based architecture.\u003c/p\u003e\n\u003cp\u003eConsistency immediately comes up as an issue. Many words have already been written about \u003ca href=\"https://en.m.wikipedia.org/wiki/CAP_theorem\"\u003eCAP\u003c/a\u003e. Some good, some misguided, and some pure marketing. I even wrote an earlier post about the subtle differences between the \u003ca href=\"http://thinkrelevance.com/blog/2013/12/23/beware-inconsistent-definitions-of-consistency\"\u003eC in CAP versus the C in ACID\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eLet’s look at one way to deal with consistency in the face of changing state.\u003c/p\u003e\n\u003ch3 id=\"divide-services-by-lifecycle-in-a-business-process\"\u003eDivide Services by Lifecycle in a Business Process\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#divide-services-by-lifecycle-in-a-business-process\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eMany business processes have entities that go through a series of milestones. In a particular state, changes are allowed to certain attributes but not others. Once a subset of the properties are “valid” (whatever \u003cem\u003ethat\u003c/em\u003e means) the entity can transition to the next stage of the business process.\u003c/p\u003e\n\u003cp\u003eInstead of viewing this as a single entity with a bunch of booleans, or a CURRENT\u003cem\u003eSTATE attribute (which implies a state machine that is unknown to consumers) we can view each state as a _different thing\u003c/em\u003e.\u003c/p\u003e\n\u003cp\u003eFor example, consider this process from a peer-to-peer lending situation:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eA loan requestor starts by creating a project proposal. The requestor can provide descriptive text, an amount to request, some media assets (projects with big vivid pictures get funded faster.)\u003c/li\u003e\n\u003cli\u003eOnce the loan request is completed, the requestor submits it for approval. At this point, the requestor is no longer allowed to change the amount requested.\u003c/li\u003e\n\u003cli\u003eAn analyst from the host company reviews the proposal. In parallel, a background job checks the requestor’s credit score, repayment history, and criminal record.\u003c/li\u003e\n\u003cli\u003eThe analyst reviews the request and either assigns a target interest rate, rejects the request outright, or indicates that more information is needed from the requestor.\u003c/li\u003e\n\u003cli\u003eOnce approved, the proposal is visible to funders. Funders can commit to a certain amount (contingent on \u003cem\u003etheir\u003c/em\u003e credit scores.) At this stage, none of the proposal information can be changed, although the whole proposal could be withdrawn.\u003c/li\u003e\n\u003cli\u003eOnce fully funded, funders must transfer money within 3 days. No additional funders are allowed to join the project at this time, but they can go on a waiting list in case some of the committed funders fail to supply the money.\u003c/li\u003e\n\u003cli\u003eOnce funds are in the funders' accounts, it all gets transfered into a short-term holding account. The project information, all the individuals' information (tax IDs, etc.) goes to an underwriter who produces a legal loan document for all parties to sign.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eFor the moment, we’re leaving out some of the tributaries of this flow.\u003c/p\u003e\n\u003cp\u003eNotice how moving through the business process causes previous information to become effectively read-only?\u003c/p\u003e\n\u003cp\u003eThe original form of this system was a monolith that had a state field on a “Loan” model object. That was a \u003cem\u003ewide\u003c/em\u003e object, since it had everything from the initial proposal through to the ultimate payment. If we made that into a “Loan” microservice we would exactly end up with an entity service, CRUD operations, and high coupling into that service, as shown below.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/images/software-engineering/services-by-lifecycle__with-loan-entity-service.svg\" alt=\"With loan entity service\"\u003e\u003c/p\u003e\n\u003cp\u003eTry playing CRC with this design. You’ll find that all requests reach the Loan service.\u003c/p\u003e\n\u003cp\u003eWhat is less evident from the diagram is about the cost of embedding a state model into the entity service directly. If we put a state field on the Loan, then every Loan must go through the same state machine. It locks us into a single kind of business process. At the time, we already knew the company was exploring direct-funded loans through a banking partner. So there would be a minimum of two flavors of process. (Or one process with proliferating branches.)\u003c/p\u003e\n\u003cp\u003eI briefly considered using \u003ca href=\"https://github.com/mtnygard/devs\"\u003emy DEVS library\u003c/a\u003e to represent the state plus state machine as EDN data on each Loan, but ultimately decided against it.\u003c/p\u003e\n\u003cp\u003eInstead, I thought we could make each state into its own service, as shown here.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/images/software-engineering/services-by-lifecycle__with-lifecycle.svg\" alt=\"With Lifecycle\"\u003e\u003c/p\u003e\n\u003cp\u003eNow as the business process moves along, we’re really sending documents to each service. For example, from Proposal to Project, we send a “ProjectStarter” document that contains all the attributes needed for a Project. When the analyst approves a project, the analyst GUI (or backend for same) creates a “LoanStarter” and sends it to the UnfundedLoan service. Likewise, once all funding is received, the “Collection” service creates a “LoanPackage” document and sends it to the “Underwriting” service. (That’s “collection” as in “gatherer of documents” not “collection” as in “break your kneecaps.\") Further downstream, we set up a schedule of payments to receive from the requestor and payments to issue to the backers. We also keep a set of ledgers to track balances per account.\u003c/p\u003e\n\u003cp\u003eEach of the services has facilities to add or update information relevant to that service. It ignores anything in the incoming documents that it doesn’t need.\u003c/p\u003e\n\u003cp\u003eThis gives us a lot of flexibility in how we build the overall process.\u003c/p\u003e\n\u003cp\u003eConsider our direct-funding scenario. We need a new “DirectFunding” service that finds suitable candidates. It sends a document out to the bank and receives a response. On a favorable response, DirectFunding can create its own version of the LoanPackage document for underwriting. In other words, treating these stages as services connected by well-defined document formats allows us to introduce more pathways without creating the state machine from hell.\u003c/p\u003e\n\u003cp\u003eAs an additional benefit, we can easily monitor the flow of documents to see when the process is healthy. We can monitor each service’s activity to create a cumulative flow diagram. We get a lot of visibility. And since some stages are triggered by humans (e.g., the analysts) we can even figure out how our staff model must scale with business throughput.\u003c/p\u003e\n\u003cp\u003eIt should also be clear that this style works well with event transfer instead of document transfer. It would be natural to put all the documents onto a message bus.\u003c/p\u003e\n\u003cp\u003eOverall, I think this style offers a nice degree of alignment between the technology and the business. The only “downside” I can see is that it requires a service developer to understand how that service contributes to value streams and business processes.\u003c/p\u003e\n\u003ch3 id=\"backtracking-errors-and-races\"\u003eBacktracking, Errors, and Races\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#backtracking-errors-and-races\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eThere is still a minute window of opportunity for \u003cem\u003eperceived\u003c/em\u003e inconsistency to sneak in. For example, what happens if the requestor tries to change the proposal while the analyst is reviewing it? Or worse, what if they change it in those milliseconds between when the analyst clicks “Approve” in the GUI and when the document goes over to the Project service? For that matter, how do we tell the Proposal service that the proposal can no longer be edited without withdrawing the request and resubmitting as a new Project?\u003c/p\u003e\n\u003cp\u003eThis post is already getting too long, so I’m going to answer those questions next time. It shouldn’t take another month since we’re past the holiday-fun-times and into the serious winter months.\u003c/p\u003e\n\u003chr\u003e\n\u003cstrong\u003eBacklinks\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"/notes/tgud80cj6687x0o11ht4sn6\"\u003eThe Entity Service Antipattern\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e","noteIndex":{"id":"Iy0MoL0KnL55Br3AfTS2C","title":"Luke","desc":"","updated":1761796791487,"created":1644449449778,"custom":{"nav_order":0,"permalink":"/"},"fname":"root","type":"note","vault":{"fsPath":"vault"},"contentHash":"4e745570ca97988a0362cb939b760952","links":[{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"life-tips","position":{"start":{"line":41,"column":5,"offset":2603},"end":{"line":41,"column":29,"offset":2627},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"life-tips","anchorHeader":"wodenokoto"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-read-in.2025","alias":"What I read in 2025","position":{"start":{"line":70,"column":3,"offset":4333},"end":{"line":70,"column":54,"offset":4384},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-read-in.2025"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-read-in.2024","alias":"2024","position":{"start":{"line":71,"column":5,"offset":4389},"end":{"line":71,"column":41,"offset":4425},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-read-in.2024"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-read-in.2023","alias":"2023","position":{"start":{"line":72,"column":5,"offset":4430},"end":{"line":72,"column":41,"offset":4466},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-read-in.2023"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-read-in.2022","alias":"2022","position":{"start":{"line":73,"column":5,"offset":4471},"end":{"line":73,"column":41,"offset":4507},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-read-in.2022"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-struggled-brag-in","position":{"start":{"line":79,"column":3,"offset":4643},"end":{"line":79,"column":39,"offset":4679},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-struggled-brag-in"}}],"anchors":{"what-i-read-in-past":{"type":"header","text":"What I read in past","value":"what-i-read-in-past","line":74,"column":0,"depth":2}},"children":["zd4mq442jike0pr0wba1u3m","6hzeqsofq67gdk88flxlkhp","778ijii93yu5uwnrwmn5zi4","g1fngdjl25nes6fs3lip602","ZbdkdApFqLdks4Moq92R9","uoc5hhki3o4py15cesddu8q","9qf7j06jtdkm6rnx9ymvwb0","5zn10cvj7ajy2gh2is5nqmg","4qo9ma0z0yu1czns6pxl7y5","ok0e729ho7o09xetujkxc0m","GR5x8HnNFEN6fU2UBSEIK","yirtnlj8q24yutcf3ss1xqy","eq0wc6t7wl2wv221yb68ro4","7x2fnv4j6gxts08qk0jguny","ettkt3iClONnxpbGwBVLl","7l4knev6v613tbuoskvmbdg","hvh5bud6yp7dc89tuh95tr9","4fvoqrplw0cweo554usbjos","f8qsfql0a9v8thpeo82udfa","1swsbrhqi9jk41v9eodyi5q","SQqYupi6EFddTerBA8RRD","hjNeNc1F2JUh0lTWanH4h","qf0l4wbrc9jgooyzexmbq5v","uur1lkol353z9vfeqb3n5bv","cd9n1czq3ursgkby985wkmm","k1sr43vwnfqztwc0s43pkcf","wfde75rhdvq2yfa2zy2q6rv","rjcmdv60jokmbw6zoq8u2ef","ujapvww8o6v3kpmlhtryq4k","pkwewou9d5e8ystswn1j2b4"],"parent":null,"data":{},"body":"\nHi there 👋. I'm a Front-end developer.\n\n---\n\n- 단순함과 꾸준함은 가장 쉬우면서도 지키기 어려운 원칙.\n\n- 🥱 -\u003e 🤔💡🌱 - [On The Death of Daydreaming](https://www.afterbabel.com/p/on-the-death-of-daydreaming)\n  - boredom -\u003e easy fun -\u003e art -\u003e profit?\n\n\u003e I've often described my motivation for building software to others using imagery: I like to go find a secluded beach, build a large, magnificent sand castle, and then walk away. Will anyone notice? Probably not. Will the waves eventually destroy it? Yep. Did I still get immense satisfaction? Absolutely. - [aliasxneo](https://news.ycombinator.com/item?id=41497113)\n\n\u003e We love to see the process, not just the result. The imperfections in your work can be beautiful if they show your struggle for perfection, not a lack of care. - [ralphammer](https://ralphammer.com/is-perfection-boring/)\n\n\u003e Simplicity, even if it sacrifices some ideal functionality has better survival characteristics than the-right-thing. - [The Rise of Worse is Better](https://www.dreamsongs.com/RiseOfWorseIsBetter.html)\n\n\u003e [Roberto Blake was talking about making 100 crappy videos](https://www.youtube.com/watch?v=OnUBaQ1Sp_E) to get better over time. Putting in the reps and improving a little bit each time.\n\u003e\n\u003e Putting in the work without expecting any external reward at first (eg views, followers, likes, etc) will pay off in the long run. - [100 Scrappy Things](https://www.florin-pop.com/blog/100-scrappy-things/)\n\n\u003e Make the difficult habitual, the habitual easy, and the easy beautiful. - [Constantin S. Stanislavski](https://www.goodreads.com/quotes/7102271-make-the-difficult-habitual-the-habitual-easy-and-the-easy)\n\n\u003e A good match is a **structured** dance, where players aim to **score** while they are following well-defined **rules**. This **freedom within a structure** is what makes it fun. - [ralphammer](https://ralphammer.com/how-to-get-started/)\n\n- [Pivot Points](https://longform.asmartbear.com/pivot-points/)\n\n  - non-judgmental aspects of personality that can be strengths in some contexts and weaknesses in others\n  - Pivot Points are fixed in the short term\n\n- [Hedged Bets](https://longform.asmartbear.com/predict-the-future/#hedged-bets)\n  - trading slightly less maximum upside for predictable, net-positive outcomes.\n\n\u003e “Motivation often comes after starting, not before. Action produces momentum.”\n\u003e [When you start a new habit, it should take less than two minutes to do.](https://jamesclear.com/how-to-stop-procrastinating)\n\u003e\n\u003e - James Clear\n\n\u003e Focus is more about **not** keeping busy when you need to wait for something.  \n\u003e Eat the boredom for a minute.\n\u003e\n\u003e - [[life-tips#wodenokoto]]\n\n\u003e [4 minutes run hard enough to push heart rate to 90%, 3 minutes recover, repeat 4 times](https://news.ycombinator.com/item?id=34213181)\n\u003e\n\u003e - https://www.ntnu.edu/cerg/advice\n\u003e - [Get running with Couch to 5K](https://www.nhs.uk/live-well/exercise/running-and-aerobic-exercises/get-running-with-couch-to-5k/)\n\n\u003e [recommended routine - bodyweightfitness](https://www.reddit.com/r/bodyweightfitness/wiki/kb/recommended_routine/) - I Don't Have This Much Time!\n\u003e\n\u003e - Don't workout at all (saves anywhere from 20 to 60 minutes, but really, really, really, really, really, really, really, really, really not recommended)\n\n\u003e 도무지 읽히지 않는 책 앞에서 내가 택한 방법은 펼쳐진 페이지 앞에서 멍때리기이다. 다르게 표현하면 이렇다. 펼쳐진 두 페이지 앞에서 오래 머물기.\n\u003e\n\u003e 책을 펼쳐놓는 것으로 충분하다. 읽지 못해도 좋다. 매일 정해진 진도를 나가야 하는 학교 수업이 아니니까. 하지만 읽지 않아도 괜찮다고 해서 펼쳐두지조차 않으면 곤란하다. 가능한 한 자주 책을 펼쳐두도록 하자. 전혀 읽지 않고 멍하니 바라보고 있다가 다시 덮게 되더라도\n\u003e\n\u003e - 막막한 독서. 시로군. P.10~13\n\n\u003e I think it should be everyone's primary focus to sleep well, drink water, get outside, get active, and eat generally decently. I hate to say it, but if you're not eating a good amount of vegetables and fruit, decent protein, sleep, etc, no amount of XYZ will catch up to that detriment. - [CE02](https://news.ycombinator.com/item?id=35056071)\n\n\u003e My real battle is doing good versus doing nothing. - [Deirdre Sullivan](https://www.npr.org/2005/08/08/4785079/always-go-to-the-funeral)\n\n[Kind Engineering](https://kind.engineering/) - How To Engineer Kindness\n\n\u003e Sometimes magic is just someone spending more time on something than anyone else might reasonably expect. - [Teller](https://www.goodreads.com/quotes/6641527-sometimes-magic-is-just-someone-spending-more-time-on-something)\n\n---\n\n## What I read in past\n\n- [[What I read in 2025|journal.what-i-read-in.2025]]\n  - [[2024|journal.what-i-read-in.2024]]\n  - [[2023|journal.what-i-read-in.2023]]\n  - [[2022|journal.what-i-read-in.2022]]\n- 📝 [Gists](https://gist.github.com/Luke-SNAW)\n- 📜 [Journals](https://luke-snaw.github.io/Luke-SNAW__netlify-CMS.github.io/)\n\n---\n\n- [[journal.what-i-struggled-brag-in]]\n"},"collectionChildren":null,"customHeadContent":null,"config":{"version":5,"dev":{"enablePreviewV2":true},"commands":{"lookup":{"note":{"selectionMode":"extract","confirmVaultOnCreate":true,"vaultSelectionModeOnCreate":"smart","leaveTrace":false,"bubbleUpCreateNew":true,"fuzzThreshold":0.2}},"randomNote":{},"insertNoteLink":{"aliasMode":"none","enableMultiSelect":false},"insertNoteIndex":{"enableMarker":false},"copyNoteLink":{"aliasMode":"title"},"templateHierarchy":"template"},"workspace":{"vaults":[{"fsPath":"vault"}],"journal":{"dailyDomain":"daily","name":"journal","dateFormat":"y.MM.dd","addBehavior":"childOfDomain"},"scratch":{"name":"scratch","dateFormat":"y.MM.dd.HHmmss","addBehavior":"asOwnDomain"},"task":{"name":"","dateFormat":"","addBehavior":"childOfCurrent","statusSymbols":{"":" ","wip":"w","done":"x","assigned":"a","moved":"m","blocked":"b","delegated":"l","dropped":"d","pending":"y"},"prioritySymbols":{"H":"high","M":"medium","L":"low"},"todoIntegration":false,"createTaskSelectionType":"selection2link","taskCompleteStatus":["done","x"]},"graph":{"zoomSpeed":1,"createStub":false},"enableAutoCreateOnDefinition":false,"enableXVaultWikiLink":false,"enableRemoteVaultInit":true,"enableUserTags":false,"enableHashTags":true,"workspaceVaultSyncMode":"noCommit","enableAutoFoldFrontmatter":false,"enableEditorDecorations":true,"maxPreviewsCached":10,"maxNoteLength":204800,"dendronVersion":"0.115.0","enableFullHierarchyNoteTitle":false,"enablePersistentHistory":false},"preview":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enablePrettyRefs":true,"enableKatex":true,"automaticallyShowPreview":false,"enableFrontmatterTags":true,"enableHashesForFMTags":false},"publishing":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enablePrettyRefs":true,"enableKatex":true,"copyAssets":true,"siteHierarchies":["root"],"writeStubs":false,"siteRootDir":"docs","seo":{"title":"Luke SNAW","description":"Personal knowledge space"},"github":{"enableEditLink":false,"editLinkText":"Edit this page on GitHub","editBranch":"main","editViewMode":"tree"},"enableSiteLastModified":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableRandomlyColoredTags":true,"enableTaskNotes":true,"enablePrettyLinks":true,"searchMode":"lookup","siteUrl":"https://luke-snaw.github.io/","duplicateNoteBehavior":{"action":"useVault","payload":["vault"]},"siteFaviconPath":"favicon.ico","siteIndex":"root"}}},"__N_SSG":true},"page":"/notes/[id]","query":{"id":"a48cslm3wj5bpq04rrkzrhx"},"buildId":"vOE8u-mg___OsOsz4tjEg","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>