<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/favicon.ico"/><title>What&#x27;s up with monomorphism?</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="description" content="Personal knowledge space"/><meta property="og:title" content="What&#x27;s up with monomorphism?"/><meta property="og:description" content="Personal knowledge space"/><meta property="og:url" content="https://luke-snaw.github.io//notes/l6abcjmsuol9bri9885t1kf/"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2/16/2023"/><meta property="article:modified_time" content="2/16/2023"/><link rel="canonical" href="https://luke-snaw.github.io//notes/l6abcjmsuol9bri9885t1kf/"/><meta name="next-head-count" content="14"/><link rel="preload" href="/_next/static/css/8e7b7e4bce421c0a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8e7b7e4bce421c0a.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-3d209faeb64f2f97.js" defer=""></script><script src="/_next/static/chunks/framework-28c999baf2863c3d.js" defer=""></script><script src="/_next/static/chunks/main-104451f3d1a5c4bc.js" defer=""></script><script src="/_next/static/chunks/pages/_app-9d8e0603730b15a3.js" defer=""></script><script src="/_next/static/chunks/935-4dee79e80b8641c6.js" defer=""></script><script src="/_next/static/chunks/6-50972def09142ee2.js" defer=""></script><script src="/_next/static/chunks/pages/notes/%5Bid%5D-78d472fa3b924116.js" defer=""></script><script src="/_next/static/wirstT2ztC8OQsbzKjhvw/_buildManifest.js" defer=""></script><script src="/_next/static/wirstT2ztC8OQsbzKjhvw/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><section class="ant-layout" style="width:100%;min-height:100%"><header class="ant-layout-header" style="position:fixed;isolation:isolate;z-index:1;width:100%;border-bottom:1px solid #d4dadf;height:64px;padding:0 24px 0 2px"><div class="ant-row ant-row-center" style="max-width:992px;justify-content:space-between;margin:0 auto"><div style="display:flex" class="ant-col ant-col-xs-20 ant-col-sm-4"></div><div class="ant-col gutter-row ant-col-xs-0 ant-col-sm-20 ant-col-md-20 ant-col-lg-19"><div class="ant-select ant-select-lg ant-select-auto-complete ant-select-single ant-select-allow-clear ant-select-show-search" style="width:100%"><div class="ant-select-selector"><span class="ant-select-selection-search"><input type="search" autoComplete="off" class="ant-select-selection-search-input" role="combobox" aria-haspopup="listbox" aria-owns="undefined_list" aria-autocomplete="list" aria-controls="undefined_list" aria-activedescendant="undefined_list_0" value=""/></span><span class="ant-select-selection-placeholder">For full text search please use the &#x27;?&#x27; prefix. e.g. ? Onboarding</span></div></div></div><div style="display:none;align-items:center;justify-content:center" class="ant-col ant-col-xs-4 ant-col-sm-4 ant-col-md-0 ant-col-lg-0"><span role="img" aria-label="menu" style="font-size:24px" tabindex="-1" class="anticon anticon-menu"><svg viewBox="64 64 896 896" focusable="false" data-icon="menu" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></span></div></div></header><section class="ant-layout" style="margin-top:64px;display:flex;flex-direction:row"><div class="site-layout-sidebar" style="flex:0 0 auto;width:calc(max((100% - 992px) / 2, 0px) + 200px);min-width:200px;padding-left:calc((100% - 992px) / 2)"><aside class="ant-layout-sider ant-layout-sider-dark" style="position:fixed;overflow:auto;height:calc(100vh - 64px);background-color:transparent;flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"></div></aside></div><main class="ant-layout-content side-layout-main" style="max-width:1200px;min-width:0;display:block"><div style="padding:0 24px"><div class="main-content" role="main"><div class="ant-row"><div class="ant-col ant-col-24"><div class="ant-row" style="margin-left:-10px;margin-right:-10px"><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-24 ant-col-md-18"><div><h1 id="whats-up-with-monomorphism">What's up with monomorphism?<a aria-hidden="true" class="anchor-heading icon-link" href="#whats-up-with-monomorphism"></a></h1>
<blockquote>
<p><a href="https://mrale.ph/blog/2015/01/11/whats-up-with-monomorphism.html">https://mrale.ph/blog/2015/01/11/whats-up-with-monomorphism.html</a></p>
</blockquote>
<p>Talks and blog posts about JavaScript performance often emphasize importance of <em>monomorphic</em> code. However they usually don’t provide any digestible explanation of what monomorphism/polymorhism is and why it matters. Even my own talks often boil down to Hulk-style «<strong>ONE TYPE GOOD. TWO TYPE BAD!!!</strong>» dichotomy. Unsurprisingly one of the most common requests I get when people reach out to me for a performance advice is a request to explain <em>what monomorphism actually means</em>, how polymorphism arises and why it is bad.</p>
<p>It does not help that the word “polymorphism” itself is extremely overloaded. Within the classical object-oriented programming <em>polymorphism</em> usually means <a href="https://en.wikipedia.org/wiki/Subtyping">subtyping</a> and ability to override behavior of the base class. Haskell programmers would think about <a href="https://en.wikipedia.org/wiki/Parametric_polymorphism">parametric polymorphism</a> instead. However polymorphism which JS performance talks warn against is somewhat different — it’s a <em>call site polymorphism</em>.</p>
<p>I have explained this notion in so many different ways before that I finally decided to write a blog post about it - so that next time I can just link to it and not improvise.</p>
<p>[I also decided to try a new approach to explaining things - trying to capture interactions between various parts of the virtual machine in short comics. This is an new area for me, so please don’t hesitate and send any feedback my way. Does it make it easier to understand? Does it make it harder to understand? This post also omits various details that I considered not important, redundant or only tangentially related - feel free to send questions my way if you feel I omitted something you really wanted to know]</p>
<h2 id="dynamic-lookup-101">Dynamic lookup 101<a aria-hidden="true" class="anchor-heading icon-link" href="#dynamic-lookup-101"></a></h2>
<p><a href="https://mrale.ph/images/2015-01-11/v8-vs-ox.png">pic</a></p>
<p>For simplicity this post will mostly concentrate on the simplest property access in JavaScript, like <code>o.x</code> in the code below. At the same time it’s important to understand that everything we are going to talk about applies to any <em>dynamically bound</em> operation be it a property lookup or an arithmetic op and even goes beyond JavaScript.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> o<span class="token punctuation">.</span><span class="token property-access">x</span>
<span class="token punctuation">}</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>Imagine for a moment that you are interviewing for a great position at Interpreters Ltd. and your interviewer asks you to design and implement property lookup for a JavaScript VM. What would be the simplest and most straightforward answer to this question?</p>
<p>Obviously you can’t go any simpler than taking JS semantics as it is described in the ECMAScript Language Specification (aka ECMA 262) and transcribing <a href="https://es5.github.io/#x8.12.3">[[Get]]</a> algorithm word by word from English into C++, Java, Rust or Malbolge depending on your language of choice for the interview.</p>
<p>In fact if you open a random JS interpreter you most likely will discover something like this:</p>
<pre class="language-cpp"><code class="language-cpp">jsvalue <span class="token function">Get</span><span class="token punctuation">(</span>jsvalue self<span class="token punctuation">,</span> jsvalue property_name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 8.12.3 [[Get]] implementation goes here</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">Interpret</span><span class="token punctuation">(</span>jsbytecodes bc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token comment">/* has more bytecodes */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">case</span> OP_GETPROP<span class="token operator">:</span> <span class="token punctuation">{</span>
        jsvalue property_name <span class="token operator">=</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsvalue receiver <span class="token operator">=</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">push</span><span class="token punctuation">(</span><span class="token function">Get</span><span class="token punctuation">(</span>receiver<span class="token punctuation">,</span> property_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO(mraleph): throw exception in strict mode per 8.7.1 step 3.</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This is an absolutely valid way to implement property lookup, however it has one significant problem: if we pit our property lookup implementation against those used in modern JS VMs we will discover that it is far too slow.</p>
<p>Our interpreter is <em>amnesiac</em>: every time it does a property lookup it has to execute a generic property lookup algorithm, it does not learn anything from the previous attempts and has to pay full price again and again. That’s why performance oriented VMs implement property lookup in a different way.</p>
<p><img src="/images/2015-01-11/ic.png"></p>
<p>What if each property access in our program was capable of learning from objects that it saw before and apply this knowledge to similar objects? Potentially that would allow us to save a lot of time by avoiding costly generic lookup algorithm and instead use a quicker one that only applies to objects of certain <em>shape</em>.</p>
<p>We know that it is costly to figure out where the given property is inside an arbitrary object, so we would like to do this lookup once and then put the <em>path</em> to this property into a cache using <em>object’s shape</em> as a key. Next time we see an object with the same shape we can just get the path from the cache instead of computing it from scratch.</p>
<p>This optimization technique is known as <strong>Inline Caching</strong> and I have <a href="https://mrale.ph/blog/2012/06/03/explaining-js-vms-in-js-inline-caches.html">written about it before</a>. For this post I am going to leave concrete implementation details aside and will instead focus on an aspect I previously ignored: each inline cache is first and foremost <strong>a cache</strong> and just like any other cache it has <em>size</em> (number of currently cached entries) and <em>capacity</em> (maximum number of cached entries).</p>
<p>Lets take a look at the example again:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> o<span class="token punctuation">.</span><span class="token property-access">x</span>
<span class="token punctuation">}</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>What’s the expected number of cached entries for IC at <code>o.x</code>?</p>
<p>Given that <code>{x: 1}</code> and <code>{x: 2}</code> have the same shape (aka _hidden class_ or _map_) the answer is 1. This is precisely the state of cache that we call <em>monomorphic</em> because it saw only objects of a single shape.[mono- ("one") + -morphic ("of a form")]</p>
<p><img src="/images/2015-01-11/ic-poly.png"></p>
<p>What happens if we now call <code>f</code> with an object of a different shape?</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// o.x cache is still monomorphic here</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// what about now?</span>
</code></pre>
<p><code>{x: 3}</code> and <code>{x: 3, y: 1}</code> are objects of different shapes so the cache is no longer monomorphic, it now contains two cache entries one for a shape <code>{x: *}</code> and one for a shape <code>{x: *, y: *}</code> - our operation now is in <em>polymorphic</em> state with a degree of polymorphism <code>2</code>.</p>
<p>If we continue calling <code>f</code> with objects of different shapes it’s degree of polymorphism will continue to grow until it reaches a predefined threshold - maximum possible capacity for the inline cache (e.g. <code>4</code> for property loads in V8) - at that point cache will transition to a <em>megamorphic</em> state.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// polymorphic, degree 2</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> z<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// polymorphic, degree 3</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// polymorphic, degree 4</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// megamorphic</span>
</code></pre>
<p><img src="/images/2015-01-11/ic-mega.png"></p>
<p>Megamorphic state exists to prevent uncontrolled growth of polymorphic caches, it means <em>“I have seen too many shapes <strong>here</strong>, I give up tracking them”</em>. In V8 megamorphic ICs can still continue to cache things but instead of doing it locally they will put what they want to cache into a global hashtable. This hashtable has a fixed size and entries are simply overwritten on collisions.</p>
<p>Now a small exercise to check understanding:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">ff</span><span class="token punctuation">(</span><span class="token parameter">b<span class="token punctuation">,</span> o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> o<span class="token punctuation">.</span><span class="token property-access">x</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> o<span class="token punctuation">.</span><span class="token property-access">x</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">ff</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">ff</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">ff</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">ff</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<ol>
<li>How many property access inline caches are in the function <code>ff</code>?</li>
<li>What’s state they are in?</li>
</ol>
<p>Answers: there are 2 caches, both are monomorphic because each sees only objects of one shape.</p>
<h3 id="performance-implications">Performance implications<a aria-hidden="true" class="anchor-heading icon-link" href="#performance-implications"></a></h3>
<p>At this point performance characteristics of different IC states should become clear:</p>
<ul>
<li>monomorphic is the fastest possible IC state if you hit the cache all the time (<strong>ONE TYPE GOOD</strong>);</li>
<li>ICs in polymorphic state perform linear search among cached entries;</li>
<li>ICs in megamorphic state probe global hash table and thus are slowest among ICs, but hitting global cache is still better than complete IC miss;</li>
<li>IC miss is expensive - you have to pay for transitioning to runtime plus cost of the generic operation.</li>
</ul>
<p>However this is only half of the truth: in addition to speeding up your code inline caches also serve as <em>spies</em> for almighty optimizing compiler — which will eventually come and try to speed your code up even further.</p>
<h2 id="speculations-and-optimizations">Speculations and optimizations<a aria-hidden="true" class="anchor-heading icon-link" href="#speculations-and-optimizations"></a></h2>
<p>Inline caches can’t deliver peak performance alone due to two issues:</p>
<ul>
<li>each IC acts on its own, knowing nothing about its neighbors;</li>
<li>each IC can ultimately fallback to runtime if it can’t handle its input: which means it’s essentially a generic operation with generic side-effects and often unknown result type.</li>
</ul>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> o<span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">*</span> o<span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">+</span> o<span class="token punctuation">.</span><span class="token property-access">y</span> <span class="token operator">*</span> o<span class="token punctuation">.</span><span class="token property-access">y</span>
<span class="token punctuation">}</span>

<span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>For example in the function above each IC (there are 7: <code>.x</code>, <code>.x</code>, <code>*</code>, <code>.y</code>, <code>.y</code>, <code>*</code>, <code>+</code>) will act on its own. Each property load IC will check <code>o</code> against the same cached shape. Arithmetic IC at <code>+</code> will check whether its inputs are numbers (and what kind of number - as V8 internally has different number representations) - even though this could be derived from that state of <code>*</code> ICs.</p>
<p>Arithmetic operations in JavaScript are inherently typed e.g. <code>a|0</code> always returns 32-bit integer and <code>+a</code> always returns a number, but most other operations have no such guarantees. This turns writing an ahead-of-time optimizing compiler for JavaScript into an extremely difficult problem. Instead of compiling JavaScript once in an AOT fashion, most JavaScript VMs sport several execution tiers. For example in V8 code starts to execute without any optimizations, compiled with a baseline non-optimizing compiler. Hot functions are later recompiled by an optimizing compiler.[asm.js uses this inherent typing to define an extremely restricted subset of JavaScript that is completely statically typed and can be optimized ahead-of-time, removing the need for speculative adaptive compilation]</p>
<p>Waiting for code to warm up serves two distinct purposes:</p>
<ul>
<li>it decreases startup latency: optimizing compiler is slower than non-optimizing, which means optimized code should be used enough for optimizations to pay off;</li>
<li>it gives inline caches a chance to collect <em>type feedback</em>.</li>
</ul>
<p>As it was already stressed above human written JavaScript usually does not contain enough inherent type information to allow full static typing and AOT compilation. JIT has to speculate: it has to make <em>educated</em> guesses about the usage and behavior of the code it optimizes and generate specialized code that is valid under certain assumptions. In other words compiler needs to guess what kind of objects are seen in a particular place in the function it optimizes. By a lucky coincidence that’s precisely the information inline caches collect!</p>
<ul>
<li>Monomorphic cache says “I’ve <strong>only</strong> seen type A”;</li>
<li>Polymorphic cache of degree N says “I’ve <strong>only</strong> seen A<sub>1</sub>, …, A<sub>N</sub>”;</li>
<li>Megamorphic cache says “I’ve seen a lot of things.”;</li>
</ul>
<p><img src="/images/2015-01-11/opt-0.png"></p>
<p>Optimizing compiler looks at the information collected by inline caches and builds <em>intermediate representation</em> (IR) accordingly. IR instructions are usually more specific and low level than generic JS operations. For example if IC for <code>.x</code> saw only objects of shape <code>{x, y}</code> then optimizer can take an IR instruction that loads property from a fixed offset inside an object and use it to load <code>.x</code>. Of course it is unsafe to apply such instruction to arbitrary objects so optimizer prepends a <em>type guard</em> before it. Type guard checks the shape of the object before it reaches specialized operation and if it does not match an expected shape the execution of the optimized code <strong>can not</strong> continue - instead we have to jump into the unoptimized code and continue execution there. This process is called <em>deoptimization</em>. Deoptimization reasons however are not limited to type guard violations: arithmetic operation can be specialized for 32bit integers and will deoptimize if result overflows this representation, an indexed property load <code>arr[idx]</code> can be specialized for a inbounds access and will deoptimize if <code>idx</code> is out of bounds or <code>arr</code> has no property <code>idx</code> (it’s a <em>hole</em>), etc.</p>
<p><img src="/images/2015-01-11/opt-deopts.png"></p>
<p>It should now become clear that the process of optimization tries to address two previously outlined weaknesses:</p>
<table><tbody><tr><td><strong>unoptimized</strong></td><td><strong>optimized</strong></td></tr><tr><td>each operation has arbitrary unknown side effects because it is generic and implements full semantics</td><td>code specializations limit or eliminate unpredictability, side-effects are well defined (e.g. load of property by offset has no side-effects)</td></tr><tr><td>each operation is on its own, learns individually and does not exchange information with neighbors</td><td>operations are decomposed into lower level IR instructions which are then optimized together, this allows to discover and eliminate redundancies between them</td></tr></tbody></table>
<p><img src="/images/2015-01-11/opt-se.png"></p>
<p>Indeed building specialized IR based on the type feedback is just the first step in the optimization pipeline. Once IR is ready compiler will run multiple passes over it trying to discover invariants and eliminate redundancies. Analyses that are run at this stage usually are <em>intraprocedural</em> and compiler is forced to assume the worst arbitrary side-effects every time it encounters a call. Here it is important to realize that generic unspecialized operations are essentially <em>calls</em> themselves: e.g. <code>+</code> evaluation can call <code>valueOf</code> and a property access <code>o.x</code> can easily result in a getter invocation. This means any operation which optimizer for some reason failed to specialize completely might become a stumbling block for subsequent optimization passes.</p>
<p>One very common case of redundancy are repeated type guards that check the same value against the same shape. Here is how initial IR for function <code>g</code> (see above) could have looked like:</p>
<table style="border-spacing: 0px; border-collapse: collapse;"><tbody><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""></td><td class=""><span class="boldy">CheckMap</span> <span class="ir-ref">v0</span>, {x,y}  <span class="c1">;; shape check</span> </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""><span class="ir-ref">v1</span></td><td class=""><span class="boldy">Load</span> <span class="ir-ref">v0</span>, @<span class="mi">12</span>        <span class="c1">;; load o.x</span> </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""></td><td class=""><span class="boldy">CheckMap</span> <span class="ir-ref">v0</span>, {x,y} </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""><span class="ir-ref">v2</span></td><td class=""><span class="boldy">Load</span> <span class="ir-ref">v0</span>, @<span class="mi">12</span>        <span class="c1">;; load o.x</span> </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""><span class="ir-ref">i3</span></td><td class=""><span class="boldy">Mul</span> <span class="ir-ref">v1</span>, <span class="ir-ref">v2</span>          <span class="c1">;; o.x * o.x</span> </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""></td><td class=""><span class="boldy">CheckMap</span> <span class="ir-ref">v0</span>, {x,y} </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""><span class="ir-ref">v4</span></td><td class=""><span class="boldy">Load</span> <span class="ir-ref">v0</span>, @<span class="mi">16</span>        <span class="c1">;; load o.y</span> </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""></td><td class=""><span class="boldy">CheckMap</span> <span class="ir-ref">v0</span>, {x,y} </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""><span class="ir-ref">v5</span></td><td class=""><span class="boldy">Load</span> <span class="ir-ref">v0</span>, @<span class="mi">16</span>        <span class="c1">;; load o.y</span> </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""><span class="ir-ref">i6</span></td><td class=""><span class="boldy">Mul</span> <span class="ir-ref">v4</span>, <span class="ir-ref">v5</span>          <span class="c1">;; o.y * o.y</span> </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""><span class="ir-ref">i7</span></td><td class=""><span class="boldy">Add</span> <span class="ir-ref">i3</span>, <span class="ir-ref">i6</span>          <span class="c1">;; o.x * o.x + o.y * o.y</span> </td></tr></tbody></table>
<p>This IR checks <code>v0</code> against the same shape 4 times even though there is nothing between checks that could affect the <code>v0</code>’s shape. Attentive reader will also spot that loads <code>v2</code> and <code>v5</code> are redundant too, as nothing is writing into corresponding properties. Fortunately the <a href="https://en.wikipedia.org/wiki/Global_value_numbering">GVN</a> pass that is later applied to the IR will eliminate redundant checks and loads:</p>
<table style="border-spacing: 0px; border-collapse: collapse;"><tbody><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""></td><td class=""><span class="boldy"></span><span class="c1">;; After GVN</span> </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""></td><td class=""><span class="boldy">CheckMap</span> <span class="ir-ref">v0</span>, {x,y} </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""><span class="ir-ref">v1</span></td><td class=""><span class="boldy">Load</span> <span class="ir-ref">v0</span>, @<span class="mi">12</span> </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""><span class="ir-ref">i3</span></td><td class=""><span class="boldy">Mul</span> <span class="ir-ref">v1</span>, <span class="ir-ref">v1</span> </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""><span class="ir-ref">v4</span></td><td class=""><span class="boldy">Load</span> <span class="ir-ref">v0</span>, @<span class="mi">16</span> </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""><span class="ir-ref">i6</span></td><td class=""><span class="boldy">Mul</span> <span class="ir-ref">v4</span>, <span class="ir-ref">v4</span> </td></tr><tr><td style="border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;" data-darkreader-inline-border-right=""><span class="ir-ref">i7</span></td><td class=""><span class="boldy">Add</span> <span class="ir-ref">i3</span>, <span class="ir-ref">i6</span> </td></tr></tbody></table>
<p>However as noted above such elimination is only possible because there are no interfering side effects between redundant operations: if there were a call between <code>v1</code> and <code>v2</code> we would have to conservatively assume that callee might potentially have access to <code>v0</code> and thus can add, remove and change properties - this would make impossible to eliminate access <code>v2</code> or <code>CheckMap</code> that guards it.</p>
<p>Now that we have a basic understanding of optimizing compiler and know what it likes (specialized ops) and dislikes (calls and generic ops) there is only one thing left to discuss: handling of non-monomorphic operations by the optimizing compiler.</p>
<p>If operation is non-monomorphic optimizing compiler obviously can’t use that simple specialization rule <code>type-guard + specialized-op</code> we were discussing before. It simply will not be able to select a single type for a type guard and single specialized operation. IC tells the compiler that this operation sees values of different types/shapes thus picking a single one of them and ignoring the rest means risking deoptimization, which is highly undesirable. Instead optimizing compiler will usually try to build a <em>decision tree</em>. For example a polymorphic property access <code>o.x</code> that saw shapes <code>A</code>, <code>B</code>, <code>C</code> will be expanded into something like this (note this is pseudocode - optimizing compiler would build a CFG structure instead):</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> o_x
<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">$GetShape</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant">A</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  o_x <span class="token operator">=</span> <span class="token function">$LoadByOffset</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset_A_x<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">$GetShape</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant">B</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  o_x <span class="token operator">=</span> <span class="token function">$LoadByOffset</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset_B_x<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">$GetShape</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant">C</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  o_x <span class="token operator">=</span> <span class="token function">$LoadByOffset</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset_C_x<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// o.x saw only A, B, C so we assume</span>
  <span class="token comment">// there can be *nothing* else</span>
  <span class="token function">$Deoptimize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// Note: at this point we can only say that</span>
<span class="token comment">// o is either A, B or C. But we lost information</span>
<span class="token comment">// which one.</span>
</code></pre>
<p>One thing to notice here is that polymorphic accesses lack useful property that monomorphic accesses have. After specialized monomorphic access and until an interfering side-effect we can guarantee that object has a certain shape. This allows to eliminate redundancy between monomorphic accesses. Polymorphic accesses give a very weak guarantee “object’s shape is one of A, B, C”. We can’t use this information to eliminate much redundancy between two similar polymorphic accesses that follow each other (at most we could use it to eliminate the last comparison and deoptimization block - but V8 does not try to do this).</p>
<p>V8 however does build a more efficient IR if property is located in the same place in <em>all</em> shapes. In this case a polymorphic type guard will be emitted instead of the decision tree:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Check that o's shape is one of A, B or C - deoptimize otherwise.</span>
<span class="token function">$TypeGuard</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// Load property. It's in the same place in A, B and C.</span>
<span class="token keyword">var</span> o_x <span class="token operator">=</span> <span class="token function">$LoadByOffset</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset_x<span class="token punctuation">)</span>
</code></pre>
<p>This IR has one important benefit for redundancy elimination: if there are no interfering side effects between two <code>$TypeGuard(o, [A, B, C])</code> instructions then the second one is redundant just like in the monomorphic case.</p>
<p>If type feedback tells optimizing compiler that property access saw more different shapes than optimizing compiler considers feasible to handle inline then optimizer will instead build a slightly different decision tree that ends with a generic operation instead of deoptimization:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> o_x
<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">$GetShape</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant">A</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  o_x <span class="token operator">=</span> <span class="token function">$LoadByOffset</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset_A_x<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">$GetShape</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant">B</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  o_x <span class="token operator">=</span> <span class="token function">$LoadByOffset</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset_B_x<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">$GetShape</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant">C</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  o_x <span class="token operator">=</span> <span class="token function">$LoadByOffset</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset_C_x<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// We know that o.x is too polymorphic (megamorphic).</span>
  <span class="token comment">// to avoid deoptimizations leave escape hatch to handle</span>
  <span class="token comment">// arbitrary object:</span>
  o_x <span class="token operator">=</span> <span class="token function">$LoadPropertyGeneric</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> <span class="token string">"x"</span><span class="token punctuation">)</span>
  <span class="token comment">//    ^^^^^^^^^^^^^^^^^^^^ arbitrary side effects</span>
<span class="token punctuation">}</span>
<span class="token comment">// Note: at this point nothing is known about</span>
<span class="token comment">// o's shape and furthermore arbitrary</span>
<span class="token comment">// side-effects could have happened.</span>
</code></pre>
<p>Finally in some cases optimizing compiler can completely give up on specializing operations:</p>
<ul>
<li>if it does not know how to efficiently specialize it;</li>
<li>operation is polymorphic and optimizer does not know how to build a decision tree correctly for this operation (e.g. used to be the case for polymorphic keyed accesses <code>arr[i]</code> in V8 - but not anymore);</li>
<li>operation does not have any actionable type feedback to specialize upon (operation were never executed, GC cleared collected type feedback, etc).</li>
</ul>
<p>In all such (arguably rare) cases the optimizer just emits a generic variant of the operation in the IR.</p>
<h3 id="performance-implications-1">Performance implications<a aria-hidden="true" class="anchor-heading icon-link" href="#performance-implications-1"></a></h3>
<p>Lets summarize what we learned:</p>
<ul>
<li>monomorphic operations are easiest to specialize, give optimizer most actionable information and enable further optimizations. Hulk-style summary <strong>ONE TYPE CLOSE TO METAL</strong>!</li>
<li>moderately polymorphic operations which require a polymorphic type guard or in the worst case a decision tree are slower then monomorphic ones.
<ul>
<li>Decision trees complicate control flow and make it harder for optimizer to propagate types and eliminate redundancies. Memory dependent conditional jumps that constitute those decision trees might be bad news if polymorphic operation is right in the middle of the tight number crunching loop;</li>
<li>Polymorphic type guards don’t obstruct type flow that much and still allow for some redundancy elimination - but each polymorphic type guard is still somewhat slower than monomorphic type guard (that checks against one shape). Performance penalty for a polymorphic type guard depends on how well CPU handles conditional branches;</li>
</ul>
</li>
<li>highly polymorphic/megamorphic operations are not specialized entirely and result in a generic operation being emitted as part of the optimized IR. This generic operation is a call - with all associated bad consequences for both optimizations and raw CPU performance.</li>
</ul>
<p>Take a look at <a href="https://jsperf.com/monomorphism-vs-polymorphism/11">this microbenchmark</a> trying to capture the difference between all these cases for a property access: monomorphic, polymorphic with matching property offsets (requires polymorphic type guard), polymorphic with different property offsets (requires decision tree), megamorphic.</p>
<h1 id="undiscussed">Undiscussed<a aria-hidden="true" class="anchor-heading icon-link" href="#undiscussed"></a></h1>
<p>I have intentionally ignored some implementation details when writing this post to avoid making it too broad in scope.</p>
<h3 id="shapes">Shapes<a aria-hidden="true" class="anchor-heading icon-link" href="#shapes"></a></h3>
<p>We did not discuss at all how shapes (aka hidden classes) are represented, computed and attached to objects. Check out my <a href="https://mrale.ph/blog/2012/06/03/explaining-js-vms-in-js-inline-caches.html">post on inline caches</a>, some of my talks e.g. <a href="https://mrale.ph/talks/awp2014/#/26">AWP2014</a> one to get the basic idea.</p>
<p>One important thing to realize here that the notion of <em>shape</em> in JavaScript VMs is a heuristical approximation. It’s an attempt to dynamically approximate static structure hidden in the program. Things that are shaped the same for a human might not necessary have the same shape for the VM:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token constant">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  c <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  d <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>

<span class="token keyword">delete</span> d<span class="token punctuation">.</span><span class="token property-access">y</span>
<span class="token comment">// a, b, c, d all have DIFFERENT SHAPES for V8</span>
</code></pre>
<p>Fluffy dictionary nature of JavaScript objects also makes it easy to create <em>accidental</em> polymorphism:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token constant">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// same shape</span>

<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>something<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  a<span class="token punctuation">.</span><span class="token property-access">y</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// shape of a no longer matches b.</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="intentional-polymorphism">Intentional polymorphism<a aria-hidden="true" class="anchor-heading icon-link" href="#intentional-polymorphism"></a></h3>
<p>Even if you are programming a language that only allows you to instantiate fixed shape objects (Java, C#, Dart, C++, etc) from rigid classes you can still write polymorphic code:</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">doX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token keyword">implements</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">doX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">implements</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span>
  <span class="token keyword">void</span> <span class="token function">doX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Base</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  obj<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">handle</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">handle</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// obj.foo() callsite is polymorphic</span>
</code></pre>
<p>Being able to write code against the <em>interface</em> and have this code process objects of different <em>implementation</em> is an important abstraction mechanism. Polymorphism in statically typed programming languages has similar performance implications to the ones discussed above.[unsurprisingly JVMs use inline caches to optimize <code>invokeinterface</code> and <code>invokevirtual</code> calls]</p>
<h3 id="not-all-caches-are-the-same">Not all caches are the same<a aria-hidden="true" class="anchor-heading icon-link" href="#not-all-caches-are-the-same"></a></h3>
<p>It might be good to keep in mind that some caches are not shape based and/or have lower <em>capacity</em> than others. For example cache associated with a function invocation is either uninitialized, monomorphic or megamorphic with no intermediate polymorphic state. Instead of caching function’s shape which is irrelevant for an invocation it caches <em>invocation target</em> - that is function itself.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">inv</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token constant">F</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> v
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token constant">G</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> v <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token function">inv</span><span class="token punctuation">(</span><span class="token constant">F</span><span class="token punctuation">)</span>
<span class="token comment">// inline cache is monomorpic, points to F</span>
<span class="token function">inv</span><span class="token punctuation">(</span><span class="token constant">G</span><span class="token punctuation">)</span>
<span class="token comment">// inline cache is megamorphic</span>
</code></pre>
<p>If <code>inv</code> is optimized when inline cache for <code>cb(...)</code> invocation is monomorphic then optimizing compiler can potentially inline this call (which is very important for small functions on hot paths). When this cache is megamorphic optimizer will not be able to inline anything (it does not know <em>what</em> - as there is no single target) and will just leave a generic invocation operation in the IR.</p>
<p>This comes in contrast with method invocation expressions <code>o.m(...)</code> that are handled similarly to property accesses. ICs at method invocation sites have intermediate polymorphic state between monomorphic and megamorphic state. V8 is capable of inlining at monomorphic, polymorphic and megamorphic sites and it builds IR in the same way as for properties: choosing between a decision tree or a single polymorphic type guard before inlined function body. There is one limitation however: for V8 to be able to inline method call it needs <em>it to be part of the shape</em>.[in fact <code>o.m(...)</code> compiles into two ICs: one <code>LoadIC</code> that does property load and another <code>CallIC</code> that invokes loaded property with appropriate receiver and arguments. <code>CallIC</code> is the same kind of IC that is described above for <code>cb(...)</code>-like calls. It is only capable of recording monomorphic only megamorphic state. That's why its state is ignored when optimizing method call and only state of the property load IC is used]</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">inv</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> o<span class="token punctuation">.</span><span class="token method function property-access">cb</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> f <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">cb</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token constant">F</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> v
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> g <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">cb</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token constant">G</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> v <span class="token operator">+</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token function">inv</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
<span class="token function">inv</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
<span class="token comment">// here inline cache is monomorpic, have seen only objects with</span>
<span class="token comment">// a shape like f.</span>
<span class="token function">inv</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span>
<span class="token comment">// here inline cache is polymorphic, seen objects with two different</span>
<span class="token comment">// shapes: like f and like g</span>
</code></pre>
<p>It might be surprising that <code>f</code> and <code>g</code> have different shapes above. This happens because when we assign a function to a property V8 tries (if possible) to attach it to object’s shape instead of saving it directly on the object. In this example <code>f</code> has a shape like this <code>{cb: F}</code> i.e. the shape itself is pointing directly to the closure. In our previous examples we only had shapes that simply declared the presence of the property at a certain offset, however this shape also captures the value of the property. This makes V8’s shapes similar to classes in an language like Java or C++ where class is essentially a set of fields <em>and methods</em>.</p>
<p>Of course if you later overwrite functional property with a different function V8 decides that this doesn’t look like a class-method relationship and switches to a shape that reflects this:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> f <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">cb</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token constant">F</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> v
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// Shape of f is {cb: F}</span>

f<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">cb</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token constant">H</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> v <span class="token operator">-</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token comment">// Shape of f is {cb: *}</span>
</code></pre>
<p>Overall the topic of how V8 builds and maintains shapes (hidden classes) is worthy of a large separate post by itself.</p>
<h3 id="representing-path-to-the-property">Representing <em>path-to-the-property</em><a aria-hidden="true" class="anchor-heading icon-link" href="#representing-path-to-the-property"></a></h3>
<p>At this point it might seem that IC associated with property <code>o.x</code> is simply a dictionary mapping shapes to property offsets, something like <code>Dictionary&#x3C;Shape, int></code>. However this representation is way too narrow to be useful: property can reside on one of the objects within the prototype chain or be an <em>accessor property</em> (one with a getter and/or a setter). An interesting observation to make here is that accessor properties are in the certain sense more generic than normal data properties.</p>
<p>For example <code>o = {x: 1}</code> can be perceived as an object with an accessor property <code>x</code> that has a getter/setter accessing a hidden internal slot using VM intrinsics:[Dart VM implements fields access in this way]</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// pseudo-code reimagining o = { x: 1 }</span>
<span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">$LoadByOffset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> offset_of_x<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">set</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">$StoreByOffset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> offset_of_x<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// both getter and setter are generated internally by VM</span>
  <span class="token comment">// and are invisible to normal JS code.</span>
<span class="token punctuation">}</span>
<span class="token function">$StoreByOffset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> offset_of_x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre>
<p>In the light of this observation it becomes clear that IC should be more akin to <code>Dictionary&#x3C;Shape, Function></code>: mapping shapes to accessor functions that should be executed IC is hit. Such IC representation would allow to optimize cases that were impossible to cover with a simplistic representation from the above (properties on the prototype chain, accessor properties and even ES6 proxy objects).[in reality V8's ICs are patchable callsites that call special runtime generated IC stubs, see <a href="https://mrale.ph/blog/2012/06/03/explaining-js-vms-in-js-inline-caches.html">this post</a> for more accurate analogy]</p>
<h3 id="premonomorphic-state">Premonomorphic state<a aria-hidden="true" class="anchor-heading icon-link" href="#premonomorphic-state"></a></h3>
<p>Some ICs in V8 actually have so called <em>premonomorphic</em> state between <em>unitialized</em> and <em>monomorphic</em>. It exists to avoid compiling IC stubs for ICs that are only executed once. I decided to avoid discussing this state because it is a somewhat obscure implementation detail.</p>
<h1 id="final-performance-advice">Final performance advice<a aria-hidden="true" class="anchor-heading icon-link" href="#final-performance-advice"></a></h1>
<p>The best performance advice is hidden in the title of Dale Carnegie’s book “How to Stop Worrying and Start Living”.</p>
<p>Indeed worrying about polymorphism is usually futile. Instead benchmark your code on a realistic dataset, profile it for hotspots and if any of them are JS related - check out IR that optimizing compiler produces.</p>
<p>If in the middle of your tight number crunching loop you see IR instruction called <code>XYZGeneric</code> or anything marked with red <code>changes[*]</code> (aka “changes everything”) marker - then (only then!) it might be the right time to start worrying.</p>
<h1 id="the-end">THE END<a aria-hidden="true" class="anchor-heading icon-link" href="#the-end"></a></h1></div></div><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-0 ant-col-md-6"><div><div class=""><div class="ant-anchor-wrapper dendron-toc" style="max-height:calc(100vh - 64px);z-index:1"><div class="ant-anchor"><div class="ant-anchor-ink"><span class="ant-anchor-ink-ball"></span></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#dynamic-lookup-101" title="Dynamic lookup 101">Dynamic lookup 101</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#performance-implications" title="Performance implications">Performance implications</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#speculations-and-optimizations" title="Speculations and optimizations">Speculations and optimizations</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#performance-implications-1" title="Performance implications">Performance implications</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#undiscussed" title="Undiscussed">Undiscussed</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#shapes" title="Shapes">Shapes</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#intentional-polymorphism" title="Intentional polymorphism">Intentional polymorphism</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#not-all-caches-are-the-same" title="Not all caches are the same">Not all caches are the same</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#representing-path-to-the-property" title="Representing path-to-the-property">Representing path-to-the-property</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#premonomorphic-state" title="Premonomorphic state">Premonomorphic state</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#final-performance-advice" title="Final performance advice">Final performance advice</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#the-end" title="THE END">THE END</a></div></div></div></div></div></div></div></div></div></div></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><footer class="ant-layout-footer" style="padding:0 24px 24px"></footer></main></section></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"note":{"id":"l6abcjmsuol9bri9885t1kf","title":"What's up with monomorphism?","desc":"","updated":1676533530651,"created":1676533428995,"custom":{},"fname":"dev.javascript.performance.whats-up-with-monomorphism","type":"note","vault":{"fsPath":"vault"},"contentHash":"aa57368c701dbdc6b493f89fc22d0fb3","links":[],"anchors":{"dynamic-lookup-101":{"type":"header","text":"Dynamic lookup 101","value":"dynamic-lookup-101","line":18,"column":0,"depth":2},"performance-implications":{"type":"header","text":"Performance implications","value":"performance-implications","line":137,"column":0,"depth":3},"speculations-and-optimizations":{"type":"header","text":"Speculations and optimizations","value":"speculations-and-optimizations","line":148,"column":0,"depth":2},"performance-implications-1":{"type":"header","text":"Performance implications","value":"performance-implications-1","line":267,"column":0,"depth":3},"undiscussed":{"type":"header","text":"Undiscussed","value":"undiscussed","line":279,"column":0,"depth":1},"shapes":{"type":"header","text":"Shapes","value":"shapes","line":283,"column":0,"depth":3},"intentional-polymorphism":{"type":"header","text":"Intentional polymorphism","value":"intentional-polymorphism","line":321,"column":0,"depth":3},"not-all-caches-are-the-same":{"type":"header","text":"Not all caches are the same","value":"not-all-caches-are-the-same","line":349,"column":0,"depth":3},"representing-path-to-the-property":{"type":"header","text":"Representing path-to-the-property","value":"representing-path-to-the-property","line":423,"column":0,"depth":3},"premonomorphic-state":{"type":"header","text":"Premonomorphic state","value":"premonomorphic-state","line":446,"column":0,"depth":3},"final-performance-advice":{"type":"header","text":"Final performance advice","value":"final-performance-advice","line":450,"column":0,"depth":1},"the-end":{"type":"header","text":"THE END","value":"the-end","line":458,"column":0,"depth":1}},"children":[],"parent":"qJYy3qzZt6rXHWQJPZd9Q","data":{}},"body":"\u003ch1 id=\"whats-up-with-monomorphism\"\u003eWhat's up with monomorphism?\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#whats-up-with-monomorphism\"\u003e\u003c/a\u003e\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ca href=\"https://mrale.ph/blog/2015/01/11/whats-up-with-monomorphism.html\"\u003ehttps://mrale.ph/blog/2015/01/11/whats-up-with-monomorphism.html\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eTalks and blog posts about JavaScript performance often emphasize importance of \u003cem\u003emonomorphic\u003c/em\u003e code. However they usually don’t provide any digestible explanation of what monomorphism/polymorhism is and why it matters. Even my own talks often boil down to Hulk-style «\u003cstrong\u003eONE TYPE GOOD. TWO TYPE BAD!!!\u003c/strong\u003e» dichotomy. Unsurprisingly one of the most common requests I get when people reach out to me for a performance advice is a request to explain \u003cem\u003ewhat monomorphism actually means\u003c/em\u003e, how polymorphism arises and why it is bad.\u003c/p\u003e\n\u003cp\u003eIt does not help that the word “polymorphism” itself is extremely overloaded. Within the classical object-oriented programming \u003cem\u003epolymorphism\u003c/em\u003e usually means \u003ca href=\"https://en.wikipedia.org/wiki/Subtyping\"\u003esubtyping\u003c/a\u003e and ability to override behavior of the base class. Haskell programmers would think about \u003ca href=\"https://en.wikipedia.org/wiki/Parametric_polymorphism\"\u003eparametric polymorphism\u003c/a\u003e instead. However polymorphism which JS performance talks warn against is somewhat different — it’s a \u003cem\u003ecall site polymorphism\u003c/em\u003e.\u003c/p\u003e\n\u003cp\u003eI have explained this notion in so many different ways before that I finally decided to write a blog post about it - so that next time I can just link to it and not improvise.\u003c/p\u003e\n\u003cp\u003e[I also decided to try a new approach to explaining things - trying to capture interactions between various parts of the virtual machine in short comics. This is an new area for me, so please don’t hesitate and send any feedback my way. Does it make it easier to understand? Does it make it harder to understand? This post also omits various details that I considered not important, redundant or only tangentially related - feel free to send questions my way if you feel I omitted something you really wanted to know]\u003c/p\u003e\n\u003ch2 id=\"dynamic-lookup-101\"\u003eDynamic lookup 101\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#dynamic-lookup-101\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://mrale.ph/images/2015-01-11/v8-vs-ox.png\"\u003epic\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eFor simplicity this post will mostly concentrate on the simplest property access in JavaScript, like \u003ccode\u003eo.x\u003c/code\u003e in the code below. At the same time it’s important to understand that everything we are going to talk about applies to any \u003cem\u003edynamically bound\u003c/em\u003e operation be it a property lookup or an arithmetic op and even goes beyond JavaScript.\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eo\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e o\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ex\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eImagine for a moment that you are interviewing for a great position at Interpreters Ltd. and your interviewer asks you to design and implement property lookup for a JavaScript VM. What would be the simplest and most straightforward answer to this question?\u003c/p\u003e\n\u003cp\u003eObviously you can’t go any simpler than taking JS semantics as it is described in the ECMAScript Language Specification (aka ECMA 262) and transcribing \u003ca href=\"https://es5.github.io/#x8.12.3\"\u003e[[Get]]\u003c/a\u003e algorithm word by word from English into C++, Java, Rust or Malbolge depending on your language of choice for the interview.\u003c/p\u003e\n\u003cp\u003eIn fact if you open a random JS interpreter you most likely will discover something like this:\u003c/p\u003e\n\u003cpre class=\"language-cpp\"\u003e\u003ccode class=\"language-cpp\"\u003ejsvalue \u003cspan class=\"token function\"\u003eGet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ejsvalue self\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e jsvalue property_name\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// 8.12.3 [[Get]] implementation goes here\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003eInterpret\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ejsbytecodes bc\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token comment\"\u003e/* has more bytecodes */\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eswitch\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eop\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003ecase\u003c/span\u003e OP_GETPROP\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        jsvalue property_name \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003epop\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        jsvalue receiver \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003epop\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003epush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eGet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ereceiver\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e property_name\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// TODO(mraleph): throw exception in strict mode per 8.7.1 step 3.\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ebreak\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n      \u003cspan class=\"token comment\"\u003e// ...\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is an absolutely valid way to implement property lookup, however it has one significant problem: if we pit our property lookup implementation against those used in modern JS VMs we will discover that it is far too slow.\u003c/p\u003e\n\u003cp\u003eOur interpreter is \u003cem\u003eamnesiac\u003c/em\u003e: every time it does a property lookup it has to execute a generic property lookup algorithm, it does not learn anything from the previous attempts and has to pay full price again and again. That’s why performance oriented VMs implement property lookup in a different way.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2015-01-11/ic.png\"\u003e\u003c/p\u003e\n\u003cp\u003eWhat if each property access in our program was capable of learning from objects that it saw before and apply this knowledge to similar objects? Potentially that would allow us to save a lot of time by avoiding costly generic lookup algorithm and instead use a quicker one that only applies to objects of certain \u003cem\u003eshape\u003c/em\u003e.\u003c/p\u003e\n\u003cp\u003eWe know that it is costly to figure out where the given property is inside an arbitrary object, so we would like to do this lookup once and then put the \u003cem\u003epath\u003c/em\u003e to this property into a cache using \u003cem\u003eobject’s shape\u003c/em\u003e as a key. Next time we see an object with the same shape we can just get the path from the cache instead of computing it from scratch.\u003c/p\u003e\n\u003cp\u003eThis optimization technique is known as \u003cstrong\u003eInline Caching\u003c/strong\u003e and I have \u003ca href=\"https://mrale.ph/blog/2012/06/03/explaining-js-vms-in-js-inline-caches.html\"\u003ewritten about it before\u003c/a\u003e. For this post I am going to leave concrete implementation details aside and will instead focus on an aspect I previously ignored: each inline cache is first and foremost \u003cstrong\u003ea cache\u003c/strong\u003e and just like any other cache it has \u003cem\u003esize\u003c/em\u003e (number of currently cached entries) and \u003cem\u003ecapacity\u003c/em\u003e (maximum number of cached entries).\u003c/p\u003e\n\u003cp\u003eLets take a look at the example again:\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eo\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e o\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ex\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWhat’s the expected number of cached entries for IC at \u003ccode\u003eo.x\u003c/code\u003e?\u003c/p\u003e\n\u003cp\u003eGiven that \u003ccode\u003e{x: 1}\u003c/code\u003e and \u003ccode\u003e{x: 2}\u003c/code\u003e have the same shape (aka _hidden class_ or _map_) the answer is 1. This is precisely the state of cache that we call \u003cem\u003emonomorphic\u003c/em\u003e because it saw only objects of a single shape.[mono- (\"one\") + -morphic (\"of a form\")]\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2015-01-11/ic-poly.png\"\u003e\u003c/p\u003e\n\u003cp\u003eWhat happens if we now call \u003ccode\u003ef\u003c/code\u003e with an object of a different shape?\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// o.x cache is still monomorphic here\u003c/span\u003e\n\u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e y\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// what about now?\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003e{x: 3}\u003c/code\u003e and \u003ccode\u003e{x: 3, y: 1}\u003c/code\u003e are objects of different shapes so the cache is no longer monomorphic, it now contains two cache entries one for a shape \u003ccode\u003e{x: *}\u003c/code\u003e and one for a shape \u003ccode\u003e{x: *, y: *}\u003c/code\u003e - our operation now is in \u003cem\u003epolymorphic\u003c/em\u003e state with a degree of polymorphism \u003ccode\u003e2\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eIf we continue calling \u003ccode\u003ef\u003c/code\u003e with objects of different shapes it’s degree of polymorphism will continue to grow until it reaches a predefined threshold - maximum possible capacity for the inline cache (e.g. \u003ccode\u003e4\u003c/code\u003e for property loads in V8) - at that point cache will transition to a \u003cem\u003emegamorphic\u003c/em\u003e state.\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e y\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// polymorphic, degree 2\u003c/span\u003e\n\u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e5\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e z\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// polymorphic, degree 3\u003c/span\u003e\n\u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e a\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// polymorphic, degree 4\u003c/span\u003e\n\u003cspan class=\"token function\"\u003ef\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e7\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e b\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// megamorphic\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cimg src=\"/images/2015-01-11/ic-mega.png\"\u003e\u003c/p\u003e\n\u003cp\u003eMegamorphic state exists to prevent uncontrolled growth of polymorphic caches, it means \u003cem\u003e“I have seen too many shapes \u003cstrong\u003ehere\u003c/strong\u003e, I give up tracking them”\u003c/em\u003e. In V8 megamorphic ICs can still continue to cache things but instead of doing it locally they will put what they want to cache into a global hashtable. This hashtable has a fixed size and entries are simply overwritten on collisions.\u003c/p\u003e\n\u003cp\u003eNow a small exercise to check understanding:\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003eff\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eb\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e o\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eb\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e o\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ex\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e o\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ex\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003eff\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eff\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e y\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eff\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eff\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e y\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003col\u003e\n\u003cli\u003eHow many property access inline caches are in the function \u003ccode\u003eff\u003c/code\u003e?\u003c/li\u003e\n\u003cli\u003eWhat’s state they are in?\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eAnswers: there are 2 caches, both are monomorphic because each sees only objects of one shape.\u003c/p\u003e\n\u003ch3 id=\"performance-implications\"\u003ePerformance implications\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#performance-implications\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eAt this point performance characteristics of different IC states should become clear:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003emonomorphic is the fastest possible IC state if you hit the cache all the time (\u003cstrong\u003eONE TYPE GOOD\u003c/strong\u003e);\u003c/li\u003e\n\u003cli\u003eICs in polymorphic state perform linear search among cached entries;\u003c/li\u003e\n\u003cli\u003eICs in megamorphic state probe global hash table and thus are slowest among ICs, but hitting global cache is still better than complete IC miss;\u003c/li\u003e\n\u003cli\u003eIC miss is expensive - you have to pay for transitioning to runtime plus cost of the generic operation.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHowever this is only half of the truth: in addition to speeding up your code inline caches also serve as \u003cem\u003espies\u003c/em\u003e for almighty optimizing compiler — which will eventually come and try to speed your code up even further.\u003c/p\u003e\n\u003ch2 id=\"speculations-and-optimizations\"\u003eSpeculations and optimizations\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#speculations-and-optimizations\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eInline caches can’t deliver peak performance alone due to two issues:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eeach IC acts on its own, knowing nothing about its neighbors;\u003c/li\u003e\n\u003cli\u003eeach IC can ultimately fallback to runtime if it can’t handle its input: which means it’s essentially a generic operation with generic side-effects and often unknown result type.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003eg\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eo\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e o\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ex\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e o\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ex\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e o\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ey\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e o\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ey\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003eg\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e y\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFor example in the function above each IC (there are 7: \u003ccode\u003e.x\u003c/code\u003e, \u003ccode\u003e.x\u003c/code\u003e, \u003ccode\u003e*\u003c/code\u003e, \u003ccode\u003e.y\u003c/code\u003e, \u003ccode\u003e.y\u003c/code\u003e, \u003ccode\u003e*\u003c/code\u003e, \u003ccode\u003e+\u003c/code\u003e) will act on its own. Each property load IC will check \u003ccode\u003eo\u003c/code\u003e against the same cached shape. Arithmetic IC at \u003ccode\u003e+\u003c/code\u003e will check whether its inputs are numbers (and what kind of number - as V8 internally has different number representations) - even though this could be derived from that state of \u003ccode\u003e*\u003c/code\u003e ICs.\u003c/p\u003e\n\u003cp\u003eArithmetic operations in JavaScript are inherently typed e.g. \u003ccode\u003ea|0\u003c/code\u003e always returns 32-bit integer and \u003ccode\u003e+a\u003c/code\u003e always returns a number, but most other operations have no such guarantees. This turns writing an ahead-of-time optimizing compiler for JavaScript into an extremely difficult problem. Instead of compiling JavaScript once in an AOT fashion, most JavaScript VMs sport several execution tiers. For example in V8 code starts to execute without any optimizations, compiled with a baseline non-optimizing compiler. Hot functions are later recompiled by an optimizing compiler.[asm.js uses this inherent typing to define an extremely restricted subset of JavaScript that is completely statically typed and can be optimized ahead-of-time, removing the need for speculative adaptive compilation]\u003c/p\u003e\n\u003cp\u003eWaiting for code to warm up serves two distinct purposes:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eit decreases startup latency: optimizing compiler is slower than non-optimizing, which means optimized code should be used enough for optimizations to pay off;\u003c/li\u003e\n\u003cli\u003eit gives inline caches a chance to collect \u003cem\u003etype feedback\u003c/em\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAs it was already stressed above human written JavaScript usually does not contain enough inherent type information to allow full static typing and AOT compilation. JIT has to speculate: it has to make \u003cem\u003eeducated\u003c/em\u003e guesses about the usage and behavior of the code it optimizes and generate specialized code that is valid under certain assumptions. In other words compiler needs to guess what kind of objects are seen in a particular place in the function it optimizes. By a lucky coincidence that’s precisely the information inline caches collect!\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMonomorphic cache says “I’ve \u003cstrong\u003eonly\u003c/strong\u003e seen type A”;\u003c/li\u003e\n\u003cli\u003ePolymorphic cache of degree N says “I’ve \u003cstrong\u003eonly\u003c/strong\u003e seen A\u003csub\u003e1\u003c/sub\u003e, …, A\u003csub\u003eN\u003c/sub\u003e”;\u003c/li\u003e\n\u003cli\u003eMegamorphic cache says “I’ve seen a lot of things.”;\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/images/2015-01-11/opt-0.png\"\u003e\u003c/p\u003e\n\u003cp\u003eOptimizing compiler looks at the information collected by inline caches and builds \u003cem\u003eintermediate representation\u003c/em\u003e (IR) accordingly. IR instructions are usually more specific and low level than generic JS operations. For example if IC for \u003ccode\u003e.x\u003c/code\u003e saw only objects of shape \u003ccode\u003e{x, y}\u003c/code\u003e then optimizer can take an IR instruction that loads property from a fixed offset inside an object and use it to load \u003ccode\u003e.x\u003c/code\u003e. Of course it is unsafe to apply such instruction to arbitrary objects so optimizer prepends a \u003cem\u003etype guard\u003c/em\u003e before it. Type guard checks the shape of the object before it reaches specialized operation and if it does not match an expected shape the execution of the optimized code \u003cstrong\u003ecan not\u003c/strong\u003e continue - instead we have to jump into the unoptimized code and continue execution there. This process is called \u003cem\u003edeoptimization\u003c/em\u003e. Deoptimization reasons however are not limited to type guard violations: arithmetic operation can be specialized for 32bit integers and will deoptimize if result overflows this representation, an indexed property load \u003ccode\u003earr[idx]\u003c/code\u003e can be specialized for a inbounds access and will deoptimize if \u003ccode\u003eidx\u003c/code\u003e is out of bounds or \u003ccode\u003earr\u003c/code\u003e has no property \u003ccode\u003eidx\u003c/code\u003e (it’s a \u003cem\u003ehole\u003c/em\u003e), etc.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2015-01-11/opt-deopts.png\"\u003e\u003c/p\u003e\n\u003cp\u003eIt should now become clear that the process of optimization tries to address two previously outlined weaknesses:\u003c/p\u003e\n\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd\u003e\u003cstrong\u003eunoptimized\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eoptimized\u003c/strong\u003e\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003eeach operation has arbitrary unknown side effects because it is generic and implements full semantics\u003c/td\u003e\u003ctd\u003ecode specializations limit or eliminate unpredictability, side-effects are well defined (e.g. load of property by offset has no side-effects)\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003eeach operation is on its own, learns individually and does not exchange information with neighbors\u003c/td\u003e\u003ctd\u003eoperations are decomposed into lower level IR instructions which are then optimized together, this allows to discover and eliminate redundancies between them\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003e\u003cimg src=\"/images/2015-01-11/opt-se.png\"\u003e\u003c/p\u003e\n\u003cp\u003eIndeed building specialized IR based on the type feedback is just the first step in the optimization pipeline. Once IR is ready compiler will run multiple passes over it trying to discover invariants and eliminate redundancies. Analyses that are run at this stage usually are \u003cem\u003eintraprocedural\u003c/em\u003e and compiler is forced to assume the worst arbitrary side-effects every time it encounters a call. Here it is important to realize that generic unspecialized operations are essentially \u003cem\u003ecalls\u003c/em\u003e themselves: e.g. \u003ccode\u003e+\u003c/code\u003e evaluation can call \u003ccode\u003evalueOf\u003c/code\u003e and a property access \u003ccode\u003eo.x\u003c/code\u003e can easily result in a getter invocation. This means any operation which optimizer for some reason failed to specialize completely might become a stumbling block for subsequent optimization passes.\u003c/p\u003e\n\u003cp\u003eOne very common case of redundancy are repeated type guards that check the same value against the same shape. Here is how initial IR for function \u003ccode\u003eg\u003c/code\u003e (see above) could have looked like:\u003c/p\u003e\n\u003ctable style=\"border-spacing: 0px; border-collapse: collapse;\"\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eCheckMap\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev0\u003c/span\u003e, {x,y}  \u003cspan class=\"c1\"\u003e;; shape check\u003c/span\u003e \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003cspan class=\"ir-ref\"\u003ev1\u003c/span\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eLoad\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev0\u003c/span\u003e, @\u003cspan class=\"mi\"\u003e12\u003c/span\u003e        \u003cspan class=\"c1\"\u003e;; load o.x\u003c/span\u003e \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eCheckMap\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev0\u003c/span\u003e, {x,y} \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003cspan class=\"ir-ref\"\u003ev2\u003c/span\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eLoad\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev0\u003c/span\u003e, @\u003cspan class=\"mi\"\u003e12\u003c/span\u003e        \u003cspan class=\"c1\"\u003e;; load o.x\u003c/span\u003e \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003cspan class=\"ir-ref\"\u003ei3\u003c/span\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eMul\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev1\u003c/span\u003e, \u003cspan class=\"ir-ref\"\u003ev2\u003c/span\u003e          \u003cspan class=\"c1\"\u003e;; o.x * o.x\u003c/span\u003e \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eCheckMap\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev0\u003c/span\u003e, {x,y} \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003cspan class=\"ir-ref\"\u003ev4\u003c/span\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eLoad\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev0\u003c/span\u003e, @\u003cspan class=\"mi\"\u003e16\u003c/span\u003e        \u003cspan class=\"c1\"\u003e;; load o.y\u003c/span\u003e \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eCheckMap\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev0\u003c/span\u003e, {x,y} \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003cspan class=\"ir-ref\"\u003ev5\u003c/span\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eLoad\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev0\u003c/span\u003e, @\u003cspan class=\"mi\"\u003e16\u003c/span\u003e        \u003cspan class=\"c1\"\u003e;; load o.y\u003c/span\u003e \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003cspan class=\"ir-ref\"\u003ei6\u003c/span\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eMul\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev4\u003c/span\u003e, \u003cspan class=\"ir-ref\"\u003ev5\u003c/span\u003e          \u003cspan class=\"c1\"\u003e;; o.y * o.y\u003c/span\u003e \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003cspan class=\"ir-ref\"\u003ei7\u003c/span\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eAdd\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ei3\u003c/span\u003e, \u003cspan class=\"ir-ref\"\u003ei6\u003c/span\u003e          \u003cspan class=\"c1\"\u003e;; o.x * o.x + o.y * o.y\u003c/span\u003e \u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003eThis IR checks \u003ccode\u003ev0\u003c/code\u003e against the same shape 4 times even though there is nothing between checks that could affect the \u003ccode\u003ev0\u003c/code\u003e’s shape. Attentive reader will also spot that loads \u003ccode\u003ev2\u003c/code\u003e and \u003ccode\u003ev5\u003c/code\u003e are redundant too, as nothing is writing into corresponding properties. Fortunately the \u003ca href=\"https://en.wikipedia.org/wiki/Global_value_numbering\"\u003eGVN\u003c/a\u003e pass that is later applied to the IR will eliminate redundant checks and loads:\u003c/p\u003e\n\u003ctable style=\"border-spacing: 0px; border-collapse: collapse;\"\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e;; After GVN\u003c/span\u003e \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eCheckMap\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev0\u003c/span\u003e, {x,y} \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003cspan class=\"ir-ref\"\u003ev1\u003c/span\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eLoad\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev0\u003c/span\u003e, @\u003cspan class=\"mi\"\u003e12\u003c/span\u003e \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003cspan class=\"ir-ref\"\u003ei3\u003c/span\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eMul\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev1\u003c/span\u003e, \u003cspan class=\"ir-ref\"\u003ev1\u003c/span\u003e \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003cspan class=\"ir-ref\"\u003ev4\u003c/span\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eLoad\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev0\u003c/span\u003e, @\u003cspan class=\"mi\"\u003e16\u003c/span\u003e \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003cspan class=\"ir-ref\"\u003ei6\u003c/span\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eMul\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ev4\u003c/span\u003e, \u003cspan class=\"ir-ref\"\u003ev4\u003c/span\u003e \u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd style=\"border-right: 1px solid rgb(204, 204, 204); --darkreader-inline-border-right:#646562;\" data-darkreader-inline-border-right=\"\"\u003e\u003cspan class=\"ir-ref\"\u003ei7\u003c/span\u003e\u003c/td\u003e\u003ctd class=\"\"\u003e\u003cspan class=\"boldy\"\u003eAdd\u003c/span\u003e \u003cspan class=\"ir-ref\"\u003ei3\u003c/span\u003e, \u003cspan class=\"ir-ref\"\u003ei6\u003c/span\u003e \u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003eHowever as noted above such elimination is only possible because there are no interfering side effects between redundant operations: if there were a call between \u003ccode\u003ev1\u003c/code\u003e and \u003ccode\u003ev2\u003c/code\u003e we would have to conservatively assume that callee might potentially have access to \u003ccode\u003ev0\u003c/code\u003e and thus can add, remove and change properties - this would make impossible to eliminate access \u003ccode\u003ev2\u003c/code\u003e or \u003ccode\u003eCheckMap\u003c/code\u003e that guards it.\u003c/p\u003e\n\u003cp\u003eNow that we have a basic understanding of optimizing compiler and know what it likes (specialized ops) and dislikes (calls and generic ops) there is only one thing left to discuss: handling of non-monomorphic operations by the optimizing compiler.\u003c/p\u003e\n\u003cp\u003eIf operation is non-monomorphic optimizing compiler obviously can’t use that simple specialization rule \u003ccode\u003etype-guard + specialized-op\u003c/code\u003e we were discussing before. It simply will not be able to select a single type for a type guard and single specialized operation. IC tells the compiler that this operation sees values of different types/shapes thus picking a single one of them and ignoring the rest means risking deoptimization, which is highly undesirable. Instead optimizing compiler will usually try to build a \u003cem\u003edecision tree\u003c/em\u003e. For example a polymorphic property access \u003ccode\u003eo.x\u003c/code\u003e that saw shapes \u003ccode\u003eA\u003c/code\u003e, \u003ccode\u003eB\u003c/code\u003e, \u003ccode\u003eC\u003c/code\u003e will be expanded into something like this (note this is pseudocode - optimizing compiler would build a CFG structure instead):\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e o_x\n\u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003e$GetShape\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token constant\"\u003eA\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  o_x \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003e$LoadByOffset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e offset_A_x\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eelse\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003e$GetShape\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token constant\"\u003eB\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  o_x \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003e$LoadByOffset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e offset_B_x\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eelse\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003e$GetShape\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token constant\"\u003eC\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  o_x \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003e$LoadByOffset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e offset_C_x\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// o.x saw only A, B, C so we assume\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// there can be *nothing* else\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003e$Deoptimize\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// Note: at this point we can only say that\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// o is either A, B or C. But we lost information\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// which one.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOne thing to notice here is that polymorphic accesses lack useful property that monomorphic accesses have. After specialized monomorphic access and until an interfering side-effect we can guarantee that object has a certain shape. This allows to eliminate redundancy between monomorphic accesses. Polymorphic accesses give a very weak guarantee “object’s shape is one of A, B, C”. We can’t use this information to eliminate much redundancy between two similar polymorphic accesses that follow each other (at most we could use it to eliminate the last comparison and deoptimization block - but V8 does not try to do this).\u003c/p\u003e\n\u003cp\u003eV8 however does build a more efficient IR if property is located in the same place in \u003cem\u003eall\u003c/em\u003e shapes. In this case a polymorphic type guard will be emitted instead of the decision tree:\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token comment\"\u003e// Check that o's shape is one of A, B or C - deoptimize otherwise.\u003c/span\u003e\n\u003cspan class=\"token function\"\u003e$TypeGuard\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token constant\"\u003eA\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token constant\"\u003eB\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token constant\"\u003eC\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// Load property. It's in the same place in A, B and C.\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e o_x \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003e$LoadByOffset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e offset_x\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis IR has one important benefit for redundancy elimination: if there are no interfering side effects between two \u003ccode\u003e$TypeGuard(o, [A, B, C])\u003c/code\u003e instructions then the second one is redundant just like in the monomorphic case.\u003c/p\u003e\n\u003cp\u003eIf type feedback tells optimizing compiler that property access saw more different shapes than optimizing compiler considers feasible to handle inline then optimizer will instead build a slightly different decision tree that ends with a generic operation instead of deoptimization:\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e o_x\n\u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003e$GetShape\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token constant\"\u003eA\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  o_x \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003e$LoadByOffset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e offset_A_x\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eelse\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003e$GetShape\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token constant\"\u003eB\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  o_x \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003e$LoadByOffset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e offset_B_x\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eelse\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003e$GetShape\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token constant\"\u003eC\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  o_x \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003e$LoadByOffset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e offset_C_x\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// We know that o.x is too polymorphic (megamorphic).\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// to avoid deoptimizations leave escape hatch to handle\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// arbitrary object:\u003c/span\u003e\n  o_x \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003e$LoadPropertyGeneric\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eo\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"x\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e//    ^^^^^^^^^^^^^^^^^^^^ arbitrary side effects\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// Note: at this point nothing is known about\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// o's shape and furthermore arbitrary\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// side-effects could have happened.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFinally in some cases optimizing compiler can completely give up on specializing operations:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eif it does not know how to efficiently specialize it;\u003c/li\u003e\n\u003cli\u003eoperation is polymorphic and optimizer does not know how to build a decision tree correctly for this operation (e.g. used to be the case for polymorphic keyed accesses \u003ccode\u003earr[i]\u003c/code\u003e in V8 - but not anymore);\u003c/li\u003e\n\u003cli\u003eoperation does not have any actionable type feedback to specialize upon (operation were never executed, GC cleared collected type feedback, etc).\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eIn all such (arguably rare) cases the optimizer just emits a generic variant of the operation in the IR.\u003c/p\u003e\n\u003ch3 id=\"performance-implications-1\"\u003ePerformance implications\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#performance-implications-1\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eLets summarize what we learned:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003emonomorphic operations are easiest to specialize, give optimizer most actionable information and enable further optimizations. Hulk-style summary \u003cstrong\u003eONE TYPE CLOSE TO METAL\u003c/strong\u003e!\u003c/li\u003e\n\u003cli\u003emoderately polymorphic operations which require a polymorphic type guard or in the worst case a decision tree are slower then monomorphic ones.\n\u003cul\u003e\n\u003cli\u003eDecision trees complicate control flow and make it harder for optimizer to propagate types and eliminate redundancies. Memory dependent conditional jumps that constitute those decision trees might be bad news if polymorphic operation is right in the middle of the tight number crunching loop;\u003c/li\u003e\n\u003cli\u003ePolymorphic type guards don’t obstruct type flow that much and still allow for some redundancy elimination - but each polymorphic type guard is still somewhat slower than monomorphic type guard (that checks against one shape). Performance penalty for a polymorphic type guard depends on how well CPU handles conditional branches;\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003ehighly polymorphic/megamorphic operations are not specialized entirely and result in a generic operation being emitted as part of the optimized IR. This generic operation is a call - with all associated bad consequences for both optimizations and raw CPU performance.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eTake a look at \u003ca href=\"https://jsperf.com/monomorphism-vs-polymorphism/11\"\u003ethis microbenchmark\u003c/a\u003e trying to capture the difference between all these cases for a property access: monomorphic, polymorphic with matching property offsets (requires polymorphic type guard), polymorphic with different property offsets (requires decision tree), megamorphic.\u003c/p\u003e\n\u003ch1 id=\"undiscussed\"\u003eUndiscussed\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#undiscussed\"\u003e\u003c/a\u003e\u003c/h1\u003e\n\u003cp\u003eI have intentionally ignored some implementation details when writing this post to avoid making it too broad in scope.\u003c/p\u003e\n\u003ch3 id=\"shapes\"\u003eShapes\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#shapes\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eWe did not discuss at all how shapes (aka hidden classes) are represented, computed and attached to objects. Check out my \u003ca href=\"https://mrale.ph/blog/2012/06/03/explaining-js-vms-in-js-inline-caches.html\"\u003epost on inline caches\u003c/a\u003e, some of my talks e.g. \u003ca href=\"https://mrale.ph/talks/awp2014/#/26\"\u003eAWP2014\u003c/a\u003e one to get the basic idea.\u003c/p\u003e\n\u003cp\u003eOne important thing to realize here that the notion of \u003cem\u003eshape\u003c/em\u003e in JavaScript VMs is a heuristical approximation. It’s an attempt to dynamically approximate static structure hidden in the program. Things that are shaped the same for a human might not necessary have the same shape for the VM:\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token constant\"\u003eA\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ex\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token constant\"\u003eB\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ex\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eA\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  b \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eB\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  c \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  d \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e x\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e y\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003edelete\u003c/span\u003e d\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ey\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// a, b, c, d all have DIFFERENT SHAPES for V8\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFluffy dictionary nature of JavaScript objects also makes it easy to create \u003cem\u003eaccidental\u003c/em\u003e polymorphism:\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token constant\"\u003eA\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ex\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eA\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  b \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eA\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// same shape\u003c/span\u003e\n\n\u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esomething\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  a\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ey\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// shape of a no longer matches b.\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"intentional-polymorphism\"\u003eIntentional polymorphism\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#intentional-polymorphism\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eEven if you are programming a language that only allows you to instantiate fixed shape objects (Java, C#, Dart, C++, etc) from rigid classes you can still write polymorphic code:\u003c/p\u003e\n\u003cpre class=\"language-java\"\u003e\u003ccode class=\"language-java\"\u003e\u003cspan class=\"token keyword\"\u003einterface\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBase\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003edoX\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eA\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eimplements\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBase\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003edoX\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eB\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eimplements\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eBase\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003edoX\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003ehandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name\"\u003eBase\u003c/span\u003e obj\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  obj\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efoo\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003ehandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eA\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token function\"\u003ehandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eB\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// obj.foo() callsite is polymorphic\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBeing able to write code against the \u003cem\u003einterface\u003c/em\u003e and have this code process objects of different \u003cem\u003eimplementation\u003c/em\u003e is an important abstraction mechanism. Polymorphism in statically typed programming languages has similar performance implications to the ones discussed above.[unsurprisingly JVMs use inline caches to optimize \u003ccode\u003einvokeinterface\u003c/code\u003e and \u003ccode\u003einvokevirtual\u003c/code\u003e calls]\u003c/p\u003e\n\u003ch3 id=\"not-all-caches-are-the-same\"\u003eNot all caches are the same\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#not-all-caches-are-the-same\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eIt might be good to keep in mind that some caches are not shape based and/or have lower \u003cem\u003ecapacity\u003c/em\u003e than others. For example cache associated with a function invocation is either uninitialized, monomorphic or megamorphic with no intermediate polymorphic state. Instead of caching function’s shape which is irrelevant for an invocation it caches \u003cem\u003einvocation target\u003c/em\u003e - that is function itself.\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003einv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ecb\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003ecb\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token constant\"\u003eF\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ev\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e v\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token constant\"\u003eG\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ev\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e v \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003einv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token constant\"\u003eF\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// inline cache is monomorpic, points to F\u003c/span\u003e\n\u003cspan class=\"token function\"\u003einv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token constant\"\u003eG\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// inline cache is megamorphic\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIf \u003ccode\u003einv\u003c/code\u003e is optimized when inline cache for \u003ccode\u003ecb(...)\u003c/code\u003e invocation is monomorphic then optimizing compiler can potentially inline this call (which is very important for small functions on hot paths). When this cache is megamorphic optimizer will not be able to inline anything (it does not know \u003cem\u003ewhat\u003c/em\u003e - as there is no single target) and will just leave a generic invocation operation in the IR.\u003c/p\u003e\n\u003cp\u003eThis comes in contrast with method invocation expressions \u003ccode\u003eo.m(...)\u003c/code\u003e that are handled similarly to property accesses. ICs at method invocation sites have intermediate polymorphic state between monomorphic and megamorphic state. V8 is capable of inlining at monomorphic, polymorphic and megamorphic sites and it builds IR in the same way as for properties: choosing between a decision tree or a single polymorphic type guard before inlined function body. There is one limitation however: for V8 to be able to inline method call it needs \u003cem\u003eit to be part of the shape\u003c/em\u003e.[in fact \u003ccode\u003eo.m(...)\u003c/code\u003e compiles into two ICs: one \u003ccode\u003eLoadIC\u003c/code\u003e that does property load and another \u003ccode\u003eCallIC\u003c/code\u003e that invokes loaded property with appropriate receiver and arguments. \u003ccode\u003eCallIC\u003c/code\u003e is the same kind of IC that is described above for \u003ccode\u003ecb(...)\u003c/code\u003e-like calls. It is only capable of recording monomorphic only megamorphic state. That's why its state is ignored when optimizing method call and only state of the property load IC is used]\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003einv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eo\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e o\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecb\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e f \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token function-variable function\"\u003ecb\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token constant\"\u003eF\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ev\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e v\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e g \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token function-variable function\"\u003ecb\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token constant\"\u003eG\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ev\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e v \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003einv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ef\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token function\"\u003einv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ef\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// here inline cache is monomorpic, have seen only objects with\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// a shape like f.\u003c/span\u003e\n\u003cspan class=\"token function\"\u003einv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eg\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// here inline cache is polymorphic, seen objects with two different\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// shapes: like f and like g\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIt might be surprising that \u003ccode\u003ef\u003c/code\u003e and \u003ccode\u003eg\u003c/code\u003e have different shapes above. This happens because when we assign a function to a property V8 tries (if possible) to attach it to object’s shape instead of saving it directly on the object. In this example \u003ccode\u003ef\u003c/code\u003e has a shape like this \u003ccode\u003e{cb: F}\u003c/code\u003e i.e. the shape itself is pointing directly to the closure. In our previous examples we only had shapes that simply declared the presence of the property at a certain offset, however this shape also captures the value of the property. This makes V8’s shapes similar to classes in an language like Java or C++ where class is essentially a set of fields \u003cem\u003eand methods\u003c/em\u003e.\u003c/p\u003e\n\u003cp\u003eOf course if you later overwrite functional property with a different function V8 decides that this doesn’t look like a class-method relationship and switches to a shape that reflects this:\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e f \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token function-variable function\"\u003ecb\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token constant\"\u003eF\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ev\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e v\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Shape of f is {cb: F}\u003c/span\u003e\n\nf\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method-variable function-variable method function property-access\"\u003ecb\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token constant\"\u003eH\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ev\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e v \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// Shape of f is {cb: *}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOverall the topic of how V8 builds and maintains shapes (hidden classes) is worthy of a large separate post by itself.\u003c/p\u003e\n\u003ch3 id=\"representing-path-to-the-property\"\u003eRepresenting \u003cem\u003epath-to-the-property\u003c/em\u003e\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#representing-path-to-the-property\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eAt this point it might seem that IC associated with property \u003ccode\u003eo.x\u003c/code\u003e is simply a dictionary mapping shapes to property offsets, something like \u003ccode\u003eDictionary\u0026#x3C;Shape, int\u003e\u003c/code\u003e. However this representation is way too narrow to be useful: property can reside on one of the objects within the prototype chain or be an \u003cem\u003eaccessor property\u003c/em\u003e (one with a getter and/or a setter). An interesting observation to make here is that accessor properties are in the certain sense more generic than normal data properties.\u003c/p\u003e\n\u003cp\u003eFor example \u003ccode\u003eo = {x: 1}\u003c/code\u003e can be perceived as an object with an accessor property \u003ccode\u003ex\u003c/code\u003e that has a getter/setter accessing a hidden internal slot using VM intrinsics:[Dart VM implements fields access in this way]\u003c/p\u003e\n\u003cpre class=\"language-javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token comment\"\u003e// pseudo-code reimagining o = { x: 1 }\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e o \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eget\u003c/span\u003e \u003cspan class=\"token function\"\u003ex\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token function\"\u003e$LoadByOffset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e offset_of_x\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eset\u003c/span\u003e \u003cspan class=\"token function\"\u003ex\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003evalue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003e$StoreByOffset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e offset_of_x\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e value\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// both getter and setter are generated internally by VM\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// and are invisible to normal JS code.\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token function\"\u003e$StoreByOffset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e offset_of_x\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn the light of this observation it becomes clear that IC should be more akin to \u003ccode\u003eDictionary\u0026#x3C;Shape, Function\u003e\u003c/code\u003e: mapping shapes to accessor functions that should be executed IC is hit. Such IC representation would allow to optimize cases that were impossible to cover with a simplistic representation from the above (properties on the prototype chain, accessor properties and even ES6 proxy objects).[in reality V8's ICs are patchable callsites that call special runtime generated IC stubs, see \u003ca href=\"https://mrale.ph/blog/2012/06/03/explaining-js-vms-in-js-inline-caches.html\"\u003ethis post\u003c/a\u003e for more accurate analogy]\u003c/p\u003e\n\u003ch3 id=\"premonomorphic-state\"\u003ePremonomorphic state\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#premonomorphic-state\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eSome ICs in V8 actually have so called \u003cem\u003epremonomorphic\u003c/em\u003e state between \u003cem\u003eunitialized\u003c/em\u003e and \u003cem\u003emonomorphic\u003c/em\u003e. It exists to avoid compiling IC stubs for ICs that are only executed once. I decided to avoid discussing this state because it is a somewhat obscure implementation detail.\u003c/p\u003e\n\u003ch1 id=\"final-performance-advice\"\u003eFinal performance advice\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#final-performance-advice\"\u003e\u003c/a\u003e\u003c/h1\u003e\n\u003cp\u003eThe best performance advice is hidden in the title of Dale Carnegie’s book “How to Stop Worrying and Start Living”.\u003c/p\u003e\n\u003cp\u003eIndeed worrying about polymorphism is usually futile. Instead benchmark your code on a realistic dataset, profile it for hotspots and if any of them are JS related - check out IR that optimizing compiler produces.\u003c/p\u003e\n\u003cp\u003eIf in the middle of your tight number crunching loop you see IR instruction called \u003ccode\u003eXYZGeneric\u003c/code\u003e or anything marked with red \u003ccode\u003echanges[*]\u003c/code\u003e (aka “changes everything”) marker - then (only then!) it might be the right time to start worrying.\u003c/p\u003e\n\u003ch1 id=\"the-end\"\u003eTHE END\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#the-end\"\u003e\u003c/a\u003e\u003c/h1\u003e","noteIndex":{"id":"Iy0MoL0KnL55Br3AfTS2C","title":"Luke","desc":"","updated":1766965759366,"created":1644449449778,"custom":{"nav_order":0,"permalink":"/"},"fname":"root","type":"note","vault":{"fsPath":"vault"},"contentHash":"a724de3efd251cf89fe82a5860d9008b","links":[{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"life-tips","position":{"start":{"line":43,"column":5,"offset":2710},"end":{"line":43,"column":29,"offset":2734},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"life-tips","anchorHeader":"wodenokoto"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"read.2026.articles","alias":"What I read in 2026","position":{"start":{"line":72,"column":3,"offset":4440},"end":{"line":72,"column":45,"offset":4482},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"read.2026.articles"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"read.2025.articles","alias":"2025","position":{"start":{"line":73,"column":5,"offset":4487},"end":{"line":73,"column":32,"offset":4514},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"read.2025.articles"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"read.2024.articles","alias":"2024","position":{"start":{"line":74,"column":5,"offset":4519},"end":{"line":74,"column":32,"offset":4546},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"read.2024.articles"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"read.2023.articles","alias":"2023","position":{"start":{"line":75,"column":5,"offset":4551},"end":{"line":75,"column":32,"offset":4578},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"read.2023.articles"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"read.2022.articles","alias":"2022","position":{"start":{"line":76,"column":5,"offset":4583},"end":{"line":76,"column":32,"offset":4610},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"read.2022.articles"}},{"type":"wiki","from":{"fname":"root","id":"Iy0MoL0KnL55Br3AfTS2C","vaultName":"vault"},"value":"journal.what-i-struggled-brag-in","position":{"start":{"line":82,"column":3,"offset":4746},"end":{"line":82,"column":39,"offset":4782},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"journal.what-i-struggled-brag-in"}}],"anchors":{"what-i-read-in-past":{"type":"header","text":"What I read in past","value":"what-i-read-in-past","line":76,"column":0,"depth":2}},"children":["zd4mq442jike0pr0wba1u3m","6hzeqsofq67gdk88flxlkhp","778ijii93yu5uwnrwmn5zi4","g1fngdjl25nes6fs3lip602","ZbdkdApFqLdks4Moq92R9","uoc5hhki3o4py15cesddu8q","9qf7j06jtdkm6rnx9ymvwb0","5zn10cvj7ajy2gh2is5nqmg","4qo9ma0z0yu1czns6pxl7y5","ok0e729ho7o09xetujkxc0m","GR5x8HnNFEN6fU2UBSEIK","yirtnlj8q24yutcf3ss1xqy","eq0wc6t7wl2wv221yb68ro4","7x2fnv4j6gxts08qk0jguny","ettkt3iClONnxpbGwBVLl","7l4knev6v613tbuoskvmbdg","hvh5bud6yp7dc89tuh95tr9","4fvoqrplw0cweo554usbjos","f8qsfql0a9v8thpeo82udfa","1swsbrhqi9jk41v9eodyi5q","SQqYupi6EFddTerBA8RRD","hjNeNc1F2JUh0lTWanH4h","qf0l4wbrc9jgooyzexmbq5v","o7xruzrah5wzqetottecss7","z1zo2mp6ddji5p317i4x9xw","v06c2tjelh341x4resa50fh","0yqesk4rcffwgyuab5x8rfa","sy2vkbtyu671chkvgn1yt8j","ufixpmxoydiccoh59kphrib","alswadkx4wb05y1z9iwfzfv","1daut9dpw70xd0zh5a7j5p4"],"parent":null,"data":{},"body":"\nHi there 👋. I'm a Front-end developer.\n\n---\n\n- 현실은 인간의 연산으로 완전히 파악할 수 없는 복잡계. 주어진 상황과 능력으로 할 수 있는 최선의 적응은 단순함과 꾸준함.\n\n  - 파산을 면하는 선에서 여러가지를 해보고 자신에게 맞는 걸 위주로 꾸준히. 그를 위해 단순, 편안, 쾌적함이 필요.\n\n- 🥱 -\u003e 🤔💡🌱 - [On The Death of Daydreaming](https://www.afterbabel.com/p/on-the-death-of-daydreaming)\n  - boredom -\u003e easy fun -\u003e art -\u003e profit?\n\n\u003e I've often described my motivation for building software to others using imagery: I like to go find a secluded beach, build a large, magnificent sand castle, and then walk away. Will anyone notice? Probably not. Will the waves eventually destroy it? Yep. Did I still get immense satisfaction? Absolutely. - [aliasxneo](https://news.ycombinator.com/item?id=41497113)\n\n\u003e We love to see the process, not just the result. The imperfections in your work can be beautiful if they show your struggle for perfection, not a lack of care. - [ralphammer](https://ralphammer.com/is-perfection-boring/)\n\n\u003e Simplicity, even if it sacrifices some ideal functionality has better survival characteristics than the-right-thing. - [The Rise of Worse is Better](https://www.dreamsongs.com/RiseOfWorseIsBetter.html)\n\n\u003e [Roberto Blake was talking about making 100 crappy videos](https://www.youtube.com/watch?v=OnUBaQ1Sp_E) to get better over time. Putting in the reps and improving a little bit each time.\n\u003e\n\u003e Putting in the work without expecting any external reward at first (eg views, followers, likes, etc) will pay off in the long run. - [100 Scrappy Things](https://www.florin-pop.com/blog/100-scrappy-things/)\n\n\u003e Make the difficult habitual, the habitual easy, and the easy beautiful. - [Constantin S. Stanislavski](https://www.goodreads.com/quotes/7102271-make-the-difficult-habitual-the-habitual-easy-and-the-easy)\n\n\u003e A good match is a **structured** dance, where players aim to **score** while they are following well-defined **rules**. This **freedom within a structure** is what makes it fun. - [ralphammer](https://ralphammer.com/how-to-get-started/)\n\n- [Pivot Points](https://longform.asmartbear.com/pivot-points/)\n\n  - non-judgmental aspects of personality that can be strengths in some contexts and weaknesses in others\n  - Pivot Points are fixed in the short term\n\n- [Hedged Bets](https://longform.asmartbear.com/predict-the-future/#hedged-bets)\n  - trading slightly less maximum upside for predictable, net-positive outcomes.\n\n\u003e “Motivation often comes after starting, not before. Action produces momentum.”\n\u003e [When you start a new habit, it should take less than two minutes to do.](https://jamesclear.com/how-to-stop-procrastinating)\n\u003e\n\u003e - James Clear\n\n\u003e Focus is more about **not** keeping busy when you need to wait for something.  \n\u003e Eat the boredom for a minute.\n\u003e\n\u003e - [[life-tips#wodenokoto]]\n\n\u003e [4 minutes run hard enough to push heart rate to 90%, 3 minutes recover, repeat 4 times](https://news.ycombinator.com/item?id=34213181)\n\u003e\n\u003e - https://www.ntnu.edu/cerg/advice\n\u003e - [Get running with Couch to 5K](https://www.nhs.uk/live-well/exercise/running-and-aerobic-exercises/get-running-with-couch-to-5k/)\n\n\u003e [recommended routine - bodyweightfitness](https://www.reddit.com/r/bodyweightfitness/wiki/kb/recommended_routine/) - I Don't Have This Much Time!\n\u003e\n\u003e - Don't workout at all (saves anywhere from 20 to 60 minutes, but really, really, really, really, really, really, really, really, really not recommended)\n\n\u003e 도무지 읽히지 않는 책 앞에서 내가 택한 방법은 펼쳐진 페이지 앞에서 멍때리기이다. 다르게 표현하면 이렇다. 펼쳐진 두 페이지 앞에서 오래 머물기.\n\u003e\n\u003e 책을 펼쳐놓는 것으로 충분하다. 읽지 못해도 좋다. 매일 정해진 진도를 나가야 하는 학교 수업이 아니니까. 하지만 읽지 않아도 괜찮다고 해서 펼쳐두지조차 않으면 곤란하다. 가능한 한 자주 책을 펼쳐두도록 하자. 전혀 읽지 않고 멍하니 바라보고 있다가 다시 덮게 되더라도\n\u003e\n\u003e - 막막한 독서. 시로군. P.10~13\n\n\u003e I think it should be everyone's primary focus to sleep well, drink water, get outside, get active, and eat generally decently. I hate to say it, but if you're not eating a good amount of vegetables and fruit, decent protein, sleep, etc, no amount of XYZ will catch up to that detriment. - [CE02](https://news.ycombinator.com/item?id=35056071)\n\n\u003e My real battle is doing good versus doing nothing. - [Deirdre Sullivan](https://www.npr.org/2005/08/08/4785079/always-go-to-the-funeral)\n\n[Kind Engineering](https://kind.engineering/) - How To Engineer Kindness\n\n\u003e Sometimes magic is just someone spending more time on something than anyone else might reasonably expect. - [Teller](https://www.goodreads.com/quotes/6641527-sometimes-magic-is-just-someone-spending-more-time-on-something)\n\n---\n\n## What I read in past\n\n- [[What I read in 2026|read.2026.articles]]\n  - [[2025|read.2025.articles]]\n  - [[2024|read.2024.articles]]\n  - [[2023|read.2023.articles]]\n  - [[2022|read.2022.articles]]\n- 📝 [Gists](https://gist.github.com/Luke-SNAW)\n- 📜 [Journals](https://luke-snaw.github.io/Luke-SNAW__netlify-CMS.github.io/)\n\n---\n\n- [[journal.what-i-struggled-brag-in]]\n"},"collectionChildren":null,"customHeadContent":null,"config":{"version":5,"dev":{"enablePreviewV2":true},"commands":{"lookup":{"note":{"selectionMode":"extract","confirmVaultOnCreate":true,"vaultSelectionModeOnCreate":"smart","leaveTrace":false,"bubbleUpCreateNew":true,"fuzzThreshold":0.2}},"randomNote":{},"insertNoteLink":{"aliasMode":"none","enableMultiSelect":false},"insertNoteIndex":{"enableMarker":false},"copyNoteLink":{"aliasMode":"title"},"templateHierarchy":"template"},"workspace":{"vaults":[{"fsPath":"vault"}],"journal":{"dailyDomain":"daily","name":"journal","dateFormat":"y.MM.dd","addBehavior":"childOfDomain"},"scratch":{"name":"scratch","dateFormat":"y.MM.dd.HHmmss","addBehavior":"asOwnDomain"},"task":{"name":"","dateFormat":"","addBehavior":"childOfCurrent","statusSymbols":{"":" ","wip":"w","done":"x","assigned":"a","moved":"m","blocked":"b","delegated":"l","dropped":"d","pending":"y"},"prioritySymbols":{"H":"high","M":"medium","L":"low"},"todoIntegration":false,"createTaskSelectionType":"selection2link","taskCompleteStatus":["done","x"]},"graph":{"zoomSpeed":1,"createStub":false},"enableAutoCreateOnDefinition":false,"enableXVaultWikiLink":false,"enableRemoteVaultInit":true,"enableUserTags":false,"enableHashTags":true,"workspaceVaultSyncMode":"noCommit","enableAutoFoldFrontmatter":false,"enableEditorDecorations":true,"maxPreviewsCached":10,"maxNoteLength":204800,"dendronVersion":"0.115.0","enableFullHierarchyNoteTitle":false,"enablePersistentHistory":false},"preview":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enablePrettyRefs":true,"enableKatex":true,"automaticallyShowPreview":false,"enableFrontmatterTags":true,"enableHashesForFMTags":false},"publishing":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enablePrettyRefs":true,"enableKatex":true,"copyAssets":true,"siteHierarchies":["root"],"writeStubs":false,"siteRootDir":"docs","seo":{"title":"Luke SNAW","description":"Personal knowledge space"},"github":{"enableEditLink":false,"editLinkText":"Edit this page on GitHub","editBranch":"main","editViewMode":"tree"},"enableSiteLastModified":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableRandomlyColoredTags":true,"enableTaskNotes":true,"enablePrettyLinks":true,"searchMode":"lookup","siteUrl":"https://luke-snaw.github.io/","duplicateNoteBehavior":{"action":"useVault","payload":["vault"]},"siteFaviconPath":"favicon.ico","siteIndex":"root"}}},"__N_SSG":true},"page":"/notes/[id]","query":{"id":"l6abcjmsuol9bri9885t1kf"},"buildId":"wirstT2ztC8OQsbzKjhvw","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>